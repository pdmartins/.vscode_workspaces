---
name: agent-chat-save
description: Salva o estado da sess√£o de chat para retomada posterior em outra m√°quina ou sess√£o. Use quando o usu√°rio quiser preservar o contexto de trabalho antes de trocar de m√°quina ou encerrar o chat. Tamb√©m disparado automaticamente quando agent-task-manage conclui todas as tarefas. Triggers: "salva sess√£o", "guarda sess√£o", "finaliza sess√£o", "salva chat", "guarda contexto", "vou trocar de m√°quina", "vou sair", ap√≥s agent-task-manage completar todas as tarefas.
metadata:
  author: copilot-core
  version: "1.0"
  category: agent
  delegable: full
---

# Agent Chat Save

Salva o estado da sess√£o de chat em arquivo persistente para retomada cross-machine.

## Quando Usar

- Usu√°rio pede para salvar sess√£o/chat/contexto
- Usu√°rio indica que vai trocar de m√°quina ou encerrar
- **Automaticamente** quando `agent-task-manage` conclui todas as tarefas de uma lista complexa
- Usu√°rio diz "vou sair", "salva sess√£o", "guarda contexto", "finaliza sess√£o"

## Quando N√ÉO Usar

- Sess√£o trivial sem working context relevante (perguntas simples, consultas pontuais)
- Informa√ß√£o j√° foi registrada como li√ß√£o (`agent-memory-register`) ou contexto (`project-context-update`)

## Workflow

### 1. Determinar t√≥pico

Gerar nome descritivo em kebab-case que resuma o trabalho da sess√£o.

Exemplos:
- `docker-setup` ‚Äî configurando Docker
- `api-refactor` ‚Äî refatorando endpoints da API
- `skill-creation` ‚Äî criando novos skills
- `bug-auth-fix` ‚Äî corrigindo bug de autentica√ß√£o

### 2. Gerar nome do arquivo

Formato: `YYYY-MM-DD_{topico}.md`

Exemplo: `2026-02-15_docker-setup.md`

**Se j√° existe arquivo com mesmo prefixo** (data + t√≥pico):
‚Üí Atualizar o arquivo existente adicionando nova se√ß√£o `## Update: HH:MM` no final

### 3. Coletar contexto da sess√£o

Reunir do contexto do chat:

| Dado | Fonte | Obrigat√≥rio |
|------|-------|-------------|
| Resumo do trabalho | Conversa atual | Sim |
| Steps conclu√≠dos | `manage_todo_list` ou conversa | Sim |
| Steps pendentes | `manage_todo_list` ou conversa | Sim |
| Decis√µes pendentes | Perguntas em aberto | Se houver |
| Arquivos relevantes | Arquivos criados/modificados | Se houver |
| Contexto adicional | Racioc√≠nio, refer√™ncias, links | Se relevante |

### 4. Determinar status

| Status | Quando |
|--------|--------|
| `completed` | Todas as tarefas conclu√≠das, nada pendente |
| `in-progress` | Trabalho ainda em andamento, h√° pr√≥ximos passos |
| `paused` | Trabalho pausado por decis√£o do usu√°rio ou bloqueio externo |

### 5. Formatar e escrever arquivo

Escrever em: `{workspace}/.copilot-project/chat-memory/{nome-arquivo}`

**Template**:

```markdown
---
date: YYYY-MM-DD
topic: {t√≥pico-kebab-case}
status: in-progress | paused | completed
---

# Session: {T√≠tulo Descritivo}

## Resumo

{O que estava sendo feito ‚Äî 2-5 frases com contexto suficiente para retomar}

## Progresso

- [x] {step conclu√≠do 1}
- [x] {step conclu√≠do 2}
- [ ] {step pendente 1}
- [ ] {step pendente 2}

## Pr√≥ximos Passos

{O que falta fazer, em ordem de prioridade. Ser espec√≠fico e acion√°vel.}

## Decis√µes Pendentes

{Quest√µes em aberto que precisam de resposta antes de prosseguir. Omitir se√ß√£o se n√£o houver.}

## Arquivos Relevantes

{Paths dos arquivos criados/modificados/em an√°lise. Omitir se√ß√£o se n√£o houver.}

## Contexto Adicional

{Notas, racioc√≠nio, links, refer√™ncias que ajudam na retomada. Omitir se√ß√£o se n√£o houver.}
```

**Regras do template**:
- Se√ß√µes obrigat√≥rias: Resumo, Progresso, Pr√≥ximos Passos
- Se√ß√µes opcionais: Decis√µes Pendentes, Arquivos Relevantes, Contexto Adicional ‚Äî incluir apenas se houver conte√∫do relevante
- O resumo deve ter contexto suficiente para algu√©m que n√£o leu o chat entender o que estava acontecendo

### 6. Confirmar ao usu√°rio

**Output**:
```
üíæ **Sess√£o salva**: {nome-arquivo}
- Status: {status}
- Pr√≥ximos passos: {quantidade} pendente(s)
```

## Auto-Save (via agent-task-manage)

Quando `agent-task-manage` marca todas as tarefas como `completed`:

1. Verificar se a sess√£o tem contexto relevante para salvar
2. Se sim, executar o workflow completo com status `completed`
3. Se a tarefa √© trivial (< 3 steps, sem decis√µes complexas), **n√£o** salvar automaticamente

**Crit√©rio para auto-save**: A sess√£o tem auto-save relevante quando envolve:
- 4+ tarefas gerenciadas
- Decis√µes arquiteturais ou de design
- M√∫ltiplos arquivos alterados
- Informa√ß√£o que seria √∫til como refer√™ncia futura

## Modo Incremental (via agent-turn-reflect)

Chamado por `agent-turn-reflect` (Fase 4) ao final de cada turno substantivo.

### Primeiro turno da sess√£o

Executar workflow completo (steps 1-5) para criar arquivo com `status: in-progress`.

### Turnos seguintes

1. Localizar arquivo da sess√£o atual (mesmo dia + t√≥pico mais recente)
2. Fazer append de se√ß√£o no final do arquivo:

```markdown
## Turn: HH:MM

{2-3 frases do que aconteceu neste turno}

**Arquivos**: {lista de paths, se houver}
**Decis√µes**: {lista de decis√µes, se houver}
```

3. **N√ÉO** atualizar frontmatter a cada turno ‚Äî apenas no save completo ou ao final da sess√£o

### Regras do modo incremental

- Cada append √© leve (3-6 linhas), sem overhead
- Se o arquivo j√° tem `status: completed` de uma sess√£o anterior no mesmo dia ‚Üí criar novo arquivo com sufixo (`_2`)
- Se `agent-turn-reflect` determina que o turno √© trivial ‚Üí n√£o faz append (Fase 0 j√° filtrou)

## Auto-Init

Se `{workspace}/.copilot-project/chat-memory/` n√£o existir:

1. Criar o diret√≥rio
2. Criar `README.md` com descri√ß√£o do prop√≥sito
3. Prosseguir com o save normalmente
