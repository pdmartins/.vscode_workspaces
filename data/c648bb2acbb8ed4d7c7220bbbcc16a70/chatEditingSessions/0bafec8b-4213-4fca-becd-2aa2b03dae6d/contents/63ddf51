````skill
---
name: agent-memory-sync
description: Sincroniza arquivos .md (memory/*, context/*) com o MCP memory-service (Cloudflare Vectorize) para busca sem√¢ntica. Fonte de verdade s√£o os .md ‚Äî o √≠ndice Cloudflare √© derivado e pode ser reconstru√≠do. Triggers - sincronizar mem√≥ria, sync mcp, indexar, reindexar, atualizar √≠ndice sem√¢ntico, rebuild memory.
metadata:
  author: copilot-core
  version: "2.0"
  category: agent
  delegable: full
---

# Agent Memory Sync

Sincroniza arquivos .md com o MCP memory-service (backend Cloudflare) para busca sem√¢ntica h√≠brida (BM25 + vector).

## Princ√≠pio Fundamental

```
Fonte de verdade: arquivos .md no git
Cloudflare (Vectorize + D1): √≠ndice derivado, descart√°vel e reconstru√≠vel
```

**Nunca** escrever apenas no MCP sem atualizar o .md correspondente.

## Quando Usar

- Ap√≥s `agent-memory-update` criar/alterar entrada (sync incremental)
- Ap√≥s `project-context-update` alterar contexto (sync incremental)
- Ap√≥s `project-codemap-update` alterar code-map (sync incremental)
- Sob demanda: "sincronizar mem√≥ria", "reindexar", "rebuild memory"
- Quando busca sem√¢ntica retorna resultados vazios/desatualizados

## Arquivos Sincronizados

| Fonte | Entidades MCP | Tipo |
|-------|---------------|------|
| `memory/preferences/*.md` | Uma entidade por arquivo | `preference` |
| `memory/patterns/*.md` | Uma entidade por arquivo | `pattern` |
| `memory/decisions/*.md` | Uma entidade por arquivo | `decision` |
| `memory/concepts/*.md` | Uma entidade por arquivo | `concept` |
| `context/index.md` | Uma entidade (resumo do projeto) | `context-index` |
| `context/architecture/*.md` | Uma entidade por arquivo | `context-architecture` |
| `context/business-rules/*.md` | Uma entidade por arquivo | `context-rules` |
| `context/conventions/*.md` | Uma entidade por arquivo | `context-conventions` |
| `context/infrastructure/*.md` | Uma entidade por arquivo | `context-infra` |
| `context/code-map/index.md` | Uma entidade por m√≥dulo | `codemap` |

## Config Loading

Ler credenciais de `.copilot-core/.internal/config/credentials.yml`.

## Workflow ‚Äî Sync Incremental

### 1. Identificar o que mudou

```
Input: { pasta: "memory/patterns", arquivo: "naming-conventions.md" }
```

### 2. Parsear conte√∫do

Ler o arquivo .md e extrair bullet entries.

### 3. Criar/atualizar entidade MCP

```
mcp_memory_create_entities({
  entities: [{
    name: "{tipo}-{slug}",
    entityType: "{tipo}",
    observations: [
      "categoria: {pasta}",
      "arquivo: {path}",
      "conte√∫do: {texto do .md}"
    ]
  }]
})
```

## Workflow ‚Äî Sync Full (Rebuild)

### 1. Limpar entidades existentes

```
mcp_memory_search_nodes({ query: "*" })
mcp_memory_delete_entities({ entityNames: [...] })
```

### 2. Parsear todos os arquivos

Para cada subpasta de `memory/` e `context/`:
- Listar arquivos `.md` (excluindo `.gitkeep`)
- Parsear conte√∫do de cada arquivo

### 3. Criar entidades em batch

### 4. Confirmar

```
‚úÖ Sync completo!
üìã Entidades criadas: {N}
  - Memory: {X} (preferences: {a}, patterns: {b}, decisions: {c}, concepts: {d})
  - Context: {Y} (architecture: {e}, rules: {f}, conventions: {g}, infra: {h})
  - Codemap: {Z}
```

## Tratamento de Erros

| Erro | A√ß√£o |
|------|------|
| MCP server n√£o dispon√≠vel | Reportar: "MCP memory-service n√£o est√° ativo" |
| Cloudflare n√£o acess√≠vel | Verificar CLOUDFLARE_API_TOKEN |
| .md vazio/template | N√£o sincronizar |

````
