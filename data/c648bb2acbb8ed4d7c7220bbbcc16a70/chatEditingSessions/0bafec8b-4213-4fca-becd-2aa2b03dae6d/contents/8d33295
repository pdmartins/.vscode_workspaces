---
name: agent-turn-reflect
description: Reflex√£o autom√°tica ao final de cada turno do agente. Analisa o conte√∫do da conversa para detectar atualiza√ß√µes necess√°rias em contexto do projeto, skills, mem√≥rias e chat-memory. Comportamento adaptativo ‚Äî triage r√°pido em todos os turnos, aprofunda apenas quando detecta algo relevante. Silencioso quando nada h√° a fazer. Triggers: autom√°tico no final de cada turno do agente.
metadata:
  author: copilot-core
  version: "1.0"
  category: agent
  delegable: none
---

# Agent Turn Reflect

Reflex√£o autom√°tica per-turn. Analisa a conversa e atualiza contexto, mem√≥rias e chat-memory incrementalmente.

## Quando Usar

- **Automaticamente** ao final de cada turno do agente (ap√≥s completar a resposta ao usu√°rio)
- √â a √öLTIMA coisa que o agente faz antes de entregar a resposta

## Quando N√ÉO Usar

- Nunca pular ‚Äî o triage r√°pido (Fase 0) √© quem decide se h√° algo a fazer
- N√£o usar como substituto de `agent-action-review` (que valida completude p√≥s-task-manage)

## Workflow

### Fase 0 ‚Äî Triage R√°pido

Checklist mental (N√ÉO exibir ao usu√°rio):

| Pergunta | Se "sim" ‚Üí prosseguir para |
|----------|---------------------------|
| Houve decis√£o arquitetural, t√©cnica ou de processo? | Fase 3 (Mem√≥rias) |
| Houve mudan√ßa de stack, restri√ß√£o, integra√ß√£o ou estado do projeto? | Fase 1 (Contexto) |
| Houve gap, erro ou melhoria identificada em alguma skill? | Fase 2 (Skills) |
| Houve progresso report√°vel (arquivos criados/editados, tarefas conclu√≠das)? | Fase 4 (Chat Memory) |

**Se TODAS "n√£o"** ‚Üí skip silencioso, sem output algum.

**Se QUALQUER "sim"** ‚Üí executar apenas as fases aplic√°veis (n√£o precisa executar todas).

### Fase 1 ‚Äî Contexto do Projeto

Analisar se a conversa revelou:
- Mudan√ßa de stack tecnol√≥gico
- Nova restri√ß√£o ou remo√ß√£o de restri√ß√£o
- Nova integra√ß√£o ou servi√ßo
- Mudan√ßa de fase ou objetivo do projeto
- Informa√ß√£o factual sobre o projeto n√£o registrada

**Se detectar** ‚Üí executar `project-context-update` automaticamente (sem perguntar).

### Fase 2 ‚Äî Skills

Analisar se a conversa revelou:
- Gap num skill existente (funcionalidade esperada mas ausente)
- Comportamento incorreto descrito num skill
- Necessidade de novo skill
- Skill que deveria ser atualizado com nova regra ou padr√£o

**Se detectar** ‚Üí **PERGUNTAR ao usu√°rio** antes de qualquer altera√ß√£o:

```
‚ùì **Preciso de clarifica√ß√£o**: Detectei que {descri√ß√£o do gap/melhoria} no skill `{nome}`. Faz sentido atualizar?
```

S√≥ prosseguir com a altera√ß√£o se o usu√°rio confirmar.

### Fase 3 ‚Äî Mem√≥rias e Li√ß√µes

Analisar se a conversa cont√©m:
- Decis√µes impl√≠citas (tomadas naturalmente, sem frase-gatilho como "guarda isso")
- Padr√µes estabelecidos durante a conversa
- Conhecimento que seria perdido sem registro
- Erros resolvidos com aprendizado √∫til

**Nota**: N√£o duplicar o que os auto-registers reativos j√° capturam (corre√ß√µes expl√≠citas de c√≥digo, corre√ß√µes de regras). Esta fase captura o que ficaria PERDIDO sem reflex√£o ativa.

**Se detectar** ‚Üí executar `agent-memory-register` automaticamente.

### Fase 4 ‚Äî Chat Memory Incremental

Fazer append ao arquivo de chat-memory da sess√£o atual.

**Primeiro turno substantivo da sess√£o:**
1. Criar arquivo `YYYY-MM-DD_{topico}.md` em `.copilot-project/chat-memory/`
2. Usar frontmatter com `status: in-progress`
3. Incluir se√ß√£o `## Resumo` inicial + `## Progresso`

**Turnos seguintes:**
1. Localizar arquivo da sess√£o atual (mesmo dia, mesmo t√≥pico ou mais recente do dia)
2. Fazer append de se√ß√£o `## Turn: HH:MM`
3. Conte√∫do do append (2-3 frases):
   - O que aconteceu neste turno
   - Arquivos tocados (se houver)
   - Decis√µes tomadas (se houver)

**Se j√° existe arquivo do mesmo dia e t√≥pico** ‚Üí append ao existente.

**Turnos triviais** (apenas consulta, sem a√ß√£o): N√ÉO fazer append ‚Äî Fase 0 j√° filtrou.

## Output

**Quando nada detecta**: Sil√™ncio total ‚Äî sem output.

**Quando atualiza algo**: Uma linha por atualiza√ß√£o, formato m√≠nimo:

```
üîÑ {tipo}: {descri√ß√£o curta}
```

Exemplos:
- `üîÑ Contexto: adicionada restri√ß√£o de rate-limiting`
- `üîÑ Mem√≥ria: decis√£o de usar Redis para cache`
- `üîÑ Chat: sess√£o atualizada`

**Quando prop√µe altera√ß√£o de skill**: Usa formato de pergunta (Fase 2).

## Intera√ß√£o com Outros Skills

| Skill | Rela√ß√£o |
|-------|---------|
| `agent-memory-register` | Delegado pela Fase 3 |
| `project-context-update` | Delegado pela Fase 1 |
| `agent-chat-save` | Fase 4 usa modo incremental do chat-save |
| `agent-action-review` | Independente ‚Äî action-review valida p√≥s-task-manage; turn-reflect analisa per-turn |
| Auto-registers reativos | Complementar ‚Äî turn-reflect captura o que os reativos N√ÉO capturam |
