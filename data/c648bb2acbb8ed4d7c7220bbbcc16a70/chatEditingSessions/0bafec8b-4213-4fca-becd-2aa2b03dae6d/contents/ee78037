---
applyTo: '**'
---

# Copilot Agent Instructions

Regras globais para o agente. Skills s√£o carregados automaticamente conforme necessidade.

## Princ√≠pios

1. **Instru√ß√µes s√£o obrigat√≥rias** - n√£o s√£o sugest√µes
2. **Perguntar antes de assumir** - quando houver ambiguidade, perguntar
3. **Portugu√™s para chat, ingl√™s para c√≥digo** - vari√°veis, fun√ß√µes, nomes de arquivo em ingl√™s

## Clarifica√ß√£o

**Perguntar quando:**
- Pedido √© vago ou amb√≠guo
- M√∫ltiplas interpreta√ß√µes poss√≠veis
- Informa√ß√£o cr√≠tica faltando
- Decis√£o impacta significativamente o resultado

**N√ÉO perguntar quando:**
- Informa√ß√£o est√° expl√≠cita
- Conven√ß√£o est√° documentada
- Decis√£o √© trivial
- Contexto torna resposta √≥bvia

**Formato**: ‚ùì **Preciso de clarifica√ß√£o**: {pergunta}

## Skills

Este projeto usa o padr√£o [Agent Skills](https://agentskills.io).

### Sinaliza√ß√£o de Uso

**Sempre que uma skill for ativada**, o agente DEVE sinalizar no in√≠cio da resposta:

```
üîß Skill: `{nome-da-skill}`
```

Se m√∫ltiplas skills forem ativadas na mesma resposta:

```
üîß Skills: `{skill-1}`, `{skill-2}`
```

Isso garante rastreabilidade e transpar√™ncia sobre quais skills est√£o sendo utilizadas.

### Descoberta de Skills

O agente DEVE escanear os seguintes diret√≥rios para descobrir skills dispon√≠veis:

1. **Core Skills**: `.copilot-core/skills/` (organizados em subpastas por tipo: `agent/`, `code/`, `editor/`, `infra/`, `project/`, `skill/`)
2. **Project Skills**: `.copilot-project/skills/`

Para cada skill encontrado (recursivamente), ler o frontmatter (`name` e `description`) do `SKILL.md`.
Usar o campo `description` para decidir quando ativar cada skill.

> **Cat√°logo unificado**: O agente trabalha com um cat√°logo √∫nico que combina core skills + project skills. Project skills complementam o core ‚Äî podem adicionar funcionalidade espec√≠fica do projeto (ex: `editor-english-sync` em projetos que precisam de sync de README). Quando houver skill com mesmo nome em ambos, o project skill prevalece.

### Dados do Projeto

O agente DEVE consultar quando relevante:

- **Contexto**: `.copilot-project/context/project.md`
- **Mem√≥ria**: `.copilot-project/memory/lessons-learned.md`
- **Chat Memory**: `.copilot-project/chat-memory/`
- **Mapa de C√≥digo**: `.copilot-project/context/code-map/`

**Nomenclatura**: `{tipo}/{tipo}-{feature}-{a√ß√£o}/SKILL.md`

### Skills Core

O sistema possui **60 skills** organizados em 6 tipos. A descoberta usa cat√°logos por tipo.

#### Capability Manifest

| Tipo | Capacidades | Descoberta | Skills |
|------|------------|------------|--------|
| `agent` | Mem√≥ria, delega√ß√£o, tarefas, sess√µes, valida√ß√£o, sync MCP, git guard, reflex√£o per-turn | `agent-catalog-query` | 11 |
| `code` | Review, gera√ß√£o .NET, CQRS/DDD, testes, bash/powershell | `code-catalog-query` | 22 |
| `infra` | Docker, K8s, Redis, GCP, pipelines, JWT, mensageria | `infra-catalog-query` | 12 |
| `project` | Contexto, codemap, setup, branches, an√°lise | `project-catalog-query` | 9 |
| `skill` | Criar e validar skills | (direto) | 2 |
| `editor` | Markdown lint, READMEs | (direto) | 2 |

#### Skills Always-Known (ativa√ß√£o direta, sem cat√°logo)

| Skill | Prop√≥sito |
|-------|-----------|
| `agent-memory-query` | Consultar li√ß√µes aprendidas |
| `agent-memory-register` | Registrar novas li√ß√µes |
| `agent-memory-sync` | Sincronizar mem√≥ria com MCP memory-service |
| `agent-action-review` | Validar completude e consist√™ncia p√≥s-a√ß√£o |
| `agent-impact-validate` | Validar impactos em cascade p√≥s-edi√ß√£o |
| `agent-git-guard` | Verificar permiss√µes git antes de executar (add/commit/push) |
| `project-context-query` | Consultar contexto do projeto |
| `skill-template-create` | Criar novos skills |
| `skill-output-validate` | Validar estrutura e qualidade de artefatos |
| `editor-markdown-lint` | Regras de formata√ß√£o Markdown |
| `editor-readme-generate` | Cria√ß√£o e atualiza√ß√£o de READMEs |
| `agent-turn-reflect` | Reflex√£o autom√°tica per-turn (contexto, mem√≥rias, chat-memory) |

### Descoberta Otimizada

Para evitar carregar frontmatter de 50+ skills a cada sess√£o:

1. **Identificar tipo** ‚Äî pela tarefa do usu√°rio, determinar o tipo (`agent`, `code`, `infra`, `project`)
2. **Consultar cat√°logo core** ‚Äî usar `runSubagent` para ler o `{tipo}-catalog-query` e listar skills do tipo
3. **Consultar project skills** ‚Äî verificar se `.copilot-project/skills/` cont√©m skills adicionais do tipo relevante
4. **Ativar skill espec√≠fica** ‚Äî carregar apenas o SKILL.md necess√°rio (core ou project)

**Exemplo de fluxo com subagent:**
```
Tarefa: "criar Dockerfile para o projeto"
‚Üí Tipo: infra
‚Üí Subagent l√™: infra-catalog-query + project skills infra-*
‚Üí Resultado: usar infra-docker-build (+ config.yml do project se existir)
‚Üí Agente carrega: infra-docker-build/SKILL.md
```

Para skills de uso direto (`skill-template-create`, `editor-markdown-lint`) ‚Äî ativar sem cat√°logo.

### Delega√ß√£o a Subagents

Skills podem ser delegadas a subagents via `runSubagent`. Consultar `agent-subagent-delegate` para regras completas e classifica√ß√£o de cada skill.

Cada skill tem `delegable` no frontmatter: `full` (aut√¥nomo), `orchestrated` (main coleta inputs), `none` (main agent only).

#### Template de Prompt

Usar `.copilot-core/templates/subagent-prompt.md` para montar prompts padronizados.

## Agent vs Plan Mode

| Modo | Quando usar |
|------|------------|
| **Agent** | Tarefas claras e diretas ‚Äî registrar li√ß√£o, criar skill, configurar projeto j√° plugado |
| **Plan** | Tarefas complexas que precisam de revis√£o ‚Äî `project-workspace-create`, refatora√ß√µes grandes, an√°lises de arquitetura |

> **`project-workspace-create` deve ser usado com Plan mode** ‚Äî envolve coleta de contexto profundo, decis√£o de quais skills criar e revis√£o antes de executar.

## Tarefas Complexas

**Usar `manage_todo_list` quando:**
- Tarefa tem 4+ steps distintos
- Usu√°rio pede m√∫ltiplas coisas
- Envolve m√∫ltiplos arquivos
- Requer planejamento

**Workflow:**
1. Criar lista com todos os steps
2. Marcar um como `in-progress`
3. Executar e marcar `completed` imediatamente
4. Pr√≥ximo step ‚Üí `in-progress`

## Mem√≥ria e Contexto

### Roteamento ‚Äî Quando o usu√°rio pede para guardar informa√ß√£o

Quando o usu√°rio disser qualquer varia√ß√£o de "guarda", "salva", "anota", "lembra", "registra", "memoriza", "n√£o esquece" uma informa√ß√£o, o agente DEVE decidir:

| Tipo de Informa√ß√£o | Skill | Destino |
|-------------------|-------|---------|
| Li√ß√£o aprendida, erro corrigido, padr√£o descoberto, decis√£o tomada | `agent-memory-register` | `memory/lessons-learned.md` |
| Mudan√ßa de stack, nova integra√ß√£o, restri√ß√£o, estado do projeto | `project-context-update` | `context/project.md` |

**Se amb√≠guo** ‚Üí perguntar ao usu√°rio: "Isso √© uma li√ß√£o/decis√£o ou uma mudan√ßa no projeto?"

**Se claramente nenhum dos dois** ‚Üí informar que a informa√ß√£o n√£o se encaixa em mem√≥ria nem contexto e sugerir onde guardar.

### Registro autom√°tico ‚Äî Corre√ß√µes de c√≥digo gerado

Quando o usu√°rio pedir para **corrigir ou alterar c√≥digo que o agente gerou**, o agente DEVE:

1. **Aplicar a corre√ß√£o** normalmente
2. **Registrar automaticamente** uma li√ß√£o via `agent-memory-register` com:
   - **Categoria**: `padr√µes`
   - **Context**: O que o agente gerou incorretamente
   - **Decision**: O que o usu√°rio corrigiu e qual √© o padr√£o correto
   - **Outcome**: Regra a seguir em futuras gera√ß√µes

**Detectar quando:**
- Usu√°rio diz "n√£o √© assim", "muda isso", "corrige isso", "prefiro assim", "faz diferente"
- Usu√°rio altera padr√£o de nomenclatura, estilo, estrutura ou abordagem
- Usu√°rio rejeita uma implementa√ß√£o e pede outra forma
- Usu√°rio aponta erro no c√≥digo gerado pelo agente

**N√ÉO registrar quando:**
- Corre√ß√£o √© por mudan√ßa de requisito (usu√°rio mudou de ideia, n√£o corrigiu padr√£o)
- Erro factual pontual (typo, vari√°vel errada) sem padr√£o recorrente

**Output adicional ap√≥s a corre√ß√£o:**
```
üìù **Padr√£o registrado**: {descri√ß√£o curta do padr√£o aprendido}
```

### Registro autom√°tico ‚Äî Corre√ß√µes de regras, estrutura e processos

Quando o usu√°rio **definir, corrigir ou alterar regras, estruturas ou processos** do sistema (incluindo o pr√≥prio `.copilot-core`), o agente DEVE:

1. **Aplicar a mudan√ßa** nos arquivos relevantes (skills, instructions, templates, context)
2. **Registrar automaticamente** uma li√ß√£o via `agent-memory-register` com:
   - **Categoria**: `regras` ou `estrutura`
   - **Context**: O que existia antes ou o que o agente fez incorretamente
   - **Decision**: O que o usu√°rio definiu/corrigiu
   - **Outcome**: Regra a seguir em futuras opera√ß√µes

**Detectar quando:**
- Usu√°rio define como algo deve funcionar ("a estrutura √© assim", "o padr√£o √© esse")
- Usu√°rio corrige uma decis√£o do agente sobre estrutura/processo
- Usu√°rio altera padr√£o de organiza√ß√£o, fluxo de trabalho ou conven√ß√£o
- Usu√°rio aponta que uma instru√ß√£o/skill est√° incorreta ou incompleta

### MCP Auto-Setup

No in√≠cio de cada sess√£o em projeto existente (`.copilot-project/` presente), o agente DEVE verificar:

| Verifica√ß√£o | Condi√ß√£o | A√ß√£o autom√°tica |
|-------------|----------|------------------|
| `.vscode/mcp.json` n√£o existe | Ausente | Ler credenciais de `.copilot-core/config/credentials.yml` e gerar mcp.json (ver `project-setup-bootstrap` step 6). **Windows**: detectar caminho real do Python via terminal (`python -c "import sys; print(sys.executable)"`) e usar caminho completo no `command` |
| MCP n√£o tem dados deste projeto | `.copilot-project/memory/lessons-learned.md` tem conte√∫do (`<lesson` presente) | Executar `agent-memory-sync` full rebuild com tag do projeto |
| MCP n√£o tem dados deste projeto | `.md` tamb√©m vazio/template | Nenhuma a√ß√£o (nada para indexar) |

**Como verificar dados do projeto no MCP:**
- Buscar com `mcp_memory_memory_search` usando tag do projeto (branch name do `.copilot-project`)
- Se retornar 0 resultados E os `.md` t√™m conte√∫do ‚Üí sync necess√°rio
- O √≠ndice Cloudflare √© **partilhado entre projetos** ‚Äî a tag identifica a origem

**Config centralizado:**
- Credenciais Cloudflare em `.copilot-core/config/credentials.yml`
- Skills que geram mcp.json DEVEM ler deste config (nunca hardcodar valores)

**Pr√©-requisitos por m√°quina** (reportar se ausentes):
- Python 3.12+ instalado (`python --version` ou `python3 --version`)
- `pip install mcp-memory-service`

**Output ao auto-configurar:**
```
‚öôÔ∏è MCP auto-setup: {a√ß√£o executada}
```

Esta verifica√ß√£o √© **silenciosa** se tudo estiver OK ‚Äî s√≥ reporta quando encontra e corrige algo.

### Consulta autom√°tica

**Antes de tarefas complexas:**
- Consultar `agent-memory-query` para li√ß√µes aprendidas
- Consultar `project-context-query` para stack e restri√ß√µes

**Antes de gerar c√≥digo:**
- Consultar `project-codemap-query` para verificar artefatos existentes e evitar duplica√ß√£o
- Consultar `agent-memory-query` com foco em `padr√µes` para aplicar prefer√™ncias do usu√°rio

**Ap√≥s criar/alterar c√≥digo:**
- Registrar com `project-codemap-update` os artefatos criados ou alterados

**Ap√≥s decis√µes importantes:**
- Registrar com `agent-memory-register`

### Sess√£o e Continuidade

O agente possui persist√™ncia de sess√£o para trabalho cross-machine via `chat-memory/`.

| Situa√ß√£o | Skill | Destino |
|----------|-------|---------|
| Usu√°rio pede para salvar sess√£o / trocar de m√°quina | `agent-chat-save` | `chat-memory/{date}_{topic}.md` |
| Usu√°rio pede para retomar sess√£o anterior | `agent-chat-resume` | L√™ de `chat-memory/` |
| `agent-task-manage` completa todas as tarefas (4+ steps) | `agent-action-review` ‚Üí `agent-chat-save` (auto) | valida√ß√£o + `chat-memory/{date}_{topic}.md` |

**Auto-save ap√≥s task-manage**: Quando `agent-task-manage` marca todas as tarefas como `completed` e a sess√£o √© complexa (4+ steps, decis√µes importantes, m√∫ltiplos arquivos), a cadeia de finaliza√ß√£o √©:

```
agent-task-manage (todas completed)
  ‚Üí agent-action-review (valida completude e consist√™ncia)
    ‚Üí agent-impact-validate (se 3+ arquivos modificados)
      ‚Üí agent-chat-save (salva sess√£o com status completed)
```

**Dados do Projeto** inclui:
- **Chat Memory**: `.copilot-project/chat-memory/`

### Reflex√£o Per-Turn

Ao final de **CADA turno** (ap√≥s completar a resposta ao usu√°rio), o agente DEVE executar `agent-turn-reflect`.

Comportamento **adaptativo**: triage r√°pido em todos os turnos, aprofunda apenas se detectar algo relevante.

#### Triage R√°pido (mental, N√ÉO exibir)

| Pergunta | Se "sim" ‚Üí fase |
|----------|------------------|
| Houve decis√£o arquitetural, t√©cnica ou de processo? | Fase 3 ‚Äî Mem√≥rias |
| Houve mudan√ßa de stack, restri√ß√£o, integra√ß√£o ou estado? | Fase 1 ‚Äî Contexto |
| Houve gap, erro ou melhoria identificada em skill? | Fase 2 ‚Äî Skills |
| Houve progresso report√°vel (arquivos, tarefas)? | Fase 4 ‚Äî Chat Memory |

**Se TODAS "n√£o"** ‚Üí skip silencioso.

#### Fases

| Fase | O que faz | Autom√°tico? |
|------|-----------|-------------|
| 1 ‚Äî Contexto | Detecta mudan√ßas de contexto ‚Üí `project-context-update` | Sim |
| 2 ‚Äî Skills | Detecta gaps/melhorias em skills ‚Üí **pergunta ao usu√°rio** | N√£o (pergunta) |
| 3 ‚Äî Mem√≥rias | Captura decis√µes impl√≠citas ‚Üí `agent-memory-register` | Sim |
| 4 ‚Äî Chat Memory | Append incremental ao chat-memory da sess√£o | Sim |

**Fase 2 √© a √∫nica que requer confirma√ß√£o** ‚Äî alterar skills √© high-impact.

#### Visibilidade

- **Nada detectado**: sil√™ncio total
- **Atualiza√ß√£o feita**: uma linha por atualiza√ß√£o ‚Üí `üîÑ {tipo}: {descri√ß√£o curta}`
- **Proposta de skill**: formato de pergunta (`‚ùì **Preciso de clarifica√ß√£o**: ...`)

## Opera√ß√µes Git

**OBRIGAT√ìRIO**: Antes de executar qualquer `git add`, `git commit` ou `git push`, o agente DEVE consultar `agent-git-guard` para verificar permiss√µes do projeto. Sem config = sem git (o usu√°rio revisa via Source Control do VS Code).

## Regras de C√≥digo

- **Linguagem do chat**: Portugu√™s brasileiro
- **Linguagem do c√≥digo**: Ingl√™s (vari√°veis, fun√ß√µes, par√¢metros, nomes de arquivo)
- **Nunca criar documenta√ß√£o autom√°tica** - apenas quando solicitado

## Qualidade de Skills

Toda skill criada ou alterada DEVE seguir estas regras:

| Regra | Descri√ß√£o |
|-------|----------|
| **Padr√£o Agent Skills** | Frontmatter completo, naming 3-segmentos, se√ß√µes obrigat√≥rias |
| **Simplicidade** | Workflow direto, sem instru√ß√µes excessivas. Se SKILL.md > 150 linhas ‚Üí considerar split |
| **Clareza** | Linguagem imperativa, steps numerados, tabelas para decis√£o. O agente GHCP deve entender sem ambiguidade |
| **Context Database** | Sempre registrar via `agent-memory-sync` (incremental) ap√≥s criar/alterar skill |
| **Divis√£o** | Skill com 2+ responsabilidades distintas ‚Üí dividir em skills separadas |

