---
name: code-refactor-extract
description: Extrai m√©todos, classes, interfaces; move responsabilidades; aplica SRP. Segue padr√µes do projeto via config.yml. Triggers: "extrair m√©todo", "refatorar", "separar responsabilidade", "mover para classe", "extrair interface", "dividir", "simplificar", "muito grande", "est√° complexo".
metadata:
  author: copilot-core
  version: "1.0"
  category: code
  delegable: orchestrated
---

# Code Refactor Extract

Extrai e reorganiza c√≥digo aplicando princ√≠pios SOLID, configur√°vel por projeto.

## Quando Usar

- M√©todo/classe muito grande ou complexo
- Viola√ß√£o de SRP (Single Responsibility Principle)
- C√≥digo duplicado que pode ser extra√≠do
- Usu√°rio pede "extrair", "refatorar", "separar", "simplificar"

## Config Loading

1. Verificar se existe `{workspace}/.copilot-project/skills/code-refactor-extract/config.yml`
2. Se existe, carregar padr√µes de extra√ß√£o do projeto
3. Verificar se existe `{workspace}/.copilot-project/skills/code-refactor-extract/SKILL.md`
4. Se existe, carregar instru√ß√µes complementares
5. Se nenhum existe, usar padr√µes gen√©ricos

## Workflow

### 1. Analisar c√≥digo

- Identificar responsabilidades distintas
- Medir complexidade (m√©todos longos, muitos par√¢metros)
- Identificar c√≥digo duplicado
- Verificar acoplamento

### 2. Consultar code-map

Usar `project-codemap-query` para:
- Verificar se j√° existe classe/m√©todo que cobre a responsabilidade
- Entender onde colocar o c√≥digo extra√≠do
- Identificar depend√™ncias afetadas

### 3. Propor refatora√ß√£o

Antes de executar, apresentar o plano:

```
üîß **Refatora√ß√£o proposta**

| A√ß√£o | De | Para | Motivo |
|------|----|------|--------|
| Extrair m√©todo | `ClassA.LongMethod` L50-80 | `ClassA.ExtractedMethod` | SRP |
| Extrair classe | `ClassA` responsabilidade X | `NewClassB` | SRP |
| Mover m√©todo | `ClassA.Method` | `ClassC.Method` | Coes√£o |

Confirmar?
```

### 4. Executar refatora√ß√£o

- Extrair c√≥digo mantendo a interface p√∫blica
- Atualizar depend√™ncias e imports
- Manter testes existentes passando
- Adicionar testes para novos artefatos

### 5. Atualizar code-map

Usar `project-codemap-update` para registrar mudan√ßas.

## Tipos de Extra√ß√£o

### Extract Method

```
Antes: m√©todo com 50+ linhas
Depois: m√©todo chamando subm√©todos com responsabilidades claras
```

- Nome descritivo baseado na a√ß√£o
- Par√¢metros m√≠nimos necess√°rios
- Retorno claro

### Extract Class

```
Antes: classe com m√∫ltiplas responsabilidades
Depois: 2+ classes com responsabilidade √∫nica
```

- Mover para arquivo pr√≥prio
- Extrair interface se necess√°rio
- Registrar no DI container

### Extract Interface

```
Antes: depend√™ncia direta de implementa√ß√£o
Depois: depend√™ncia via interface (testabilidade)
```

- Interface em `Contracts/` (ou conforme config)
- Seguir naming: `I{ClassName}`

### Move Method/Class

```
Antes: m√©todo/classe no lugar errado (baixa coes√£o)
Depois: m√©todo/classe na camada/namespace correto
```

## Checklist

- [ ] Funcionalidade preservada (testes passam)
- [ ] Nenhum artefato √≥rf√£o
- [ ] Depend√™ncias atualizadas
- [ ] Naming segue conven√ß√µes do projeto
- [ ] Code map atualizado
- [ ] Novos testes para novos artefatos

## Config Schema

```yaml
# .copilot-project/skills/code-refactor-extract/config.yml
thresholds:
  max-method-lines: 30
  max-class-lines: 300
  max-parameters: 5
  max-cyclomatic-complexity: 10
extraction:
  interfaces-path: "Contracts/"
  services-path: "Services/"
  utils-path: "Helpers/"
naming:
  extracted-methods: descriptive-action  # descriptive-action | verb-noun
  new-classes: "{Responsibility}{Type}"  # e.g., PaymentValidator
conventions:
  always-extract-interface: true
  separate-file-per-class: true
```

## Subagent Pattern

**Tipo**: `orchestrated` ‚Äî 2-phase (an√°lise ‚Üí confirma√ß√£o ‚Üí execu√ß√£o)

### Fase 1 ‚Äî An√°lise (deleg√°vel)

Subagent l√™ o c√≥digo-alvo + config.yml e retorna proposta de refatora√ß√£o:
- M√©todos/classes candidatos a extra√ß√£o
- Justificativa (SRP, complexidade, duplica√ß√£o)
- Impacto estimado

### Confirma√ß√£o (main agent)

Main agent apresenta a proposta ao usu√°rio e coleta aprova√ß√£o/ajustes.

### Fase 2 ‚Äî Execu√ß√£o (deleg√°vel)

Subagent recebe o plano aprovado e executa:
- Extrai m√©todos/classes
- Atualiza depend√™ncias
- Atualiza code-map via `project-codemap-update`

### Prompt Exemplo

```
// Fase 1
runSubagent({
  description: "Analyze refactoring",
  prompt: "Leia .copilot-core/skills/code/code-refactor-extract/SKILL.md. Analise {arquivo}. N√ÉO modifique nada. Retorne: lista de extra√ß√µes recomendadas com justificativa."
})

// Fase 2 (ap√≥s aprova√ß√£o)
runSubagent({
  description: "Execute refactoring",
  prompt: "Leia .copilot-core/skills/code/code-refactor-extract/SKILL.md. Aplique APENAS: {lista de a√ß√µes aprovadas}. Retorne: arquivos modificados/criados."
})
```
