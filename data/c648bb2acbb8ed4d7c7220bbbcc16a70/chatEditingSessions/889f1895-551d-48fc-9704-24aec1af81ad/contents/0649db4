---
name: infra-repository-generate
description: Extensões específicas do projeto BeWiser Assistant para infra-repository-generate.
metadata:
  author: copilot-project
  version: "1.0"
  category: infra
---

# Repository — BeWiser Assistant (Conversations & Messages)

> Este arquivo complementa o skill core `.copilot-core/skills/infra/infra-repository-generate/SKILL.md`.
> Contém apenas especificidades do projeto BeWiser Assistant API.

## ConversationRepository

```csharp
using Dapper;
using Microsoft.Extensions.Logging;

namespace BeWiser.Assistant.Infrastructure.Persistence.Repositories;

public class ConversationRepository : IConversationRepository
{
    private readonly IDbConnectionFactory _connectionFactory;
    private readonly ILogger<ConversationRepository> _logger;

    public ConversationRepository(
        IDbConnectionFactory connectionFactory,
        ILogger<ConversationRepository> logger)
    {
        _connectionFactory = connectionFactory;
        _logger = logger;
    }

    public async Task<Conversation?> GetByIdAsync(
        Guid id,
        CancellationToken cancellationToken = default)
    {
        _logger.LogDebug("Getting conversation {Id}", id);
        
        using var connection = _connectionFactory.CreateConnection();
        
        return await connection.QueryFirstOrDefaultAsync<Conversation>(
            ConversationSql.GetById,
            new { Id = id });
    }

    public async Task<Conversation?> GetByPhoneNumberAsync(
        string phoneNumber,
        CancellationToken cancellationToken = default)
    {
        using var connection = _connectionFactory.CreateConnection();
        
        return await connection.QueryFirstOrDefaultAsync<Conversation>(
            ConversationSql.GetByPhoneNumber,
            new { PhoneNumber = phoneNumber });
    }

    public async Task<(IReadOnlyList<Conversation> Items, int TotalCount)> ListAsync(
        Guid? assistantId,
        int page,
        int pageSize,
        CancellationToken cancellationToken = default)
    {
        using var connection = _connectionFactory.CreateConnection();

        var parameters = new
        {
            AssistantId = assistantId,
            Offset = (page - 1) * pageSize,
            Limit = pageSize
        };

        using var multi = await connection.QueryMultipleAsync(
            ConversationSql.ListWithCount,
            parameters);

        var items = (await multi.ReadAsync<Conversation>()).ToList();
        var totalCount = await multi.ReadSingleAsync<int>();

        return (items, totalCount);
    }

    public async Task AddAsync(
        Conversation conversation,
        CancellationToken cancellationToken = default)
    {
        _logger.LogDebug("Adding conversation {Id}", conversation.Id);
        
        using var connection = _connectionFactory.CreateConnection();
        
        await connection.ExecuteAsync(
            ConversationSql.Insert,
            new
            {
                conversation.Id,
                PhoneNumber = conversation.PhoneNumber.Value,
                AssistantPhoneNumber = conversation.AssistantPhoneNumber.Value,
                Status = (int)conversation.Status,
                conversation.AssistantId,
                CreatedAt = DateTime.UtcNow
            });
    }

    public async Task UpdateAsync(
        Conversation conversation,
        CancellationToken cancellationToken = default)
    {
        using var connection = _connectionFactory.CreateConnection();
        
        await connection.ExecuteAsync(
            ConversationSql.Update,
            new
            {
                conversation.Id,
                Status = (int)conversation.Status,
                conversation.EndedAt,
                UpdatedAt = DateTime.UtcNow
            });
    }
}
```

## SQL Scripts — Conversation

### GetById.sql

```sql
SELECT 
    Id,
    PhoneNumber,
    AssistantPhoneNumber,
    Status,
    AssistantId,
    CreatedAt,
    UpdatedAt,
    EndedAt
FROM Conversations
WHERE Id = @Id
```

### GetByPhoneNumber.sql

```sql
SELECT TOP 1
    Id,
    PhoneNumber,
    AssistantPhoneNumber,
    Status,
    AssistantId,
    CreatedAt,
    UpdatedAt,
    EndedAt
FROM Conversations
WHERE PhoneNumber = @PhoneNumber
    AND Status = 1 -- Active
ORDER BY CreatedAt DESC
```

### Insert.sql

```sql
INSERT INTO Conversations (
    Id,
    PhoneNumber,
    AssistantPhoneNumber,
    Status,
    AssistantId,
    CreatedAt
) VALUES (
    @Id,
    @PhoneNumber,
    @AssistantPhoneNumber,
    @Status,
    @AssistantId,
    @CreatedAt
)
```

### Update.sql

```sql
UPDATE Conversations
SET 
    Status = @Status,
    EndedAt = @EndedAt,
    UpdatedAt = @UpdatedAt
WHERE Id = @Id
```

### ListWithCount.sql

```sql
-- Items
SELECT 
    Id,
    PhoneNumber,
    AssistantPhoneNumber,
    Status,
    AssistantId,
    CreatedAt,
    UpdatedAt,
    EndedAt
FROM Conversations
WHERE (@AssistantId IS NULL OR AssistantId = @AssistantId)
ORDER BY CreatedAt DESC
OFFSET @Offset ROWS
FETCH NEXT @Limit ROWS ONLY;

-- Total count
SELECT COUNT(*)
FROM Conversations
WHERE (@AssistantId IS NULL OR AssistantId = @AssistantId);
```

## SQL Scripts — Message

### GetById.sql

```sql
SELECT Id, ConversationId, Content, Direction, ExternalId, Status, CreatedAt
FROM Messages
WHERE Id = @Id
```

### ListByConversation.sql

```sql
SELECT Id, ConversationId, Content, Direction, ExternalId, Status, CreatedAt
FROM Messages
WHERE ConversationId = @ConversationId
ORDER BY CreatedAt ASC
```

### Insert.sql

```sql
INSERT INTO Messages (Id, ConversationId, Content, Direction, ExternalId, Status, CreatedAt)
VALUES (@Id, @ConversationId, @Content, @Direction, @ExternalId, @Status, @CreatedAt)
```

## Type Handlers do Projeto

```csharp
using Dapper;
using System.Data;

namespace BeWiser.Assistant.Infrastructure.Persistence.TypeHandlers;

public class PhoneNumberVOTypeHandler : SqlMapper.TypeHandler<PhoneNumberVO>
{
    public override PhoneNumberVO Parse(object value)
        => new(value.ToString()!);

    public override void SetValue(IDbDataParameter parameter, PhoneNumberVO? value)
        => parameter.Value = value?.Value;
}

public class MessageContentVOTypeHandler : SqlMapper.TypeHandler<MessageContentVO>
{
    public override MessageContentVO Parse(object value)
        => new(value.ToString()!);

    public override void SetValue(IDbDataParameter parameter, MessageContentVO? value)
        => parameter.Value = value?.Value;
}
```
