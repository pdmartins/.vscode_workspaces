#!/usr/bin/env bash
# Setup Instructions - Copilot Agent Skills
# Corrige symlinks quebrados em .github/instructions/
# Pode ser executado da raiz do projeto OU de dentro de .copilot-core/config/

set -e

# Detectar se estamos em .copilot-core/config e ajustar o diretÃ³rio
if [[ "$PWD" == *".copilot-core/config" ]]; then
    echo "ğŸ“ Detectado execuÃ§Ã£o de dentro de .copilot-core/config"
    echo "   Mudando para raiz do projeto..."
    cd ../..
fi

echo "ğŸ”§ Corrigindo symlinks do Copilot Agent..."

# Verificar se estamos na raiz de um projeto com .copilot-core e .copilot-project
if [ ! -d ".copilot-core" ] || [ ! -d ".copilot-project" ]; then
    echo "âŒ Erro: .copilot-core ou .copilot-project nÃ£o encontrados"
    echo "   Execute este script na raiz do projeto que contÃ©m os submodules/clones"
    exit 1
fi

# Verificar se os arquivos de destino existem
if [ ! -f ".copilot-core/instructions/agent-skills-core.instructions.md" ]; then
    echo "âŒ Erro: .copilot-core/instructions/agent-skills-core.instructions.md nÃ£o encontrado"
    exit 1
fi

if [ ! -f ".copilot-project/instructions/agent-skills-project.instructions.md" ]; then
    echo "âŒ Erro: .copilot-project/instructions/agent-skills-project.instructions.md nÃ£o encontrado"
    exit 1
fi

# Criar diretÃ³rio se nÃ£o existe
if [ ! -d ".github/instructions" ]; then
    echo "ğŸ“ Criando .github/instructions..."
    mkdir -p .github/instructions
fi

# Remover symlinks antigos/quebrados
echo "ğŸ—‘ï¸  Removendo symlinks antigos..."
rm -f .github/instructions/agent-skills-core.instructions.md
rm -f .github/instructions/agent-skills-project.instructions.md

# Criar novos symlinks com caminhos relativos
echo "ğŸ”— Criando symlinks corretos..."
ln -s ../../.copilot-core/instructions/agent-skills-core.instructions.md .github/instructions/agent-skills-core.instructions.md
ln -s ../../.copilot-project/instructions/agent-skills-project.instructions.md .github/instructions/agent-skills-project.instructions.md

echo "âœ… Symlinks criados com sucesso!"
echo ""
echo "VerificaÃ§Ã£o:"
ls -la .github/instructions/

# Testar se os symlinks estÃ£o acessÃ­veis
echo ""
echo "Testando acessibilidade:"
if [ -f ".github/instructions/agent-skills-core.instructions.md" ] && [ -f ".github/instructions/agent-skills-project.instructions.md" ]; then
    echo "âœ… Ambos os symlinks estÃ£o acessÃ­veis"
else
    echo "âš ï¸  Alguns symlinks podem nÃ£o estar acessÃ­veis:"
    [ -f ".github/instructions/agent-skills-core.instructions.md" ] && echo "   agent-skills-core.instructions.md: âœ…" || echo "   agent-skills-core.instructions.md: âŒ"
    [ -f ".github/instructions/agent-skills-project.instructions.md" ] && echo "   agent-skills-project.instructions.md: âœ…" || echo "   agent-skills-project.instructions.md: âŒ"
fi
