# Setup Instructions - Copilot Agent Skills
# Corrige symlinks quebrados em .github/instructions/
# Pode ser executado da raiz do projeto OU de dentro de .copilot-core/config/

# Detectar se estamos em .copilot-core/config e ajustar o diret√≥rio
$currentDir = Get-Location
if ($currentDir.Path -match '\.copilot-core\\config$') {
    Write-Host "üìç Detectado execu√ß√£o de dentro de .copilot-core/config" -ForegroundColor Yellow
    Write-Host "   Mudando para raiz do projeto..." -ForegroundColor Yellow
    Set-Location "../.."
}

Write-Host "üîß Corrigindo symlinks do Copilot Agent..." -ForegroundColor Cyan

# Verificar se estamos na raiz de um projeto com .copilot-core e .copilot-project
if (!(Test-Path ".copilot-core") -or !(Test-Path ".copilot-project")) {
    Write-Host "‚ùå Erro: .copilot-core ou .copilot-project n√£o encontrados" -ForegroundColor Red
    Write-Host "   Execute este script na raiz do projeto que cont√©m os submodules/clones" -ForegroundColor Yellow
    exit 1
}

# Verificar se os arquivos de destino existem
if (!(Test-Path ".copilot-core\instructions\agent-skills-core.instructions.md")) {
    Write-Host "‚ùå Erro: .copilot-core\instructions\agent-skills-core.instructions.md n√£o encontrado" -ForegroundColor Red
    exit 1
}

if (!(Test-Path ".copilot-project\instructions\agent-skills-project.instructions.md")) {
    Write-Host "‚ùå Erro: .copilot-project\instructions\agent-skills-project.instructions.md n√£o encontrado" -ForegroundColor Red
    exit 1
}

# Criar diret√≥rio se n√£o existe
if (!(Test-Path ".github\instructions")) {
    Write-Host "üìÅ Criando .github\instructions..." -ForegroundColor Yellow
    New-Item -ItemType Directory -Path ".github\instructions" -Force | Out-Null
}

# Remover symlinks antigos/quebrados
Write-Host "üóëÔ∏è  Removendo symlinks antigos..." -ForegroundColor Yellow
Remove-Item ".github\instructions\agent-skills-core.instructions.md" -Force -ErrorAction SilentlyContinue
Remove-Item ".github\instructions\agent-skills-project.instructions.md" -Force -ErrorAction SilentlyContinue

# Obter caminhos absolutos
$coreTarget = Resolve-Path ".copilot-core\instructions\agent-skills-core.instructions.md"
$projectTarget = Resolve-Path ".copilot-project\instructions\agent-skills-project.instructions.md"

# Criar novos symlinks
Write-Host "üîó Criando symlinks corretos..." -ForegroundColor Yellow

try {
    New-Item -ItemType SymbolicLink -Path ".github\instructions\agent-skills-core.instructions.md" -Target $coreTarget -Force | Out-Null
    New-Item -ItemType SymbolicLink -Path ".github\instructions\agent-skills-project.instructions.md" -Target $projectTarget -Force | Out-Null
    
    Write-Host "‚úÖ Symlinks criados com sucesso!" -ForegroundColor Green
    Write-Host ""
    Write-Host "Verifica√ß√£o:" -ForegroundColor Cyan
    Get-Item ".github\instructions\*" | Select-Object Name, LinkType, @{Name="Target";Expression={$_.Target}} | Format-Table -AutoSize
    
    # Testar se os symlinks est√£o acess√≠veis
    Write-Host ""
    Write-Host "Testando acessibilidade:" -ForegroundColor Cyan
    $coreOk = Test-Path ".github\instructions\agent-skills-core.instructions.md"
    $projectOk = Test-Path ".github\instructions\agent-skills-project.instructions.md"
    
    if ($coreOk -and $projectOk) {
        Write-Host "‚úÖ Ambos os symlinks est√£o acess√≠veis" -ForegroundColor Green
    } else {
        Write-Host "‚ö†Ô∏è  Alguns symlinks podem n√£o estar acess√≠veis:" -ForegroundColor Yellow
        Write-Host "   agent-skills-core.instructions.md: $(if($coreOk){'‚úÖ'}else{'‚ùå'})" -ForegroundColor $(if($coreOk){'Green'}else{'Red'})
        Write-Host "   agent-skills-project.instructions.md: $(if($projectOk){'‚úÖ'}else{'‚ùå'})" -ForegroundColor $(if($projectOk){'Green'}else{'Red'})
    }
    
} catch {
    Write-Host "‚ùå Erro ao criar symlinks: $_" -ForegroundColor Red
    Write-Host "   Certifique-se de executar o PowerShell como Administrador" -ForegroundColor Yellow
    exit 1
}
