#!/bin/bash
#
# Copilot Agent Skills - Setup Script
# Configura .copilot-core e .copilot-project como submodules
#
# Usage:
#   ./setup.sh [project-name]
#
# Remote execution:
#   curl -fsSL https://raw.githubusercontent.com/pdmartins/.copilot-core/main/scripts/setup.sh | bash
#   curl -fsSL https://raw.githubusercontent.com/pdmartins/.copilot-core/main/scripts/setup.sh | bash -s -- "meu-projeto"

set -e

# ============================================================
# Configuration
# ============================================================

CORE_URL="${COPILOT_CORE_URL:-https://github.com/pdmartins/.copilot-core.git}"
PROJECT_URL="${COPILOT_PROJECT_URL:-https://github.com/pdmartins/.copilot-project.git}"
PROJECT_NAME="${1:-}"
FORCE="${FORCE:-false}"

# ============================================================
# Colors
# ============================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ============================================================
# Helpers
# ============================================================

step() {
    echo -e "\n${CYAN}[*]${NC} $1"
}

success() {
    echo -e "${GREEN}[+]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

error() {
    echo -e "${RED}[X]${NC} $1"
}

is_git_repo() {
    [ -d ".git" ]
}

has_copilot_structure() {
    [ -d ".github/.copilot-core" ]
}

get_default_project_name() {
    basename "$(pwd)"
}

branch_exists_remote() {
    local branch="$1"
    git ls-remote --heads "$PROJECT_URL" "$branch" 2>/dev/null | grep -q "$branch"
}

# ============================================================
# Main
# ============================================================

echo ""
echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║       Copilot Agent Skills - Setup                        ║${NC}"
echo -e "${CYAN}║       github.com/pdmartins/.copilot-core                  ║${NC}"
echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"
echo ""

# 1. Check prerequisites
step "Verificando pré-requisitos..."

if ! command -v git &> /dev/null; then
    error "Git não está instalado ou não está no PATH."
    exit 1
fi

if ! is_git_repo; then
    warning "Diretório atual não é um repositório Git."
    read -p "Deseja inicializar? (S/n) " init_git
    if [[ "$init_git" != "n" && "$init_git" != "N" ]]; then
        git init
        success "Repositório Git inicializado."
    else
        error "Git é necessário para continuar."
        exit 1
    fi
fi

# 2. Check existing structure
if has_copilot_structure; then
    if [[ "$FORCE" != "true" ]]; then
        warning "Estrutura .github/.copilot-core já existe."
        read -p "Deseja sobrescrever? (s/N) " overwrite
        if [[ "$overwrite" != "s" && "$overwrite" != "S" ]]; then
            echo "Operação cancelada. Use FORCE=true para sobrescrever."
            exit 0
        fi
    fi
    step "Removendo estrutura existente..."
    rm -rf ".github/.copilot-core" 2>/dev/null || true
    rm -rf ".github/.copilot-project" 2>/dev/null || true
    git rm --cached ".github/.copilot-core" 2>/dev/null || true
    git rm --cached ".github/.copilot-project" 2>/dev/null || true
fi

# 3. Determine project name
if [ -z "$PROJECT_NAME" ]; then
    default_name=$(get_default_project_name)
    echo ""
    echo "Nome do projeto (branch para .copilot-project):"
    read -p "[$default_name] " PROJECT_NAME
    if [ -z "$PROJECT_NAME" ]; then
        PROJECT_NAME="$default_name"
    fi
fi

success "Projeto: $PROJECT_NAME"

# 4. Create .github directory
step "Criando estrutura de diretórios..."
mkdir -p ".github"

# 5. Add .copilot-core as submodule
step "Adicionando .copilot-core como submodule..."
git submodule add "$CORE_URL" ".github/.copilot-core"
success ".copilot-core adicionado."

# 6. Add .copilot-project as submodule
step "Adicionando .copilot-project como submodule..."

if branch_exists_remote "$PROJECT_NAME"; then
    success "Branch '$PROJECT_NAME' encontrada."
    git submodule add -b "$PROJECT_NAME" "$PROJECT_URL" ".github/.copilot-project"
else
    warning "Branch '$PROJECT_NAME' não existe. Criando nova branch..."
    git submodule add "$PROJECT_URL" ".github/.copilot-project"
    
    pushd ".github/.copilot-project" > /dev/null
    git checkout -b "$PROJECT_NAME"
    
    # Create initial structure
    step "Criando estrutura inicial do projeto..."
    
    # context/project.md
    mkdir -p "context"
    cat > "context/project.md" << EOF
# Contexto do Projeto: $PROJECT_NAME

## Status
- **Fase**: Inicial
- **Última atualização**: $(date +%Y-%m-%d)

## Resumo

> [Descreva brevemente o projeto aqui]

## Stack

- [ ] Definir stack técnica

## Arquitetura

> [Descreva a arquitetura quando definida]

## Próximos Passos

- [ ] Definir escopo do projeto
- [ ] Configurar ambiente de desenvolvimento
- [ ] Criar primeiras funcionalidades
EOF

    # memory/lessons-learned.md
    mkdir -p "memory"
    cat > "memory/lessons-learned.md" << EOF
# Lições Aprendidas - $PROJECT_NAME

## Sobre este arquivo

Este arquivo registra lições aprendidas durante o desenvolvimento do projeto.
O Copilot Agent consulta e atualiza este arquivo automaticamente.

---

## Lições

> Nenhuma lição registrada ainda.

EOF

    # skills/ (empty)
    mkdir -p "skills"
    
    # README.md
    cat > "README.md" << EOF
# Copilot Project - $PROJECT_NAME

Branch de configuração do Copilot Agent para o projeto **$PROJECT_NAME**.

## Estrutura

\`\`\`
.copilot-project/
├── context/
│   └── project.md          # Estado atual do projeto
├── memory/
│   └── lessons-learned.md  # Lições aprendidas
└── skills/                 # Skills específicas do projeto
\`\`\`

## Skills Disponíveis

| Skill | Descrição |
|-------|-----------|
| *nenhum ainda* | Crie skills específicos conforme necessário |

## Padrão

Este projeto segue o padrão [Agent Skills](https://agentskills.io).
EOF

    # Initial commit
    git add .
    git commit -m "feat: estrutura inicial do projeto $PROJECT_NAME"
    
    success "Estrutura criada e commitada."
    warning "Execute 'git push -u origin $PROJECT_NAME' para criar branch remota."
    
    popd > /dev/null
fi

success ".copilot-project adicionado."

# 7. Check .gitmodules
step "Verificando .gitmodules..."
if [ -f ".gitmodules" ]; then
    success ".gitmodules configurado automaticamente."
fi

# 8. Create/update instructions
step "Verificando instructions..."
mkdir -p ".github/instructions"

workspace_instructions=".github/.copilot-core/.github/instructions/workspace.instructions.md"
if [ -f "$workspace_instructions" ]; then
    dest_path=".github/instructions/workspace.instructions.md"
    if [ ! -f "$dest_path" ]; then
        cp "$workspace_instructions" "$dest_path"
        success "workspace.instructions.md copiado."
    fi
fi

# 9. Final summary
echo ""
echo -e "${GREEN}╔═══════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║       Setup Concluído!                                    ║${NC}"
echo -e "${GREEN}╚═══════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "  Estrutura criada:"
echo -e "    .github/"
echo -e "    ├── .copilot-core/      (submodule: main)"
echo -e "    ├── .copilot-project/   (submodule: $PROJECT_NAME)"
echo -e "    └── instructions/"
echo ""
echo -e "  Próximos passos:"
echo -e "    ${YELLOW}1. git add . && git commit -m 'feat: setup copilot agent'${NC}"
echo -e "    ${YELLOW}2. Edite .github/.copilot-project/context/project.md${NC}"
echo -e "    ${YELLOW}3. Comece a usar o Copilot Agent!${NC}"
echo ""
