#!/bin/bash
#
# Copilot Agent Skills - Plug
# Adiciona os submodules .copilot-core e .copilot-project ao projeto.
# Não configura nada — use o Copilot Chat para isso.
#
# One-liner:
#   curl -fsSL https://raw.githubusercontent.com/pdmartins/.copilot-core/main/.github/scripts/plug.sh | bash
#
# Com nome customizado:
#   curl -fsSL ... | bash -s -- "meu-projeto"

set -e

CORE_URL="${COPILOT_CORE_URL:-https://github.com/pdmartins/.copilot-core.git}"
PROJECT_URL="${COPILOT_PROJECT_URL:-https://github.com/pdmartins/.copilot-project.git}"
PROJECT_NAME="${1:-$(basename "$(pwd)")}"

G='\033[0;32m' C='\033[0;36m' Y='\033[1;33m' R='\033[0;31m' N='\033[0m'

echo ""
echo -e "  ${C}Copilot Agent Skills - Plug${N}"
echo ""

# --- Pré-requisitos ---

if ! command -v git &> /dev/null; then
    echo -e "  ${R}[X] Git nao encontrado.${N}"
    exit 1
fi

if [ ! -d ".git" ]; then
    echo -e "  ${Y}[!] Nao e um repositorio Git. Inicializando...${N}"
    git init > /dev/null 2>&1
fi

if [ -d ".github/.copilot-core" ]; then
    echo -e "  ${Y}[!] Submodules ja existem. Use 'git submodule update --remote' para atualizar.${N}"
    exit 0
fi

echo -e "  Projeto: ${PROJECT_NAME}"

# --- Plug submodules ---

echo -e "  ${C}[1/3] Adicionando .copilot-core...${N}"
mkdir -p ".github"
git submodule add "$CORE_URL" ".github/.copilot-core" > /dev/null 2>&1
echo -e "  ${G}[+] .copilot-core ok${N}"

echo -e "  ${C}[2/3] Adicionando .copilot-project...${N}"
if git ls-remote --heads "$PROJECT_URL" "$PROJECT_NAME" 2>/dev/null | grep -q "$PROJECT_NAME"; then
    git submodule add -b "$PROJECT_NAME" "$PROJECT_URL" ".github/.copilot-project" > /dev/null 2>&1
    echo -e "  ${G}[+] .copilot-project ok (branch existente: ${PROJECT_NAME})${N}"
else
    git submodule add "$PROJECT_URL" ".github/.copilot-project" > /dev/null 2>&1
    pushd ".github/.copilot-project" > /dev/null
    git checkout -b "$PROJECT_NAME" > /dev/null 2>&1
    popd > /dev/null
    echo -e "  ${G}[+] .copilot-project ok (branch nova: ${PROJECT_NAME})${N}"
fi

echo -e "  ${C}[3/3] Copiando instructions...${N}"
src=".github/.copilot-core/.github/instructions/workspace.instructions.md"
if [ -f "$src" ]; then
    mkdir -p ".github/instructions"
    cp "$src" ".github/instructions/workspace.instructions.md"
    echo -e "  ${G}[+] workspace.instructions.md copiado${N}"
fi

# --- Resultado ---

echo ""
echo -e "  ${G}Pronto!${N}"
echo ""
echo -e "  Proximo passo:"
echo -e "    ${Y}git add . && git commit -m 'feat: add copilot agent'${N}"
echo ""
echo -e "  Para configurar o projeto, abra o Copilot Chat e diga:"
echo -e "    ${Y}\"configure este projeto\"${N}"
echo ""
