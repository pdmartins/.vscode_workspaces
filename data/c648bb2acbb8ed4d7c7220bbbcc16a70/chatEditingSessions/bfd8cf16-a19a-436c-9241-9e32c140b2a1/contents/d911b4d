---
name: test-integration
description: Padrões para testes de integração e arquitetura com WebApplicationFactory e TestContainers. Use ao testar endpoints, repositórios com banco real, ou validar arquitetura. Triggers: teste integração, WebApplicationFactory, TestContainers, endpoint, pasta IntegrationTests/, ArchitectureTests/.
metadata:
  author: copilot-project
  version: "1.0"
  category: test
---

# Integration Testing Skill

Padrões para testes de integração e arquitetura em .NET.

## Quando Usar

- Testar endpoints da API
- Testar repositórios com banco real
- Testar consumers de mensageria
- Validar regras de arquitetura

## Estrutura

```
tests/
├── BeWiser.Assistant.IntegrationTests/
│   ├── Api/
│   │   ├── AssistantsEndpointTests.cs
│   │   └── MessagesEndpointTests.cs
│   ├── Persistence/
│   │   └── ConversationRepositoryTests.cs
│   └── Fixtures/
│       ├── CustomWebApplicationFactory.cs
│       └── DatabaseFixture.cs
│
└── BeWiser.Assistant.ArchitectureTests/
    └── ArchitectureTests.cs
```

## Nomenclatura

| Tipo | Padrão | Exemplo |
|------|--------|---------|
| Classe de Teste | `[Recurso]EndpointTests` | `AssistantsEndpointTests` |
| Método de Teste | `[Verbo]_[Cenário]_[Esperado]` | `Post_ValidRequest_ReturnsCreated` |
| Fixture | `[Domínio]Fixture` | `DatabaseFixture` |

## Templates

### Custom WebApplicationFactory

```csharp
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Mvc.Testing;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;

namespace BeWiser.Assistant.IntegrationTests.Fixtures;

/// <summary>
/// Custom factory for integration tests.
/// </summary>
public class CustomWebApplicationFactory : WebApplicationFactory<Program>
{
    private readonly DatabaseFixture _database;

    public CustomWebApplicationFactory(DatabaseFixture database)
    {
        _database = database;
    }

    protected override void ConfigureWebHost(IWebHostBuilder builder)
    {
        builder.ConfigureServices(services =>
        {
            // Remove real database configuration
            var descriptor = services.SingleOrDefault(
                d => d.ServiceType == typeof(IDbConnectionFactory));
            if (descriptor != null)
                services.Remove(descriptor);

            // Add test database
            services.AddSingleton<IDbConnectionFactory>(
                new TestConnectionFactory(_database.ConnectionString));

            // Replace external services
            services.AddSingleton<IWhatsAppService, FakeWhatsAppService>();
            services.AddSingleton<IAiService, FakeAiService>();
        });

        builder.UseEnvironment("Testing");
    }
}
```

### Database Fixture (TestContainers)

```csharp
using Testcontainers.MsSql;
using Xunit;

namespace BeWiser.Assistant.IntegrationTests.Fixtures;

/// <summary>
/// Fixture that manages a SQL Server container for tests.
/// </summary>
public class DatabaseFixture : IAsyncLifetime
{
    private readonly MsSqlContainer _container = new MsSqlBuilder()
        .WithImage("mcr.microsoft.com/mssql/server:2022-latest")
        .WithPassword("Strong_password_123!")
        .Build();

    public string ConnectionString => _container.GetConnectionString();

    public async Task InitializeAsync()
    {
        await _container.StartAsync();
        await MigrateDatabaseAsync();
    }

    public async Task DisposeAsync()
    {
        await _container.DisposeAsync();
    }

    private async Task MigrateDatabaseAsync()
    {
        // Apply migrations
        using var connection = new SqlConnection(ConnectionString);
        await connection.OpenAsync();
        
        // Run migration scripts or use EF migrations
    }
}

/// <summary>
/// Collection definition for database tests.
/// </summary>
[CollectionDefinition("Database")]
public class DatabaseCollection : ICollectionFixture<DatabaseFixture> { }
```

### Endpoint Tests

```csharp
using System.Net;
using System.Net.Http.Json;
using FluentAssertions;
using Xunit;

namespace BeWiser.Assistant.IntegrationTests.Api;

/// <summary>
/// Integration tests for Assistants endpoint.
/// </summary>
[Collection("Database")]
public class AssistantsEndpointTests : IClassFixture<CustomWebApplicationFactory>
{
    private readonly HttpClient _client;
    private readonly DatabaseFixture _database;

    public AssistantsEndpointTests(
        CustomWebApplicationFactory factory,
        DatabaseFixture database)
    {
        _database = database;
        _client = factory.CreateClient();
    }

    [Fact]
    public async Task Get_ExistingAssistant_ReturnsOk()
    {
        // Arrange
        var assistantId = await SeedAssistantAsync();

        // Act
        var response = await _client.GetAsync($"/api/assistants/{assistantId}");

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.OK);
        
        var assistant = await response.Content
            .ReadFromJsonAsync<GetAssistantResponse>();
        assistant.Should().NotBeNull();
        assistant!.Id.Should().Be(assistantId);
    }

    [Fact]
    public async Task Get_NonExistingAssistant_ReturnsNotFound()
    {
        // Act
        var response = await _client.GetAsync($"/api/assistants/{Guid.NewGuid()}");

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.NotFound);
    }

    [Fact]
    public async Task Post_ValidRequest_ReturnsCreated()
    {
        // Arrange
        var request = new CreateAssistantRequest
        {
            Name = "Test Assistant",
            PhoneNumber = "+5511999999999",
            SystemPrompt = "You are a helpful assistant."
        };

        // Act
        var response = await _client.PostAsJsonAsync("/api/assistants", request);

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.Created);
        response.Headers.Location.Should().NotBeNull();
        
        var created = await response.Content
            .ReadFromJsonAsync<CreateAssistantResponse>();
        created!.Name.Should().Be(request.Name);
    }

    [Fact]
    public async Task Post_InvalidRequest_ReturnsBadRequest()
    {
        // Arrange
        var request = new CreateAssistantRequest
        {
            Name = "", // Invalid
            PhoneNumber = "invalid",
            SystemPrompt = ""
        };

        // Act
        var response = await _client.PostAsJsonAsync("/api/assistants", request);

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.BadRequest);
    }

    [Fact]
    public async Task List_WithPagination_ReturnsPagedResults()
    {
        // Arrange
        await SeedMultipleAssistantsAsync(15);

        // Act
        var response = await _client.GetAsync("/api/assistants?page=2&pageSize=5");

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.OK);
        
        var result = await response.Content
            .ReadFromJsonAsync<ListAssistantsResponse>();
        result!.Items.Should().HaveCount(5);
        result.Page.Should().Be(2);
        result.TotalCount.Should().BeGreaterOrEqualTo(15);
    }

    private async Task<Guid> SeedAssistantAsync()
    {
        var id = Guid.NewGuid();
        using var connection = new SqlConnection(_database.ConnectionString);
        await connection.ExecuteAsync(
            "INSERT INTO Assistants (Id, Name, PhoneNumber, SystemPrompt, CreatedAt) VALUES (@Id, @Name, @PhoneNumber, @SystemPrompt, @CreatedAt)",
            new { Id = id, Name = "Test", PhoneNumber = "+5511999999999", SystemPrompt = "Test", CreatedAt = DateTime.UtcNow });
        return id;
    }

    private async Task SeedMultipleAssistantsAsync(int count)
    {
        // Seed multiple assistants
    }
}
```

### Repository Tests

```csharp
using FluentAssertions;
using Xunit;

namespace BeWiser.Assistant.IntegrationTests.Persistence;

/// <summary>
/// Integration tests for ConversationRepository.
/// </summary>
[Collection("Database")]
public class ConversationRepositoryTests
{
    private readonly DatabaseFixture _fixture;
    private readonly ConversationRepository _repository;

    public ConversationRepositoryTests(DatabaseFixture fixture)
    {
        _fixture = fixture;
        _repository = new ConversationRepository(
            new TestConnectionFactory(fixture.ConnectionString),
            Substitute.For<ILogger<ConversationRepository>>());
    }

    [Fact]
    public async Task AddAsync_ValidConversation_Persists()
    {
        // Arrange
        var conversation = new ConversationBuilder().Build();

        // Act
        await _repository.AddAsync(conversation);

        // Assert
        var retrieved = await _repository.GetByIdAsync(conversation.Id);
        retrieved.Should().NotBeNull();
        retrieved!.PhoneNumber.Value.Should().Be(conversation.PhoneNumber.Value);
    }

    [Fact]
    public async Task GetByPhoneNumberAsync_ExistingPhone_ReturnsConversation()
    {
        // Arrange
        var conversation = new ConversationBuilder()
            .WithPhoneNumber("+5511999999999")
            .Build();
        await _repository.AddAsync(conversation);

        // Act
        var result = await _repository.GetByPhoneNumberAsync("+5511999999999");

        // Assert
        result.Should().NotBeNull();
        result!.Id.Should().Be(conversation.Id);
    }

    [Fact]
    public async Task ListAsync_WithPagination_ReturnsCorrectPage()
    {
        // Arrange
        for (var i = 0; i < 10; i++)
        {
            await _repository.AddAsync(new ConversationBuilder().Build());
        }

        // Act
        var (items, totalCount) = await _repository.ListAsync(
            assistantId: null,
            page: 2,
            pageSize: 3);

        // Assert
        items.Should().HaveCount(3);
        totalCount.Should().BeGreaterOrEqualTo(10);
    }
}
```

## Architecture Tests

```csharp
using NetArchTest.Rules;
using FluentAssertions;
using Xunit;

namespace BeWiser.Assistant.ArchitectureTests;

/// <summary>
/// Tests to enforce architecture rules.
/// </summary>
public class ArchitectureTests
{
    private const string DomainNamespace = "BeWiser.Assistant.Domain";
    private const string ApplicationNamespace = "BeWiser.Assistant.Application";
    private const string InfrastructureNamespace = "BeWiser.Assistant.Infrastructure";
    private const string ApiNamespace = "BeWiser.Assistant.Api";

    [Fact]
    public void Domain_ShouldNotDependOn_Application()
    {
        var result = Types
            .InAssembly(typeof(Conversation).Assembly)
            .ShouldNot()
            .HaveDependencyOn(ApplicationNamespace)
            .GetResult();

        result.IsSuccessful.Should().BeTrue();
    }

    [Fact]
    public void Domain_ShouldNotDependOn_Infrastructure()
    {
        var result = Types
            .InAssembly(typeof(Conversation).Assembly)
            .ShouldNot()
            .HaveDependencyOn(InfrastructureNamespace)
            .GetResult();

        result.IsSuccessful.Should().BeTrue();
    }

    [Fact]
    public void Application_ShouldNotDependOn_Infrastructure()
    {
        var result = Types
            .InAssembly(typeof(ProcessMessageCommand).Assembly)
            .ShouldNot()
            .HaveDependencyOn(InfrastructureNamespace)
            .GetResult();

        result.IsSuccessful.Should().BeTrue();
    }

    [Fact]
    public void Application_ShouldNotDependOn_Api()
    {
        var result = Types
            .InAssembly(typeof(ProcessMessageCommand).Assembly)
            .ShouldNot()
            .HaveDependencyOn(ApiNamespace)
            .GetResult();

        result.IsSuccessful.Should().BeTrue();
    }

    [Fact]
    public void Handlers_ShouldHaveNameEndingWithHandler()
    {
        var result = Types
            .InAssembly(typeof(ProcessMessageCommandHandler).Assembly)
            .That()
            .ImplementInterface(typeof(IRequestHandler<,>))
            .Should()
            .HaveNameEndingWith("Handler")
            .GetResult();

        result.IsSuccessful.Should().BeTrue();
    }

    [Fact]
    public void Commands_ShouldBeInCommandsNamespace()
    {
        var result = Types
            .InAssembly(typeof(ProcessMessageCommand).Assembly)
            .That()
            .HaveNameEndingWith("Command")
            .And()
            .AreNotAbstract()
            .Should()
            .ResideInNamespaceContaining("Commands")
            .GetResult();

        result.IsSuccessful.Should().BeTrue();
    }

    [Fact]
    public void Queries_ShouldBeInQueriesNamespace()
    {
        var result = Types
            .InAssembly(typeof(GetConversationQuery).Assembly)
            .That()
            .HaveNameEndingWith("Query")
            .And()
            .AreNotAbstract()
            .Should()
            .ResideInNamespaceContaining("Queries")
            .GetResult();

        result.IsSuccessful.Should().BeTrue();
    }

    [Fact]
    public void Repositories_ShouldImplementInterface()
    {
        var result = Types
            .InAssembly(typeof(ConversationRepository).Assembly)
            .That()
            .HaveNameEndingWith("Repository")
            .And()
            .AreNotInterfaces()
            .Should()
            .ImplementInterface(typeof(IConversationRepository))
            .Or()
            .ImplementInterface(typeof(IMessageRepository))
            .GetResult();

        // Custom validation since NetArchTest doesn't support OR well
        result.IsSuccessful.Should().BeTrue();
    }
}
```

## Fake Services

```csharp
namespace BeWiser.Assistant.IntegrationTests.Fakes;

/// <summary>
/// Fake WhatsApp service for testing.
/// </summary>
public class FakeWhatsAppService : IWhatsAppService
{
    public List<(string Phone, string Message)> SentMessages { get; } = [];

    public Task<string> SendMessageAsync(
        string phoneNumber,
        string message,
        CancellationToken cancellationToken = default)
    {
        SentMessages.Add((phoneNumber, message));
        return Task.FromResult($"SM{Guid.NewGuid():N}");
    }

    public Task<string> SendTemplateAsync(
        string phoneNumber,
        string templateName,
        Dictionary<string, string> parameters,
        CancellationToken cancellationToken = default)
    {
        SentMessages.Add((phoneNumber, $"[Template: {templateName}]"));
        return Task.FromResult($"SM{Guid.NewGuid():N}");
    }
}

/// <summary>
/// Fake AI service for testing.
/// </summary>
public class FakeAiService : IAiService
{
    public string DefaultResponse { get; set; } = "This is a test response.";

    public Task<string> GenerateResponseAsync(
        Conversation conversation,
        CancellationToken cancellationToken = default)
    {
        return Task.FromResult(DefaultResponse);
    }

    public Task<string> GenerateResponseAsync(
        string systemPrompt,
        IReadOnlyList<ChatMessage> history,
        CancellationToken cancellationToken = default)
    {
        return Task.FromResult(DefaultResponse);
    }
}
```

## Checklist

- [ ] Projeto: `BeWiser.Assistant.IntegrationTests`
- [ ] Projeto: `BeWiser.Assistant.ArchitectureTests`
- [ ] TestContainers para banco de dados
- [ ] WebApplicationFactory customizada
- [ ] Fake services para dependências externas
- [ ] Collection para compartilhar fixtures
- [ ] Architecture tests com NetArchTest
- [ ] Cleanup de dados entre testes
