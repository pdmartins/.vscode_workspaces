````skill
---
name: agent-memory-sync
description: Sincroniza arquivos .md (lessons-learned, project.md, code-map) com o MCP memory-service (Cloudflare Vectorize) para busca sem√¢ntica. Fonte de verdade s√£o os .md ‚Äî o √≠ndice Cloudflare √© derivado e pode ser reconstru√≠do a qualquer momento. Triggers - sincronizar mem√≥ria, sync mcp, indexar, reindexar, atualizar √≠ndice sem√¢ntico, rebuild memory.
metadata:
  author: copilot-core
  version: "1.0"
  category: agent
  delegable: full
---

# Agent Memory Sync

Sincroniza arquivos .md com o MCP memory-service (`@doobidoo/mcp-memory-service`, backend Cloudflare) para habilitar busca sem√¢ntica h√≠brida (BM25 + vector).

## Princ√≠pio Fundamental

```
Fonte de verdade: arquivos .md no git
Cloudflare (Vectorize + D1): √≠ndice derivado, descart√°vel e reconstru√≠vel
```

**Nunca** escrever apenas no MCP sem atualizar o .md correspondente. O fluxo √© sempre: `.md` primeiro ‚Üí MCP sync depois.

## Quando Usar

- Ap√≥s `agent-memory-register` adicionar nova li√ß√£o (sync incremental)
- Ap√≥s `project-context-update` alterar project.md (sync incremental)
- Ap√≥s `project-codemap-update` alterar code-map (sync incremental)
- Sob demanda: "sincronizar mem√≥ria", "reindexar", "rebuild memory"
- Quando busca sem√¢ntica retorna resultados vazios/desatualizados

## Quando N√ÉO Usar

- Para consultar mem√≥ria (usar `agent-memory-query`)
- Para registrar li√ß√µes (usar `agent-memory-register` que chama sync automaticamente)
- Se o MCP memory-service n√£o estiver configurado em `.vscode/mcp.json`

## Pr√©-requisito

MCP memory-service configurado em `.vscode/mcp.json`:

```json
{
  "servers": {
    "memory": {
      "type": "stdio",
      "command": "python",
      "args": ["-m", "mcp_memory_service.server"],
      "env": {
        "MCP_MEMORY_STORAGE_BACKEND": "cloudflare",
        "CLOUDFLARE_API_TOKEN": "${env:CLOUDFLARE_API_TOKEN}",
        "CLOUDFLARE_ACCOUNT_ID": "${env:CLOUDFLARE_ACCOUNT_ID}",
        "CLOUDFLARE_VECTORIZE_INDEX": "mcp-memory-index",
        "CLOUDFLARE_D1_DATABASE_ID": "${env:CLOUDFLARE_D1_DATABASE_ID}"
      }
    }
  }
}
```

## Arquivos Sincronizados

| Arquivo | Entidades MCP | Tipo |
|---------|---------------|------|
| `.copilot-project/memory/lessons-learned.md` | Uma entidade por li√ß√£o | `lesson` |
| `.copilot-project/context/project.md` | Uma entidade por se√ß√£o | `context` |
| `.copilot-project/context/code-map/index.md` | Uma entidade por m√≥dulo | `codemap` |

## Workflow ‚Äî Sync Incremental

Usado ap√≥s adicionar/alterar um item espec√≠fico.

### 1. Identificar o que mudou

```
Input: { arquivo: "lessons-learned.md", sec√ß√£o: "nova li√ß√£o adicionada" }
```

### 2. Parsear o conte√∫do novo

Extrair a li√ß√£o/se√ß√£o que foi adicionada ou alterada.

### 3. Criar/atualizar entidade MCP

Usar as MCP tools do memory-service:

```
mcp_memory_create_entities({
  entities: [{
    name: "lesson-{id}",
    entityType: "lesson",
    observations: [
      "categoria: {categoria}",
      "data: {data}",
      "conte√∫do: {resumo da li√ß√£o}",
      "contexto: {contexto}",
      "decis√£o: {decis√£o tomada}",
      "tags: {tags}"
    ]
  }]
})
```

### 4. Criar rela√ß√µes (se aplic√°vel)

```
mcp_memory_create_relations({
  relations: [{
    from: "lesson-{id}",
    to: "project-{nome}",
    relationType: "applies_to"
  }]
})
```

## Workflow ‚Äî Sync Full (Rebuild)

Usado para reconstruir completamente o √≠ndice MCP a partir dos .md.

### 1. Limpar entidades existentes

```
# Listar todas as entidades e deletar
mcp_memory_search_nodes({ query: "*" })
# Para cada entidade encontrada:
mcp_memory_delete_entities({ entityNames: [...] })
```

### 2. Parsear todos os arquivos fonte

Para cada arquivo sincronizado:
- **lessons-learned.md**: Parsear cada bloco `### {id}` como uma li√ß√£o
- **project.md**: Parsear cada `## {se√ß√£o}` como um bloco de contexto
- **code-map/index.md**: Parsear cada m√≥dulo/componente como uma entrada

### 3. Criar todas as entidades

Batch create de todas as entidades parseadas.

### 4. Criar rela√ß√µes

Conectar li√ß√µes a projetos, m√≥dulos a contexto, etc.

### 5. Confirmar

```
‚úÖ Sync completo!

üìã Entidades criadas: {N}
  - Li√ß√µes: {X}
  - Contexto: {Y}
  - Codemap: {Z}
üîó Rela√ß√µes: {R}
‚òÅÔ∏è Backend: Cloudflare (Vectorize + D1)
```

## MCP Tools Dispon√≠veis

O `mcp-memory-service` exp√µe estas tools (quando configurado):

| Tool | Uso no Sync |
|------|------------|
| `create_entities` | Criar entidades a partir dos .md |
| `delete_entities` | Remover entidades obsoletas |
| `create_relations` | Conectar entidades entre si |
| `search_nodes` | Busca sem√¢ntica h√≠brida (BM25 + vector) |
| `open_nodes` | Abrir entidades espec√≠ficas por nome |
| `read_graph` | Ler o grafo completo |

## Tratamento de Erros

| Erro | A√ß√£o |
|------|------|
| MCP server n√£o dispon√≠vel | Reportar: "MCP memory-service n√£o est√° ativo. Verificar .vscode/mcp.json" |
| Cloudflare n√£o acess√≠vel | Verificar CLOUDFLARE_API_TOKEN e conectividade. √çndice √© criado automaticamente na primeira sincroniza√ß√£o |
| Entidade duplicada | Sobrescrever com dados atuais do .md |
| .md vazio/template | N√£o sincronizar ‚Äî reportar que n√£o h√° conte√∫do para indexar |

## Subagent Pattern

**Tipo**: `full` ‚Äî pode ser delegado integralmente.

### Prompt Exemplo

```
runSubagent({
  description: "Sync memory to MCP",
  prompt: "Leia .copilot-core/skills/agent/agent-memory-sync/SKILL.md. Execute sync {incremental|full}. Arquivo alterado: {path}. Conte√∫do novo: {conte√∫do}. Retorne: resumo do sync com contagem de entidades criadas/atualizadas."
})
```

````
