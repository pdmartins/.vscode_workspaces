{"version":2,"initialFileContents":[["file:///d%3A/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs","1be94e8"],["file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","3ebc1c4"],["file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/Models/IntentClassificationResult.cs","3d16aa6"]],"timeline":{"checkpoints":[{"checkpointId":"96b99012-27de-4761-a586-fdb62f92ca53","epoch":0,"label":"Initial State","description":"Starting point before any edits"},{"checkpointId":"9d56a66e-f5fd-4d4f-9b9f-dc026ca51ee3","requestId":"request_094a2f32-8e07-4ac8-ac57-6b4ef23d1d79","epoch":3,"label":"Request request_094a2f32-8e07-4ac8-ac57-6b4ef23d1d79"},{"checkpointId":"0c3655f4-e3df-4f0f-af8c-0cfd65574d4f","requestId":"request_5b1bb7f1-d7b3-437b-a5dc-252290a4cc37","epoch":4,"label":"Request request_5b1bb7f1-d7b3-437b-a5dc-252290a4cc37"},{"checkpointId":"5f40a14f-bbe7-4628-8806-e3732fff6281","requestId":"request_5b1bb7f1-d7b3-437b-a5dc-252290a4cc37","undoStopId":"26a88b94-8d80-4997-9ce2-9b721ee56504","epoch":5,"label":"Request request_5b1bb7f1-d7b3-437b-a5dc-252290a4cc37 - Stop 26a88b94-8d80-4997-9ce2-9b721ee56504"},{"checkpointId":"ea618ba7-5e4d-415a-a71c-a454e3991886","requestId":"request_5b1bb7f1-d7b3-437b-a5dc-252290a4cc37","undoStopId":"3f9d977c-1f64-4b47-bfa2-7e8126375a48","epoch":6,"label":"Request request_5b1bb7f1-d7b3-437b-a5dc-252290a4cc37 - Stop 3f9d977c-1f64-4b47-bfa2-7e8126375a48"},{"checkpointId":"55ca07a1-8a17-484c-a16b-10a645548d92","requestId":"request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13","epoch":12,"label":"Request request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13"},{"checkpointId":"8068db0c-730c-4cfc-a521-1cda69834060","requestId":"request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13","undoStopId":"a286e832-1ee8-4196-b430-f8906bd1328b","epoch":13,"label":"Request request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13 - Stop a286e832-1ee8-4196-b430-f8906bd1328b"},{"checkpointId":"c6572358-feb5-46a4-a1b8-413883516668","requestId":"request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13","undoStopId":"7ad1afea-577c-49d1-9cf9-59a827303f52","epoch":14,"label":"Request request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13 - Stop 7ad1afea-577c-49d1-9cf9-59a827303f52"},{"checkpointId":"b52e44b9-70f8-4983-ae9a-84235a024d7d","requestId":"request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13","undoStopId":"d375df80-43e4-4156-b470-36f7e1f81428","epoch":15,"label":"Request request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13 - Stop d375df80-43e4-4156-b470-36f7e1f81428"},{"checkpointId":"89d144e0-8645-4199-a6aa-4b4934d86df7","requestId":"request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13","undoStopId":"c4bb3142-6d52-4a9a-b1b7-cb1be0b25a3b","epoch":23,"label":"Request request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13 - Stop c4bb3142-6d52-4a9a-b1b7-cb1be0b25a3b"},{"checkpointId":"c8e943a2-ff05-4759-9d4d-f8b26993a4de","requestId":"request_24305da6-f817-4604-813d-1316b353f59e","epoch":25,"label":"Request request_24305da6-f817-4604-813d-1316b353f59e"},{"checkpointId":"d9a456f8-9447-4573-bdc4-e4495b9973f0","requestId":"request_24305da6-f817-4604-813d-1316b353f59e","undoStopId":"5439871d-34da-41f1-8410-e9a907bf0b60","epoch":26,"label":"Request request_24305da6-f817-4604-813d-1316b353f59e - Stop 5439871d-34da-41f1-8410-e9a907bf0b60"},{"checkpointId":"cb3dd3e5-0596-44d4-b911-2a6c165972b5","requestId":"request_24305da6-f817-4604-813d-1316b353f59e","undoStopId":"a1ef1cf7-8025-4375-89db-5fa2812476f8","epoch":27,"label":"Request request_24305da6-f817-4604-813d-1316b353f59e - Stop a1ef1cf7-8025-4375-89db-5fa2812476f8"}],"currentEpoch":32,"fileBaselines":[["file:///d%3A/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs::request_5b1bb7f1-d7b3-437b-a5dc-252290a4cc37",{"uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Infrastructure.OpenAI\\Prompts\\TextClassificationPrompt.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs","scheme":"file"},"requestId":"request_5b1bb7f1-d7b3-437b-a5dc-252290a4cc37","content":"namespace Sky.HubAI.Infrastructure.OpenAI.Prompts\r\n{\r\n    public static class TextClassificationPrompt\r\n    {\r\n        public static string GetSystemPrompt(double minMatchPercentage = 80) =>\r\n            @\"Você é um especialista em classificação de ações e produtos a partir de descrições textuais. Possui habilidade em interpretar textos com erros de grafia, identificar intenções implícitas e extrair informações estruturadas com precisão.\r\n\r\n# Task\r\n\r\nAnalisar descrições fornecidas em texto livre e classificar:\r\n(1) a ação a ser tomada para CADA produto mencionado (adição ou remoção);\r\n(2) Identificar o código de TODOS os produtos mencionados.\r\n\r\n# Context\r\n\r\nEste sistema processa solicitações de clientes que podem conter imprecisões ortográficas, palavras escritas em conjunto ou formatação irregular. A classificação precisa alimenta fluxos de trabalho operacionais, tornando a precisão crítica para o roteamento correto de tarefas e gestão de produtos.\r\n\r\n# Instructions\r\n\r\n## 1. Identificação de Produtos\r\n\r\nAnalise a descrição e identifique TODOS os produtos mencionados.\r\n\r\n**IMPORTANTE - Produtos podem estar listados de várias formas:**\r\n- Separados por `+` : \"\"PROMO SUPER 30D + DEG HBO 30D\"\"\r\n- Separados por `,` : \"\"HBO Max, Telecine, Premiere\"\"\r\n- Separados por `e`/`ou` : \"\"HBO e Telecine\"\"\r\n- Em texto corrido: \"\"incluir recarga PROMO SUPER 30D e também DEG HBO\"\"\r\n- Com valores/preços junto: \"\"PROMO SUPER 30D - R$ 89,91\"\"\r\n\r\n### Estratégia de Busca (OBRIGATÓRIA):\r\n\r\nQuando o texto contém termos que PODEM ser um produto único OU múltiplos produtos (ex: \"\"PROMO SUPER 30D + DEG HBO 30D\"\"), siga esta ordem:\r\n\r\n**Passo 1 - Buscar o texto completo/combinado primeiro:**\r\n- Faça `search_products` com o nome completo: ex: [\"\"PROMO SUPER 30D + DEG HBO 30D\"\", \"\"PROMO SUPER 30D DEG HBO 30D\"\"]\r\n- Avalie o percentual de acerto (%) retornado para cada resultado.\r\n\r\n**Passo 2 - Avaliar os resultados:**\r\n- Se encontrou um produto com acerto >= ##MIN_MATCH##%, use-o como produto ÚNICO (é um pacote/combo real no catálogo).\r\n- Se NÃO encontrou nenhum produto com acerto >= ##MIN_MATCH##%, trate como MÚLTIPLOS produtos separados.\r\n\r\n**Passo 3 - Se for múltiplos produtos, buscar cada um separadamente:**\r\n- Faça buscas separadas para cada componente:\r\n  - search_products([\"\"PROMO SUPER 30D\"\", \"\"PROMO SUPER\"\"])\r\n  - search_products([\"\"DEG HBO 30D\"\", \"\"DEG HBO\"\", \"\"DEGUSTAÇÃO HBO\"\"])\r\n- Para cada componente, escolha o produto com MAIOR percentual de acerto.\r\n\r\n### Uso do Percentual de Acerto (%)\r\n\r\nOs resultados de `search_products` incluem o percentual de acerto para cada produto.\r\n- **Sempre prefira o produto com maior percentual de acerto.**\r\n- Se dois produtos têm acerto similar (diferença < 5%), prefira o que tem nome mais próximo ao texto original.\r\n- O percentual indica quantas palavras do nome do produto foram encontradas na busca.\r\n\r\nExemplo de resultado:\r\n```\r\n- Código: 1-21D3Z3E | Nome: PROMO SUPER 30D + DEG HBO 30D | Acerto: 100%\r\n- Código: 1-20XSM69 | Nome: SUPER 30D FAIXA 3 | Acerto: 40%\r\n```\r\n→ Escolha o produto com 100% de acerto.\r\n\r\n## 2. Tratamento de Abreviações e Erros\r\n\r\n**Abreviações comuns que você deve expandir ao buscar:**\r\n- DEG = DEGUSTAÇÃO\r\n- PROMO = PROMOÇÃO ou PROMOCIONAL\r\n- 30D, 7D, 15D = 30 dias, 7 dias, 15 dias (período)\r\n- DEB/DEG = pode ser erro de digitação\r\n\r\n**Ao buscar, inclua variações:**\r\n- Termo original + termo expandido\r\n- Termos parciais do nome do produto\r\n- Combinações com e sem períodos (30D, 7D)\r\n\r\n## 3. Determinação da Ação\r\n\r\nPara CADA produto identificado, determine a ação correspondente:\r\n- `product-add`: inclusão, incluir, adicionar, ativar, ativação, liberação, reativação, pedido, destino, recarga\r\n- `product-remove`: cancelar, cancelamento, excluir, exclusão, retirada, origem, correção, duplicidade, remover\r\n- `none`: quando não for possível determinar a ação\r\n\r\n**Indicadores de ação no contexto:**\r\n- \"\"por favor incluir\"\" → product-add\r\n- \"\"ativar recarga\"\" → product-add\r\n- \"\"valor ficou liberado\"\" + \"\"incluir\"\" → product-add\r\n- \"\"cancelar\"\" → product-remove\r\n- \"\"retirar da grade\"\" → product-remove\r\n\r\n## 4. Tratamento de Valores e Preços\r\n\r\n**IGNORE valores monetários ao identificar produtos:**\r\n- \"\"R$ 89,91\"\", \"\"R  89,91\"\", \"\"89,91\"\" → não fazem parte do nome do produto\r\n- \"\"valor disponível: 129,80\"\" → contexto informativo, não é produto\r\n\r\n## 5. Múltiplos Produtos com Mesma Ação\r\n\r\nUm mesmo texto pode conter MÚLTIPLOS produtos com a MESMA ação.\r\n\r\n**Se a busca combinada NÃO encontrou match >= ##MIN_MATCH##%, retorne cada produto separadamente:**\r\nExemplo: \"\"incluir a recarga: PROMO SUPER 30D + DEG HBO 30D\"\" → busca combinada não encontrou match >= ##MIN_MATCH##% → 2 produtos separados, ambos com action=\"\"product-add\"\"\r\n\r\n**Cada produto separado DEVE ter sua própria entrada em classifiedProducts:**\r\n- `productName` deve conter o nome INDIVIDUAL do produto como mencionado no texto.\r\n- `productCode` deve ser o código do produto com MAIOR percentual de acerto na busca individual.\r\n\r\n**Se a busca combinada encontrou match >= ##MIN_MATCH##%, retorne como produto ÚNICO:**\r\nExemplo: \"\"PROMO SUPER 30D + DEG HBO 30D\"\" existe no catálogo com 100% → 1 produto com o código do catálogo.\r\n\r\n**CORRETO (quando separados - sem match combinado >= ##MIN_MATCH##%):**\r\n```json\r\n{\r\n  \"\"classifiedProducts\"\": [\r\n    { \"\"productCode\"\": \"\"código-promo-super\"\", \"\"productName\"\": \"\"PROMO SUPER 30D\"\", \"\"action\"\": \"\"product-add\"\" },\r\n    { \"\"productCode\"\": \"\"código-deg-hbo\"\", \"\"productName\"\": \"\"DEG HBO 30D\"\", \"\"action\"\": \"\"product-add\"\" }\r\n  ]\r\n}\r\n```\r\n\r\n**CORRETO (quando combinado - match combinado >= ##MIN_MATCH##%):**\r\n```json\r\n{\r\n  \"\"classifiedProducts\"\": [\r\n    { \"\"productCode\"\": \"\"código-combo\"\", \"\"productName\"\": \"\"PROMO SUPER 30D + DEG HBO 30D\"\", \"\"action\"\": \"\"product-add\"\" }\r\n  ]\r\n}\r\n```\r\n\r\n## 6. Formato de Resposta\r\n\r\nApós identificar todos os produtos e ações, retorne um objeto JSON.\r\n**Use o percentual de acerto (%) para decidir se o produto é combinado (>= ##MIN_MATCH##%) ou deve ser separado (< ##MIN_MATCH##%).**\r\n**Produtos mencionados no texto mas NÃO encontrados pelo search_products devem ser listados em unmatchedProducts.**\r\n\r\n```json\r\n{\r\n  \"\"classifiedProducts\"\": [\r\n    { \"\"productCode\"\": \"\"código1\"\", \"\"productName\"\": \"\"Nome do Produto 1\"\", \"\"action\"\": \"\"product-add\"\" },\r\n    { \"\"productCode\"\": \"\"código2\"\", \"\"productName\"\": \"\"Nome do Produto 2\"\", \"\"action\"\": \"\"product-add\"\" }\r\n  ],\r\n  \"\"unmatchedProducts\"\": [\"\"Nome do Produto Não Encontrado\"\"],\r\n  \"\"keywords\"\": [\"\"incluir\"\", \"\"recarga\"\"],\r\n  \"\"log\"\": \"\"Explicação do raciocínio usado\"\"\r\n}\r\n```\r\n\r\n## 7. Regras Importantes\r\n\r\n- O output final deve ser APENAS o JSON sem texto adicional.\r\n- Use múltiplas chamadas a `search_products` para encontrar cada produto.\r\n- Jamais invente códigos de produtos. Use apenas os retornados pela função search_products.\r\n- keywords deve conter as palavras-chave de ação encontradas no texto.\r\n- **Se não conseguir determinar a ação, use action=\"\"none\"\".**\r\n- **Se o produto não for encontrado pelo search_products, adicione-o em `unmatchedProducts` (apenas o nome) e NÃO o inclua em `classifiedProducts`.**\r\n- **Sempre use o produto com MAIOR percentual de acerto (%) na busca.**\r\n- **Para textos com `+`, `,`, `e`, `ou`: busque PRIMEIRO o texto combinado. Se acerto >= ##MIN_MATCH##%, retorne como produto único. Caso contrário, busque cada componente separadamente.**\r\n\r\n## 8. Retorno com Ação ou Produto Não Identificado\r\n\r\nQuando não for possível identificar a ação OU o produto:\r\n- Se o produto foi buscado via search_products e NÃO foi encontrado, adicione o nome do produto em `unmatchedProducts` e NÃO o inclua em `classifiedProducts`.\r\n- Se a ação não puder ser determinada mas o produto existe, use action=\"\"none\"\" em `classifiedProducts`.\r\n\r\n```json\r\n{\r\n  \"\"classifiedProducts\"\": [],\r\n  \"\"unmatchedProducts\"\": [\"\"Nome mencionado no texto\"\"],\r\n  \"\"keywords\"\": [],\r\n  \"\"log\"\": \"\"Produto não encontrado no catálogo\"\" \r\n}\r\n```\r\n\r\n## 9. Se Nenhum Produto For Mencionado no Texto\r\n\r\nSe o texto não mencionar nenhum produto, retorne:\r\n```json\r\n{\r\n  \"\"classifiedProducts\"\": [],\r\n  \"\"unmatchedProducts\"\": [],\r\n  \"\"keywords\"\": [],\r\n  \"\"log\"\": \"\"Nenhum produto mencionado no texto\"\"\r\n}\r\n```\".Replace(\"##MIN_MATCH##\", minMatchPercentage.ToString(\"0.#\"));\r\n    }\r\n}","epoch":7,"telemetryInfo":{}}],["file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs::request_5b1bb7f1-d7b3-437b-a5dc-252290a4cc37",{"uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Application\\UseCases\\Intent\\ClassifyIntent\\ClassifyIntentQueryHandler.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","scheme":"file"},"requestId":"request_5b1bb7f1-d7b3-437b-a5dc-252290a4cc37","content":"using MediatR;\r\nusing Microsoft.Extensions.Logging;\r\nusing Sky.HubAI.Application.Abstractions;\r\nusing Sky.HubAI.Application.Models;\r\nusing Sky.HubAI.Domain.Services.Interfaces;\r\nusing System.Collections.Generic;\r\nusing System.Linq;\r\nusing System.Threading;\r\nusing System.Threading.Tasks;\r\n\r\nnamespace Sky.HubAI.Application.UseCases.Intent.ClassifyIntent\r\n{\r\n    /// <summary>\r\n    /// Use case handler for classifying user intent from text descriptions.\r\n    /// Orchestrates: product search via function calling, calling AI service, normalizing results.\r\n    /// </summary>\r\n    public class ClassifyIntentQueryHandler : IRequestHandler<ClassifyIntentQuery, ClassifyIntentResult>\r\n    {\r\n        private readonly IOpenAiIntentClassifyService _openAiService;\r\n        private readonly IProductMemoryCacheService _productCache;\r\n        private readonly IProductMatchingService _productMatching;\r\n        private readonly ILogger<ClassifyIntentQueryHandler> _logger;\r\n\r\n        private const int TopCandidatesPerKeyword = 10;\r\n\r\n        public ClassifyIntentQueryHandler(\r\n            IOpenAiIntentClassifyService openAiService,\r\n            IProductMemoryCacheService productCache,\r\n            IProductMatchingService productMatching,\r\n            ILogger<ClassifyIntentQueryHandler> logger)\r\n        {\r\n            _openAiService = openAiService;\r\n            _productCache = productCache;\r\n            _productMatching = productMatching;\r\n            _logger = logger;\r\n        }\r\n\r\n        public async Task<ClassifyIntentResult> Handle(ClassifyIntentQuery request, CancellationToken cancellationToken)\r\n        {\r\n            _logger.LogInformation(\r\n                \"Iniciando análise de intenção. Descrição: {DescriptionLength} caracteres\",\r\n                request.Description?.Length ?? 0);\r\n\r\n            // 1. Buscar todos os produtos do cache (para uso na função de busca)\r\n            var allProducts = _productCache.GetAllProducts();\r\n            _logger.LogInformation(\"Produtos carregados do cache: {ProductCount}\", allProducts.Count);\r\n\r\n            // 2. Criar função de busca para function calling\r\n            // Esta função será chamada pela LLM quando precisar buscar produtos\r\n            IReadOnlyList<Domain.Entities.ProductMatchResult> SearchProducts(string[] keywords)\r\n            {\r\n                _logger.LogInformation(\"Function calling: buscando produtos com keywords: {Keywords}\", \r\n                    string.Join(\", \", keywords));\r\n\r\n                var results = new List<Domain.Entities.ProductMatchResult>();\r\n                foreach (var keyword in keywords)\r\n                {\r\n                    var matches = _productMatching.FindTopMatchingProductsWithScore(\r\n                        allProducts,\r\n                        keyword,\r\n                        TopCandidatesPerKeyword);\r\n                    \r\n                    // Adicionar apenas produtos não duplicados\r\n                    foreach (var match in matches)\r\n                    {\r\n                        if (!results.Any(r => r.Product.Code == match.Product.Code))\r\n                        {\r\n                            results.Add(match);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                _logger.LogInformation(\"Function calling: encontrados {Count} produtos únicos\", results.Count);\r\n                return results;\r\n            }\r\n\r\n            // 3. Chamar serviço de IA com function calling\r\n            var classificationResult = await _openAiService.ClassifyIntentAsync(\r\n                request.Description,\r\n                SearchProducts,\r\n                cancellationToken);\r\n\r\n            // 4. Normalizar ações de todos os produtos classificados (regra de aplicação)\r\n            var normalizedProducts = classificationResult.ClassifiedProducts\r\n                .Select(p => new ClassifiedProduct(\r\n                    p.ProductCode,\r\n                    p.ProductName,\r\n                    NormalizeAction(p.Action)))\r\n                .ToList();\r\n\r\n            // 5. Construir resultado final\r\n            var result = new ClassifyIntentResult(new IntentClassificationResult\r\n            {\r\n                Description = classificationResult.Description,\r\n                ClassifiedProducts = normalizedProducts,\r\n                Keywords = classificationResult.Keywords,\r\n                Log = classificationResult.Log,\r\n                PossibleProducts = classificationResult.PossibleProducts,\r\n                UnmatchedProducts = classificationResult.UnmatchedProducts,\r\n                SearchQueries = classificationResult.SearchQueries\r\n            });\r\n\r\n            _logger.LogInformation(\r\n                \"Classificação concluída. {ProductCount} produtos classificados. Primeiro: Action={Action}, ProductCode={ProductCode}\",\r\n                result.Data.ClassifiedProducts.Count,\r\n                result.Data.Action,\r\n                result.Data.ProductCode);\r\n\r\n            return result;\r\n        }\r\n\r\n        /// <summary>\r\n        /// Normalizes action names to standardized values.\r\n        /// Application-level business rule for consistency.\r\n        /// </summary>\r\n        private static string NormalizeAction(string action)\r\n        {\r\n            if (string.IsNullOrWhiteSpace(action))\r\n                return string.Empty;\r\n\r\n            var normalized = action.Trim().ToLowerInvariant();\r\n\r\n            // Mapeia ações conhecidas\r\n            return normalized switch\r\n            {\r\n                \"product-add\" or \"inclusão\" or \"incluir\" or \"adicionar\" or \"ativação\" or \"liberação\" => \"product-add\",\r\n                \"product-remove\" or \"cancelamento\" or \"cancelar\" or \"retirada\" or \"excluir\" or \"exclusão\" => \"product-remove\",\r\n                \"none\" => \"none\",\r\n                _ => string.Empty\r\n            };\r\n        }\r\n    }\r\n}","epoch":8,"telemetryInfo":{}}],["file:///d%3A/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs::request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13",{"uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Infrastructure.OpenAI\\Prompts\\TextClassificationPrompt.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs","scheme":"file"},"requestId":"request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13","content":"namespace Sky.HubAI.Infrastructure.OpenAI.Prompts\r\n{\r\n    public static class TextClassificationPrompt\r\n    {\r\n        public static string GetSystemPrompt(double minMatchPercentage = 80) =>\r\n            @\"Você é um especialista em classificação de ações e produtos a partir de descrições textuais. Possui habilidade em interpretar textos com erros de grafia, identificar intenções implícitas e extrair informações estruturadas com precisão.\r\n\r\n# Task\r\n\r\nAnalisar descrições fornecidas em texto livre e classificar:\r\n(1) a ação a ser tomada para CADA produto mencionado (adição ou remoção);\r\n(2) Identificar o código de TODOS os produtos mencionados.\r\n\r\n# Context\r\n\r\nEste sistema processa solicitações de clientes que podem conter imprecisões ortográficas, palavras escritas em conjunto ou formatação irregular. A classificação precisa alimenta fluxos de trabalho operacionais, tornando a precisão crítica para o roteamento correto de tarefas e gestão de produtos.\r\n\r\n# Instructions\r\n\r\n## 1. Identificação de Produtos\r\n\r\nAnalise a descrição e identifique TODOS os produtos mencionados.\r\n\r\n**IMPORTANTE - Produtos podem estar listados de várias formas:**\r\n- Separados por `+` : \"\"PROMO SUPER 30D + DEG HBO 30D\"\"\r\n- Separados por `,` : \"\"HBO Max, Telecine, Premiere\"\"\r\n- Separados por `e`/`ou` : \"\"HBO e Telecine\"\"\r\n- Em texto corrido: \"\"incluir recarga PROMO SUPER 30D e também DEG HBO\"\"\r\n- Com valores/preços junto: \"\"PROMO SUPER 30D - R$ 89,91\"\"\r\n\r\n### Estratégia de Busca (OBRIGATÓRIA):\r\n\r\nQuando o texto contém termos que PODEM ser um produto único OU múltiplos produtos (ex: \"\"PROMO SUPER 30D + DEG HBO 30D\"\"), siga esta ordem:\r\n\r\n**Passo 1 - Buscar o texto completo/combinado primeiro:**\r\n- Faça `search_products` com o nome completo: ex: [\"\"PROMO SUPER 30D + DEG HBO 30D\"\", \"\"PROMO SUPER 30D DEG HBO 30D\"\"]\r\n- Avalie o percentual de acerto (%) retornado para cada resultado.\r\n\r\n**Passo 2 - Avaliar os resultados:**\r\n- Se encontrou um produto com acerto >= ##MIN_MATCH##%, use-o como produto ÚNICO (é um pacote/combo real no catálogo).\r\n- Se NÃO encontrou nenhum produto com acerto >= ##MIN_MATCH##%, trate como MÚLTIPLOS produtos separados.\r\n\r\n**Passo 3 - Se for múltiplos produtos, buscar cada um separadamente:**\r\n- Faça buscas separadas para cada componente:\r\n  - search_products([\"\"PROMO SUPER 30D\"\", \"\"PROMO SUPER\"\"])\r\n  - search_products([\"\"DEG HBO 30D\"\", \"\"DEG HBO\"\", \"\"DEGUSTAÇÃO HBO\"\"])\r\n- Para cada componente, escolha o produto com MAIOR percentual de acerto.\r\n\r\n### Uso do Percentual de Acerto (%)\r\n\r\nOs resultados de `search_products` incluem o percentual de acerto para cada produto.\r\n- **Sempre prefira o produto com maior percentual de acerto.**\r\n- Se dois produtos têm acerto similar (diferença < 5%), prefira o que tem nome mais próximo ao texto original.\r\n- O percentual indica quantas palavras do nome do produto foram encontradas na busca.\r\n\r\nExemplo de resultado:\r\n```\r\n- Código: 1-21D3Z3E | Nome: PROMO SUPER 30D + DEG HBO 30D | Acerto: 100%\r\n- Código: 1-20XSM69 | Nome: SUPER 30D FAIXA 3 | Acerto: 40%\r\n```\r\n→ Escolha o produto com 100% de acerto.\r\n\r\n## 2. Tratamento de Abreviações e Erros\r\n\r\n**Abreviações comuns que você deve expandir ao buscar:**\r\n- DEG = DEGUSTAÇÃO\r\n- PROMO = PROMOÇÃO ou PROMOCIONAL\r\n- 30D, 7D, 15D = 30 dias, 7 dias, 15 dias (período)\r\n- DEB/DEG = pode ser erro de digitação\r\n\r\n**Ao buscar, inclua variações:**\r\n- Termo original + termo expandido\r\n- Termos parciais do nome do produto\r\n- Combinações com e sem períodos (30D, 7D)\r\n\r\n## 3. Determinação da Ação\r\n\r\nPara CADA produto identificado, determine a ação correspondente:\r\n- `product-add`: inclusão, incluir, adicionar, ativar, ativação, liberação, reativação, pedido, destino, recarga\r\n- `product-remove`: cancelar, cancelamento, excluir, exclusão, retirada, origem, correção, duplicidade, remover\r\n- `none`: quando não for possível determinar a ação, ou quando houver qualquer dúvida\r\n\r\n**REGRA CRÍTICA — Substituição / Troca de produtos:**\r\nQuando o texto indica que um produto será REMOVIDO para dar lugar a OUTRO (substituição, troca, migração), a ação de TODOS os produtos DEVE ser `none`. Um humano precisa avaliar esses casos.\r\n\r\n**Indicadores de substituição/troca (SEMPRE resultam em action=\"\"none\"\" para TODOS os produtos):**\r\n- trocar, troca, substituir, substituição, subistituir (erro de grafia)\r\n- migrar, migração, alterar pacote, mudar para, passar para\r\n- \"\"trocar o pacote para X\"\" → `none` (implica remover o atual + adicionar X)\r\n- \"\"substituir RECARGA X para RECARGA Y\"\" → `none` (remover X + adicionar Y)\r\n- \"\"não reconhece X, favor substituir para Y\"\" → `none`\r\n- \"\"migrar de pacote A para pacote B\"\" → `none`\r\n\r\n**Quando usar `product-add`:**\r\n- SOMENTE quando TODOS os produtos são puramente inclusões, sem nenhuma remoção implícita.\r\n- Exemplo: \"\"incluir HBO e Telecine\"\" → ambos `product-add`\r\n- Exemplo: \"\"ativar recarga PROMO SUPER 30D\"\" → `product-add`\r\n\r\n**Quando usar `product-remove`:**\r\n- SOMENTE quando TODOS os produtos são puramente exclusões, sem nenhuma inclusão implícita.\r\n- Exemplo: \"\"cancelar HBO e Telecine\"\" → ambos `product-remove`\r\n\r\n**Quando usar `none`:**\r\n- Quando o texto indica troca/substituição (remove um e adiciona outro)\r\n- Quando há QUALQUER dúvida, por menor que seja, sobre a ação\r\n- Quando o texto mistura ações de inclusão e exclusão\r\n- Quando não é possível determinar a ação com certeza\r\n\r\n**Indicadores de ação no contexto (apenas para ações puras, sem troca):**\r\n- \"\"por favor incluir\"\" → product-add\r\n- \"\"ativar recarga\"\" → product-add\r\n- \"\"valor ficou liberado\"\" + \"\"incluir\"\" → product-add\r\n- \"\"cancelar\"\" → product-remove\r\n- \"\"retirar da grade\"\" → product-remove\r\n\r\n## 4. Tratamento de Valores e Preços\r\n\r\n**IGNORE valores monetários ao identificar produtos:**\r\n- \"\"R$ 89,91\"\", \"\"R  89,91\"\", \"\"89,91\"\" → não fazem parte do nome do produto\r\n- \"\"valor disponível: 129,80\"\" → contexto informativo, não é produto\r\n\r\n## 5. Múltiplos Produtos com Mesma Ação\r\n\r\nUm mesmo texto pode conter MÚLTIPLOS produtos com a MESMA ação.\r\n\r\n**Se a busca combinada NÃO encontrou match >= ##MIN_MATCH##%, retorne cada produto separadamente:**\r\nExemplo: \"\"incluir a recarga: PROMO SUPER 30D + DEG HBO 30D\"\" → busca combinada não encontrou match >= ##MIN_MATCH##% → 2 produtos separados, ambos com action=\"\"product-add\"\"\r\n\r\n**Cada produto separado DEVE ter sua própria entrada em classifiedProducts:**\r\n- `productName` deve conter o nome INDIVIDUAL do produto como mencionado no texto.\r\n- `productCode` deve ser o código do produto com MAIOR percentual de acerto na busca individual.\r\n\r\n**Se a busca combinada encontrou match >= ##MIN_MATCH##%, retorne como produto ÚNICO:**\r\nExemplo: \"\"PROMO SUPER 30D + DEG HBO 30D\"\" existe no catálogo com 100% → 1 produto com o código do catálogo.\r\n\r\n**CORRETO (quando separados - sem match combinado >= ##MIN_MATCH##%):**\r\n```json\r\n{\r\n  \"\"classifiedProducts\"\": [\r\n    { \"\"productCode\"\": \"\"código-promo-super\"\", \"\"productName\"\": \"\"PROMO SUPER 30D\"\", \"\"action\"\": \"\"product-add\"\" },\r\n    { \"\"productCode\"\": \"\"código-deg-hbo\"\", \"\"productName\"\": \"\"DEG HBO 30D\"\", \"\"action\"\": \"\"product-add\"\" }\r\n  ]\r\n}\r\n```\r\n\r\n**CORRETO (quando combinado - match combinado >= ##MIN_MATCH##%):**\r\n```json\r\n{\r\n  \"\"classifiedProducts\"\": [\r\n    { \"\"productCode\"\": \"\"código-combo\"\", \"\"productName\"\": \"\"PROMO SUPER 30D + DEG HBO 30D\"\", \"\"action\"\": \"\"product-add\"\" }\r\n  ]\r\n}\r\n```\r\n\r\n## 6. Formato de Resposta\r\n\r\nApós identificar todos os produtos e ações, retorne um objeto JSON.\r\n**Use o percentual de acerto (%) para decidir se o produto é combinado (>= ##MIN_MATCH##%) ou deve ser separado (< ##MIN_MATCH##%).**\r\n**Produtos mencionados no texto mas NÃO encontrados pelo search_products devem ser listados em unmatchedProducts.**\r\n\r\n```json\r\n{\r\n  \"\"classifiedProducts\"\": [\r\n    { \"\"productCode\"\": \"\"código1\"\", \"\"productName\"\": \"\"Nome do Produto 1\"\", \"\"action\"\": \"\"product-add\"\" },\r\n    { \"\"productCode\"\": \"\"código2\"\", \"\"productName\"\": \"\"Nome do Produto 2\"\", \"\"action\"\": \"\"product-add\"\" }\r\n  ],\r\n  \"\"unmatchedProducts\"\": [\"\"Nome do Produto Não Encontrado\"\"],\r\n  \"\"keywords\"\": [\"\"incluir\"\", \"\"recarga\"\"],\r\n  \"\"log\"\": \"\"Explicação do raciocínio usado\"\"\r\n}\r\n```\r\n\r\n## 7. Regras Importantes\r\n\r\n- O output final deve ser APENAS o JSON sem texto adicional.\r\n- Use múltiplas chamadas a `search_products` para encontrar cada produto.\r\n- Jamais invente códigos de produtos. Use apenas os retornados pela função search_products.\r\n- keywords deve conter as palavras-chave de ação encontradas no texto.\r\n- **Se não conseguir determinar a ação, use action=\"\"none\"\".**\r\n- **Se o produto não for encontrado pelo search_products, adicione-o em `unmatchedProducts` (apenas o nome) e NÃO o inclua em `classifiedProducts`.**\r\n- **Sempre use o produto com MAIOR percentual de acerto (%) na busca.**\r\n- **Para textos com `+`, `,`, `e`, `ou`: busque PRIMEIRO o texto combinado. Se acerto >= ##MIN_MATCH##%, retorne como produto único. Caso contrário, busque cada componente separadamente.**\r\n\r\n## 8. Retorno com Ação ou Produto Não Identificado\r\n\r\nQuando não for possível identificar a ação OU o produto:\r\n- Se o produto foi buscado via search_products e NÃO foi encontrado, adicione o nome do produto em `unmatchedProducts` e NÃO o inclua em `classifiedProducts`.\r\n- Se a ação não puder ser determinada mas o produto existe, use action=\"\"none\"\" em `classifiedProducts`.\r\n\r\n```json\r\n{\r\n  \"\"classifiedProducts\"\": [],\r\n  \"\"unmatchedProducts\"\": [\"\"Nome mencionado no texto\"\"],\r\n  \"\"keywords\"\": [],\r\n  \"\"log\"\": \"\"Produto não encontrado no catálogo\"\" \r\n}\r\n```\r\n\r\n## 9. Se Nenhum Produto For Mencionado no Texto\r\n\r\nSe o texto não mencionar nenhum produto, retorne:\r\n```json\r\n{\r\n  \"\"classifiedProducts\"\": [],\r\n  \"\"unmatchedProducts\"\": [],\r\n  \"\"keywords\"\": [],\r\n  \"\"log\"\": \"\"Nenhum produto mencionado no texto\"\"\r\n}\r\n```\".Replace(\"##MIN_MATCH##\", minMatchPercentage.ToString(\"0.#\"));\r\n    }\r\n}","epoch":16,"telemetryInfo":{}}],["file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs::request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13",{"uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Application\\UseCases\\Intent\\ClassifyIntent\\ClassifyIntentQueryHandler.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","scheme":"file"},"requestId":"request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13","content":"using MediatR;\r\nusing Microsoft.Extensions.Logging;\r\nusing Sky.HubAI.Application.Abstractions;\r\nusing Sky.HubAI.Application.Models;\r\nusing Sky.HubAI.Domain.Services.Interfaces;\r\nusing System.Collections.Generic;\r\nusing System.Linq;\r\nusing System.Threading;\r\nusing System.Threading.Tasks;\r\n\r\nnamespace Sky.HubAI.Application.UseCases.Intent.ClassifyIntent\r\n{\r\n    /// <summary>\r\n    /// Use case handler for classifying user intent from text descriptions.\r\n    /// Orchestrates: product search via function calling, calling AI service, normalizing results.\r\n    /// </summary>\r\n    public class ClassifyIntentQueryHandler : IRequestHandler<ClassifyIntentQuery, ClassifyIntentResult>\r\n    {\r\n        private readonly IOpenAiIntentClassifyService _openAiService;\r\n        private readonly IProductMemoryCacheService _productCache;\r\n        private readonly IProductMatchingService _productMatching;\r\n        private readonly ILogger<ClassifyIntentQueryHandler> _logger;\r\n\r\n        private const int TopCandidatesPerKeyword = 10;\r\n\r\n        public ClassifyIntentQueryHandler(\r\n            IOpenAiIntentClassifyService openAiService,\r\n            IProductMemoryCacheService productCache,\r\n            IProductMatchingService productMatching,\r\n            ILogger<ClassifyIntentQueryHandler> logger)\r\n        {\r\n            _openAiService = openAiService;\r\n            _productCache = productCache;\r\n            _productMatching = productMatching;\r\n            _logger = logger;\r\n        }\r\n\r\n        public async Task<ClassifyIntentResult> Handle(ClassifyIntentQuery request, CancellationToken cancellationToken)\r\n        {\r\n            _logger.LogInformation(\r\n                \"Iniciando análise de intenção. Descrição: {DescriptionLength} caracteres\",\r\n                request.Description?.Length ?? 0);\r\n\r\n            // 1. Buscar todos os produtos do cache (para uso na função de busca)\r\n            var allProducts = _productCache.GetAllProducts();\r\n            _logger.LogInformation(\"Produtos carregados do cache: {ProductCount}\", allProducts.Count);\r\n\r\n            // 2. Criar função de busca para function calling\r\n            // Esta função será chamada pela LLM quando precisar buscar produtos\r\n            IReadOnlyList<Domain.Entities.ProductMatchResult> SearchProducts(string[] keywords)\r\n            {\r\n                _logger.LogInformation(\"Function calling: buscando produtos com keywords: {Keywords}\", \r\n                    string.Join(\", \", keywords));\r\n\r\n                var results = new List<Domain.Entities.ProductMatchResult>();\r\n                foreach (var keyword in keywords)\r\n                {\r\n                    var matches = _productMatching.FindTopMatchingProductsWithScore(\r\n                        allProducts,\r\n                        keyword,\r\n                        TopCandidatesPerKeyword);\r\n                    \r\n                    // Adicionar apenas produtos não duplicados\r\n                    foreach (var match in matches)\r\n                    {\r\n                        if (!results.Any(r => r.Product.Code == match.Product.Code))\r\n                        {\r\n                            results.Add(match);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                _logger.LogInformation(\"Function calling: encontrados {Count} produtos únicos\", results.Count);\r\n                return results;\r\n            }\r\n\r\n            // 3. Chamar serviço de IA com function calling\r\n            var classificationResult = await _openAiService.ClassifyIntentAsync(\r\n                request.Description,\r\n                SearchProducts,\r\n                cancellationToken);\r\n\r\n            // 4. Normalizar ações de todos os produtos classificados (regra de aplicação)\r\n            var normalizedProducts = classificationResult.ClassifiedProducts\r\n                .Select(p => new ClassifiedProduct(\r\n                    p.ProductCode,\r\n                    p.ProductName,\r\n                    NormalizeAction(p.Action)))\r\n                .ToList();\r\n\r\n            // 4.1 Safety net: se há ações mistas (product-add + product-remove), forçar todas para \"none\"\r\n            normalizedProducts = ApplyMixedActionSafetyNet(normalizedProducts);\r\n\r\n            // 5. Construir resultado final\r\n            var result = new ClassifyIntentResult(new IntentClassificationResult\r\n            {\r\n                Description = classificationResult.Description,\r\n                ClassifiedProducts = normalizedProducts,\r\n                Keywords = classificationResult.Keywords,\r\n                Log = classificationResult.Log,\r\n                PossibleProducts = classificationResult.PossibleProducts,\r\n                UnmatchedProducts = classificationResult.UnmatchedProducts,\r\n                SearchQueries = classificationResult.SearchQueries\r\n            });\r\n\r\n            _logger.LogInformation(\r\n                \"Classificação concluída. {ProductCount} produtos classificados. Primeiro: Action={Action}, ProductCode={ProductCode}\",\r\n                result.Data.ClassifiedProducts.Count,\r\n                result.Data.Action,\r\n                result.Data.ProductCode);\r\n\r\n            return result;\r\n        }\r\n\r\n        /// <summary>\r\n        /// Safety net: when classified products contain mixed actions (both product-add and product-remove),\r\n        /// overrides ALL actions to \"none\" so a human can evaluate the case.\r\n        /// This catches substitution/swap scenarios that the LLM may have missed.\r\n        /// </summary>\r\n        private List<ClassifiedProduct> ApplyMixedActionSafetyNet(List<ClassifiedProduct> products)\r\n        {\r\n            if (products.Count == 0)\r\n                return products;\r\n\r\n            var distinctActions = products\r\n                .Select(p => p.Action)\r\n                .Where(a => a == \"product-add\" || a == \"product-remove\")\r\n                .Distinct()\r\n                .ToList();\r\n\r\n            if (distinctActions.Count > 1)\r\n            {\r\n                _logger.LogWarning(\r\n                    \"Mixed actions detected (product-add + product-remove). Overriding all actions to 'none' for human review.\");\r\n\r\n                return products\r\n                    .Select(p => new ClassifiedProduct(p.ProductCode, p.ProductName, \"none\"))\r\n                    .ToList();\r\n            }\r\n\r\n            return products;\r\n        }\r\n\r\n        /// <summary>\r\n        /// Normalizes action names to standardized values.\r\n        /// Application-level business rule for consistency.\r\n        /// </summary>\r\n        private static string NormalizeAction(string action)\r\n        {\r\n            if (string.IsNullOrWhiteSpace(action))\r\n                return string.Empty;\r\n\r\n            var normalized = action.Trim().ToLowerInvariant();\r\n\r\n            // Mapeia ações conhecidas\r\n            return normalized switch\r\n            {\r\n                \"product-add\" or \"inclusão\" or \"incluir\" or \"adicionar\" or \"ativação\" or \"liberação\" => \"product-add\",\r\n                \"product-remove\" or \"cancelamento\" or \"cancelar\" or \"retirada\" or \"excluir\" or \"exclusão\" => \"product-remove\",\r\n                \"none\" => \"none\",\r\n                _ => string.Empty\r\n            };\r\n        }\r\n    }\r\n}","epoch":17,"telemetryInfo":{}}],["file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/Models/IntentClassificationResult.cs::request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13",{"uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Application\\Models\\IntentClassificationResult.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/Models/IntentClassificationResult.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Application/Models/IntentClassificationResult.cs","scheme":"file"},"requestId":"request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13","content":"using System.Collections.Generic;\r\nusing System.Linq;\r\n\r\nnamespace Sky.HubAI.Application.Models\r\n{\r\n    /// <summary>\r\n    /// Strongly-typed result from intent classification operation.\r\n    /// Represents the analyzed intents for multiple products and supporting metadata.\r\n    /// </summary>\r\n    public record IntentClassificationResult\r\n    {\r\n        /// <summary>\r\n        /// Original description text that was analyzed.\r\n        /// </summary>\r\n        public string Description { get; init; } = string.Empty;\r\n\r\n        /// <summary>\r\n        /// List of classified products with their respective actions.\r\n        /// Each product identified in the description has its own action (product-add, product-remove, none).\r\n        /// </summary>\r\n        public IReadOnlyList<ClassifiedProduct> ClassifiedProducts { get; init; } = new List<ClassifiedProduct>();\r\n\r\n        /// <summary>\r\n        /// Identified action/intent for the first classified product.\r\n        /// Maintained for backward compatibility. Use ClassifiedProducts for multiple products.\r\n        /// </summary>\r\n        public string Action => ClassifiedProducts.FirstOrDefault()?.Action ?? string.Empty;\r\n\r\n        /// <summary>\r\n        /// Comma-separated list of product descriptions/names from all classified products.\r\n        /// </summary>\r\n        public string ProductDescription => string.Join(\", \", ClassifiedProducts.Select(p => p.ProductName));\r\n\r\n        /// <summary>\r\n        /// Comma-separated list of product codes from all classified products.\r\n        /// </summary>\r\n        public string ProductCode => string.Join(\", \", ClassifiedProducts.Select(p => p.ProductCode));\r\n\r\n        /// <summary>\r\n        /// List of keywords extracted from the description.\r\n        /// </summary>\r\n        public IReadOnlyList<string> Keywords { get; init; } = new List<string>();\r\n\r\n        /// <summary>\r\n        /// Diagnostic log or reasoning from the AI analysis.\r\n        /// </summary>\r\n        public string Log { get; init; } = string.Empty;\r\n\r\n        /// <summary>\r\n        /// List of candidate products that were considered during matching.\r\n        /// Each entry contains product code and name.\r\n        /// </summary>\r\n        public IReadOnlyList<ProductCandidate> PossibleProducts { get; init; } = new List<ProductCandidate>();\r\n\r\n        /// <summary>\r\n        /// List of product names from classified products.\r\n        /// Derived automatically from ClassifiedProducts.\r\n        /// </summary>\r\n        public IReadOnlyList<string> MatchedProducts => ClassifiedProducts\r\n            .Select(p => p.ProductName)\r\n            .Where(name => !string.IsNullOrWhiteSpace(name))\r\n            .Distinct()\r\n            .ToList();\r\n\r\n        /// <summary>\r\n        /// List of product names mentioned in the description that could not be matched to any product in the catalog.\r\n        /// </summary>\r\n        public IReadOnlyList<string> UnmatchedProducts { get; init; } = new List<string>();\r\n\r\n        /// <summary>\r\n        /// List of product search queries made by the LLM during function calling.\r\n        /// Contains the keywords searched and the products returned for each query.\r\n        /// </summary>\r\n        public IReadOnlyList<ProductSearchQuery> SearchQueries { get; init; } = new List<ProductSearchQuery>();\r\n    }\r\n\r\n    /// <summary>\r\n    /// Represents a product that was classified with its identified action.\r\n    /// </summary>\r\n    public record ClassifiedProduct(\r\n        string ProductCode,\r\n        string ProductName,\r\n        string Action);\r\n\r\n    /// <summary>\r\n    /// Represents a candidate product during matching.\r\n    /// </summary>\r\n    public record ProductCandidate(\r\n        string ProductCode,\r\n        string ProductName,\r\n        double MatchPercentage);\r\n\r\n    /// <summary>\r\n    /// Represents a product search query made by the LLM.\r\n    /// Contains the keywords that were searched and the products that were returned.\r\n    /// </summary>\r\n    public record ProductSearchQuery(\r\n        IReadOnlyList<string> Keywords,\r\n        IReadOnlyList<ProductCandidate> ProductsReturned);\r\n\r\n}","epoch":18,"telemetryInfo":{}}],["file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs::request_24305da6-f817-4604-813d-1316b353f59e",{"uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Application\\UseCases\\Intent\\ClassifyIntent\\ClassifyIntentQueryHandler.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","scheme":"file"},"requestId":"request_24305da6-f817-4604-813d-1316b353f59e","content":"using MediatR;\r\nusing Microsoft.Extensions.Logging;\r\nusing Sky.HubAI.Application.Abstractions;\r\nusing Sky.HubAI.Application.Models;\r\nusing Sky.HubAI.Domain.Services.Interfaces;\r\nusing System.Collections.Generic;\r\nusing System.Linq;\r\nusing System.Threading;\r\nusing System.Threading.Tasks;\r\n\r\nnamespace Sky.HubAI.Application.UseCases.Intent.ClassifyIntent\r\n{\r\n    /// <summary>\r\n    /// Use case handler for classifying user intent from text descriptions.\r\n    /// Orchestrates: product search via function calling, calling AI service, normalizing results.\r\n    /// </summary>\r\n    public class ClassifyIntentQueryHandler : IRequestHandler<ClassifyIntentQuery, ClassifyIntentResult>\r\n    {\r\n        private readonly IOpenAiIntentClassifyService _openAiService;\r\n        private readonly IProductMemoryCacheService _productCache;\r\n        private readonly IProductMatchingService _productMatching;\r\n        private readonly ILogger<ClassifyIntentQueryHandler> _logger;\r\n\r\n        private const int TopCandidatesPerKeyword = 10;\r\n\r\n        public ClassifyIntentQueryHandler(\r\n            IOpenAiIntentClassifyService openAiService,\r\n            IProductMemoryCacheService productCache,\r\n            IProductMatchingService productMatching,\r\n            ILogger<ClassifyIntentQueryHandler> logger)\r\n        {\r\n            _openAiService = openAiService;\r\n            _productCache = productCache;\r\n            _productMatching = productMatching;\r\n            _logger = logger;\r\n        }\r\n\r\n        public async Task<ClassifyIntentResult> Handle(ClassifyIntentQuery request, CancellationToken cancellationToken)\r\n        {\r\n            _logger.LogInformation(\r\n                \"Iniciando análise de intenção. Descrição: {DescriptionLength} caracteres\",\r\n                request.Description?.Length ?? 0);\r\n\r\n            // 1. Buscar todos os produtos do cache (para uso na função de busca)\r\n            var allProducts = _productCache.GetAllProducts();\r\n            _logger.LogInformation(\"Produtos carregados do cache: {ProductCount}\", allProducts.Count);\r\n\r\n            // 2. Criar função de busca para function calling\r\n            // Esta função será chamada pela LLM quando precisar buscar produtos\r\n            IReadOnlyList<Domain.Entities.ProductMatchResult> SearchProducts(string[] keywords)\r\n            {\r\n                _logger.LogInformation(\"Function calling: buscando produtos com keywords: {Keywords}\", \r\n                    string.Join(\", \", keywords));\r\n\r\n                var results = new List<Domain.Entities.ProductMatchResult>();\r\n                foreach (var keyword in keywords)\r\n                {\r\n                    var matches = _productMatching.FindTopMatchingProductsWithScore(\r\n                        allProducts,\r\n                        keyword,\r\n                        TopCandidatesPerKeyword);\r\n                    \r\n                    // Adicionar apenas produtos não duplicados\r\n                    foreach (var match in matches)\r\n                    {\r\n                        if (!results.Any(r => r.Product.Code == match.Product.Code))\r\n                        {\r\n                            results.Add(match);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                _logger.LogInformation(\"Function calling: encontrados {Count} produtos únicos\", results.Count);\r\n                return results;\r\n            }\r\n\r\n            // 3. Chamar serviço de IA com function calling\r\n            var classificationResult = await _openAiService.ClassifyIntentAsync(\r\n                request.Description,\r\n                SearchProducts,\r\n                cancellationToken);\r\n\r\n            // 4. Normalizar ações de todos os produtos classificados (regra de aplicação)\r\n            var normalizedProducts = classificationResult.ClassifiedProducts\r\n                .Select(p => new ClassifiedProduct(\r\n                    p.ProductCode,\r\n                    p.ProductName,\r\n                    NormalizeAction(p.Action)))\r\n                .ToList();\r\n\r\n            // 4.1 Determinar ação principal (none se ações mistas ou troca/substituição detectada)\r\n            var mainAction = DetermineMainAction(normalizedProducts, request.Description);\r\n\r\n            // 5. Construir resultado final\r\n            var result = new ClassifyIntentResult(new IntentClassificationResult\r\n            {\r\n                Description = classificationResult.Description,\r\n                Action = mainAction,\r\n                ClassifiedProducts = normalizedProducts,\r\n                Keywords = classificationResult.Keywords,\r\n                Log = classificationResult.Log,\r\n                PossibleProducts = classificationResult.PossibleProducts,\r\n                UnmatchedProducts = classificationResult.UnmatchedProducts,\r\n                SearchQueries = classificationResult.SearchQueries\r\n            });\r\n\r\n            _logger.LogInformation(\r\n                \"Classificação concluída. {ProductCount} produtos classificados. Primeiro: Action={Action}, ProductCode={ProductCode}\",\r\n                result.Data.ClassifiedProducts.Count,\r\n                result.Data.Action,\r\n                result.Data.ProductCode);\r\n\r\n            return result;\r\n        }\r\n\r\n        /// <summary>\r\n        /// Determines the main action for the classification result.\r\n        /// Returns \"none\" when mixed actions are detected (both product-add and product-remove)\r\n        /// or when swap/substitution keywords are found in the original description.\r\n        /// Individual product actions remain unchanged.\r\n        /// </summary>\r\n        private string DetermineMainAction(List<ClassifiedProduct> products, string description)\r\n        {\r\n            if (products.Count == 0)\r\n                return string.Empty;\r\n\r\n            var distinctActions = products\r\n                .Select(p => p.Action)\r\n                .Where(a => a is \"product-add\" or \"product-remove\")\r\n                .Distinct()\r\n                .ToList();\r\n\r\n            // Mixed actions (both add and remove) → none\r\n            if (distinctActions.Count > 1)\r\n            {\r\n                _logger.LogWarning(\r\n                    \"Mixed actions detected (product-add + product-remove). Main action set to 'none' for human review.\");\r\n                return \"none\";\r\n            }\r\n\r\n            // Swap/substitution keywords in description → none\r\n            if (ContainsSwapKeywords(description))\r\n            {\r\n                _logger.LogWarning(\r\n                    \"Swap/substitution keywords detected in description. Main action set to 'none' for human review.\");\r\n                return \"none\";\r\n            }\r\n\r\n            // Single action type → use it; otherwise fallback to first product's action\r\n            return distinctActions.Count == 1\r\n                ? distinctActions[0]\r\n                : products[0].Action;\r\n        }\r\n\r\n        /// <summary>\r\n        /// Checks if the description contains swap/substitution keywords\r\n        /// that indicate the request involves replacing one product with another.\r\n        /// </summary>\r\n        private static bool ContainsSwapKeywords(string description)\r\n        {\r\n            if (string.IsNullOrWhiteSpace(description))\r\n                return false;\r\n\r\n            var normalized = description.ToLowerInvariant();\r\n\r\n            var swapKeywords = new[]\r\n            {\r\n                \"trocar\", \"troca\", \"substituir\", \"substituição\", \"subistituir\",\r\n                \"migrar\", \"migração\", \"alterar pacote\", \"mudar para\", \"passar para\"\r\n            };\r\n\r\n            foreach (var keyword in swapKeywords)\r\n            {\r\n                if (normalized.Contains(keyword))\r\n                    return true;\r\n            }\r\n\r\n            return false;\r\n        }\r\n\r\n        /// <summary>\r\n        /// Normalizes action names to standardized values.\r\n        /// Application-level business rule for consistency.\r\n        /// </summary>\r\n        private static string NormalizeAction(string action)\r\n        {\r\n            if (string.IsNullOrWhiteSpace(action))\r\n                return string.Empty;\r\n\r\n            var normalized = action.Trim().ToLowerInvariant();\r\n\r\n            // Mapeia ações conhecidas\r\n            return normalized switch\r\n            {\r\n                \"product-add\" or \"inclusão\" or \"incluir\" or \"adicionar\" or \"ativação\" or \"liberação\" => \"product-add\",\r\n                \"product-remove\" or \"cancelamento\" or \"cancelar\" or \"retirada\" or \"excluir\" or \"exclusão\" => \"product-remove\",\r\n                \"none\" => \"none\",\r\n                _ => string.Empty\r\n            };\r\n        }\r\n    }\r\n}","epoch":28,"telemetryInfo":{}}],["file:///d%3A/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs::request_24305da6-f817-4604-813d-1316b353f59e",{"uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Infrastructure.OpenAI\\Prompts\\TextClassificationPrompt.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs","scheme":"file"},"requestId":"request_24305da6-f817-4604-813d-1316b353f59e","content":"namespace Sky.HubAI.Infrastructure.OpenAI.Prompts\r\n{\r\n    public static class TextClassificationPrompt\r\n    {\r\n        public static string GetSystemPrompt(double minMatchPercentage = 80) =>\r\n            @\"Você é um especialista em classificação de ações e produtos a partir de descrições textuais. Possui habilidade em interpretar textos com erros de grafia, identificar intenções implícitas e extrair informações estruturadas com precisão.\r\n\r\n# Task\r\n\r\nAnalisar descrições fornecidas em texto livre e classificar:\r\n(1) a ação a ser tomada para CADA produto mencionado (adição ou remoção);\r\n(2) Identificar o código de TODOS os produtos mencionados.\r\n\r\n# Context\r\n\r\nEste sistema processa solicitações de clientes que podem conter imprecisões ortográficas, palavras escritas em conjunto ou formatação irregular. A classificação precisa alimenta fluxos de trabalho operacionais, tornando a precisão crítica para o roteamento correto de tarefas e gestão de produtos.\r\n\r\n# Instructions\r\n\r\n## 1. Identificação de Produtos\r\n\r\nAnalise a descrição e identifique TODOS os produtos mencionados.\r\n\r\n**IMPORTANTE - Produtos podem estar listados de várias formas:**\r\n- Separados por `+` : \"\"PROMO SUPER 30D + DEG HBO 30D\"\"\r\n- Separados por `,` : \"\"HBO Max, Telecine, Premiere\"\"\r\n- Separados por `e`/`ou` : \"\"HBO e Telecine\"\"\r\n- Em texto corrido: \"\"incluir recarga PROMO SUPER 30D e também DEG HBO\"\"\r\n- Com valores/preços junto: \"\"PROMO SUPER 30D - R$ 89,91\"\"\r\n\r\n### Estratégia de Busca (OBRIGATÓRIA):\r\n\r\nQuando o texto contém termos que PODEM ser um produto único OU múltiplos produtos (ex: \"\"PROMO SUPER 30D + DEG HBO 30D\"\"), siga esta ordem:\r\n\r\n**Passo 1 - Buscar o texto completo/combinado primeiro:**\r\n- Faça `search_products` com o nome completo: ex: [\"\"PROMO SUPER 30D + DEG HBO 30D\"\", \"\"PROMO SUPER 30D DEG HBO 30D\"\"]\r\n- Avalie o percentual de acerto (%) retornado para cada resultado.\r\n\r\n**Passo 2 - Avaliar os resultados:**\r\n- Se encontrou um produto com acerto >= ##MIN_MATCH##%, use-o como produto ÚNICO (é um pacote/combo real no catálogo).\r\n- Se NÃO encontrou nenhum produto com acerto >= ##MIN_MATCH##%, trate como MÚLTIPLOS produtos separados.\r\n\r\n**Passo 3 - Se for múltiplos produtos, buscar cada um separadamente:**\r\n- Faça buscas separadas para cada componente:\r\n  - search_products([\"\"PROMO SUPER 30D\"\", \"\"PROMO SUPER\"\"])\r\n  - search_products([\"\"DEG HBO 30D\"\", \"\"DEG HBO\"\", \"\"DEGUSTAÇÃO HBO\"\"])\r\n- Para cada componente, escolha o produto com MAIOR percentual de acerto.\r\n\r\n### Uso do Percentual de Acerto (%)\r\n\r\nOs resultados de `search_products` incluem o percentual de acerto para cada produto.\r\n- **Sempre prefira o produto com maior percentual de acerto.**\r\n- Se dois produtos têm acerto similar (diferença < 5%), prefira o que tem nome mais próximo ao texto original.\r\n- O percentual indica quantas palavras do nome do produto foram encontradas na busca.\r\n\r\nExemplo de resultado:\r\n```\r\n- Código: 1-21D3Z3E | Nome: PROMO SUPER 30D + DEG HBO 30D | Acerto: 100%\r\n- Código: 1-20XSM69 | Nome: SUPER 30D FAIXA 3 | Acerto: 40%\r\n```\r\n→ Escolha o produto com 100% de acerto.\r\n\r\n## 2. Tratamento de Abreviações e Erros\r\n\r\n**Abreviações comuns que você deve expandir ao buscar:**\r\n- DEG = DEGUSTAÇÃO\r\n- PROMO = PROMOÇÃO ou PROMOCIONAL\r\n- 30D, 7D, 15D = 30 dias, 7 dias, 15 dias (período)\r\n- DEB/DEG = pode ser erro de digitação\r\n\r\n**Ao buscar, inclua variações:**\r\n- Termo original + termo expandido\r\n- Termos parciais do nome do produto\r\n- Combinações com e sem períodos (30D, 7D)\r\n\r\n## 3. Determinação da Ação\r\n\r\nPara CADA produto identificado, determine a ação **individual** correspondente:\r\n- `product-add`: inclusão, incluir, adicionar, ativar, ativação, liberação, reativação, pedido, destino, recarga\r\n- `product-remove`: cancelar, cancelamento, excluir, exclusão, retirada, origem, correção, duplicidade, remover\r\n- `none`: quando não for possível determinar a ação do produto individual\r\n\r\nCada produto DEVE ter sua ação real e individual. Mesmo em cenários de troca/substituição, classifique cada produto com a ação que se aplica a ELE:\r\n- O produto sendo adicionado → `product-add`\r\n- O produto sendo removido → `product-remove`\r\n\r\n**IMPORTANTE — Substituição / Troca de produtos:**\r\nQuando o texto indicar substituição, troca ou migração, você DEVE:\r\n1. Classificar cada produto com sua ação real (product-add ou product-remove)\r\n2. Incluir as palavras de troca/substituição no campo `keywords`\r\n\r\n**Palavras de substituição/troca que DEVEM ser adicionadas em `keywords`:**\r\n- trocar, troca, substituir, substituição, subistituir (erro de grafia)\r\n- migrar, migração, alterar pacote, mudar para, passar para\r\n\r\n**Exemplos de substituição (cada produto mantém sua ação real):**\r\n- \"\"substituir RECARGA X para RECARGA Y\"\" → RECARGA X = `product-remove`, RECARGA Y = `product-add`, keywords = [\"\"substituir\"\"]\r\n- \"\"trocar o pacote para HBO, PARAMOUNT\"\" → HBO = `product-add`, PARAMOUNT = `product-add`, keywords = [\"\"trocar\"\"]\r\n- \"\"migrar de pacote A para pacote B\"\" → A = `product-remove`, B = `product-add`, keywords = [\"\"migrar\"\"]\r\n\r\n**Indicadores de ação no contexto:**\r\n- \"\"por favor incluir\"\" → product-add\r\n- \"\"ativar recarga\"\" → product-add\r\n- \"\"valor ficou liberado\"\" + \"\"incluir\"\" → product-add\r\n- \"\"cancelar\"\" → product-remove\r\n- \"\"retirar da grade\"\" → product-remove\r\n\r\n## 4. Tratamento de Valores e Preços\r\n\r\n**IGNORE valores monetários ao identificar produtos:**\r\n- \"\"R$ 89,91\"\", \"\"R  89,91\"\", \"\"89,91\"\" → não fazem parte do nome do produto\r\n- \"\"valor disponível: 129,80\"\" → contexto informativo, não é produto\r\n\r\n## 5. Múltiplos Produtos com Mesma Ação\r\n\r\nUm mesmo texto pode conter MÚLTIPLOS produtos com a MESMA ação.\r\n\r\n**Se a busca combinada NÃO encontrou match >= ##MIN_MATCH##%, retorne cada produto separadamente:**\r\nExemplo: \"\"incluir a recarga: PROMO SUPER 30D + DEG HBO 30D\"\" → busca combinada não encontrou match >= ##MIN_MATCH##% → 2 produtos separados, ambos com action=\"\"product-add\"\"\r\n\r\n**Cada produto separado DEVE ter sua própria entrada em classifiedProducts:**\r\n- `productName` deve conter o nome INDIVIDUAL do produto como mencionado no texto.\r\n- `productCode` deve ser o código do produto com MAIOR percentual de acerto na busca individual.\r\n\r\n**Se a busca combinada encontrou match >= ##MIN_MATCH##%, retorne como produto ÚNICO:**\r\nExemplo: \"\"PROMO SUPER 30D + DEG HBO 30D\"\" existe no catálogo com 100% → 1 produto com o código do catálogo.\r\n\r\n**CORRETO (quando separados - sem match combinado >= ##MIN_MATCH##%):**\r\n```json\r\n{\r\n  \"\"classifiedProducts\"\": [\r\n    { \"\"productCode\"\": \"\"código-promo-super\"\", \"\"productName\"\": \"\"PROMO SUPER 30D\"\", \"\"action\"\": \"\"product-add\"\" },\r\n    { \"\"productCode\"\": \"\"código-deg-hbo\"\", \"\"productName\"\": \"\"DEG HBO 30D\"\", \"\"action\"\": \"\"product-add\"\" }\r\n  ]\r\n}\r\n```\r\n\r\n**CORRETO (quando combinado - match combinado >= ##MIN_MATCH##%):**\r\n```json\r\n{\r\n  \"\"classifiedProducts\"\": [\r\n    { \"\"productCode\"\": \"\"código-combo\"\", \"\"productName\"\": \"\"PROMO SUPER 30D + DEG HBO 30D\"\", \"\"action\"\": \"\"product-add\"\" }\r\n  ]\r\n}\r\n```\r\n\r\n## 6. Formato de Resposta\r\n\r\nApós identificar todos os produtos e ações, retorne um objeto JSON.\r\n**Use o percentual de acerto (%) para decidir se o produto é combinado (>= ##MIN_MATCH##%) ou deve ser separado (< ##MIN_MATCH##%).**\r\n**Produtos mencionados no texto mas NÃO encontrados pelo search_products devem ser listados em unmatchedProducts.**\r\n\r\n```json\r\n{\r\n  \"\"classifiedProducts\"\": [\r\n    { \"\"productCode\"\": \"\"código1\"\", \"\"productName\"\": \"\"Nome do Produto 1\"\", \"\"action\"\": \"\"product-add\"\" },\r\n    { \"\"productCode\"\": \"\"código2\"\", \"\"productName\"\": \"\"Nome do Produto 2\"\", \"\"action\"\": \"\"product-add\"\" }\r\n  ],\r\n  \"\"unmatchedProducts\"\": [\"\"Nome do Produto Não Encontrado\"\"],\r\n  \"\"keywords\"\": [\"\"incluir\"\", \"\"recarga\"\"],\r\n  \"\"log\"\": \"\"Explicação do raciocínio usado\"\"\r\n}\r\n```\r\n\r\n## 7. Regras Importantes\r\n\r\n- O output final deve ser APENAS o JSON sem texto adicional.\r\n- Use múltiplas chamadas a `search_products` para encontrar cada produto.\r\n- Jamais invente códigos de produtos. Use apenas os retornados pela função search_products.\r\n- keywords deve conter as palavras-chave de ação encontradas no texto.\r\n- **Se não conseguir determinar a ação, use action=\"\"none\"\".**\r\n- **Se o produto não for encontrado pelo search_products, adicione-o em `unmatchedProducts` (apenas o nome) e NÃO o inclua em `classifiedProducts`.**\r\n- **Sempre use o produto com MAIOR percentual de acerto (%) na busca.**\r\n- **Para textos com `+`, `,`, `e`, `ou`: busque PRIMEIRO o texto combinado. Se acerto >= ##MIN_MATCH##%, retorne como produto único. Caso contrário, busque cada componente separadamente.**\r\n\r\n## 8. Retorno com Ação ou Produto Não Identificado\r\n\r\nQuando não for possível identificar a ação OU o produto:\r\n- Se o produto foi buscado via search_products e NÃO foi encontrado, adicione o nome do produto em `unmatchedProducts` e NÃO o inclua em `classifiedProducts`.\r\n- Se a ação não puder ser determinada mas o produto existe, use action=\"\"none\"\" em `classifiedProducts`.\r\n\r\n```json\r\n{\r\n  \"\"classifiedProducts\"\": [],\r\n  \"\"unmatchedProducts\"\": [\"\"Nome mencionado no texto\"\"],\r\n  \"\"keywords\"\": [],\r\n  \"\"log\"\": \"\"Produto não encontrado no catálogo\"\" \r\n}\r\n```\r\n\r\n## 9. Se Nenhum Produto For Mencionado no Texto\r\n\r\nSe o texto não mencionar nenhum produto, retorne:\r\n```json\r\n{\r\n  \"\"classifiedProducts\"\": [],\r\n  \"\"unmatchedProducts\"\": [],\r\n  \"\"keywords\"\": [],\r\n  \"\"log\"\": \"\"Nenhum produto mencionado no texto\"\"\r\n}\r\n```\".Replace(\"##MIN_MATCH##\", minMatchPercentage.ToString(\"0.#\"));\r\n    }\r\n}","epoch":29,"telemetryInfo":{}}]],"operations":[{"type":"textEdit","uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Infrastructure.OpenAI\\Prompts\\TextClassificationPrompt.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs","scheme":"file"},"requestId":"request_5b1bb7f1-d7b3-437b-a5dc-252290a4cc37","epoch":9,"edits":[{"text":", ou quando houver qualquer dúvida\r\n\r\n**REGRA CRÍTICA — Substituição / Troca de produtos:**\r\nQuando o texto indica que um produto será REMOVIDO para dar lugar a OUTRO (substituição, troca, migração), a ação de TODOS os produtos DEVE ser `none`. Um humano precisa avaliar esses casos.\r\n\r\n**Indicadores de substituição/troca (SEMPRE resultam em action=\"\"none\"\" para TODOS os produtos):**\r\n- trocar, troca, substituir, substituição, subistituir (erro de grafia)\r\n- migrar, migração, alterar pacote, mudar para, passar para\r\n- \"\"trocar o pacote para X\"\" → `none` (implica remover o atual + adicionar X)\r\n- \"\"substituir RECARGA X para RECARGA Y\"\" → `none` (remover X + adicionar Y)\r\n- \"\"não reconhece X, favor substituir para Y\"\" → `none`\r\n- \"\"migrar de pacote A para pacote B\"\" → `none`\r\n\r\n**Quando usar `product-add`:**\r\n- SOMENTE quando TODOS os produtos são puramente inclusões, sem nenhuma remoção implícita.\r\n- Exemplo: \"\"incluir HBO e Telecine\"\" → ambos `product-add`\r\n- Exemplo: \"\"ativar recarga PROMO SUPER 30D\"\" → `product-add`\r\n\r\n**Quando usar `product-remove`:**\r\n- SOMENTE quando TODOS os produtos são puramente exclusões, sem nenhuma inclusão implícita.\r\n- Exemplo: \"\"cancelar HBO e Telecine\"\" → ambos `product-remove`\r\n\r\n**Quando usar `none`:**\r\n- Quando o texto indica troca/substituição (remove um e adiciona outro)\r\n- Quando há QUALQUER dúvida, por menor que seja, sobre a ação\r\n- Quando o texto mistura ações de inclusão e exclusão\r\n- Quando não é possível determinar a ação com certeza\r\n\r\n**Indicadores de ação no contexto (apenas para ações puras, sem troca)","range":{"startLineNumber":81,"startColumn":52,"endLineNumber":83,"endColumn":34}}]},{"type":"textEdit","uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Application\\UseCases\\Intent\\ClassifyIntent\\ClassifyIntentQueryHandler.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","scheme":"file"},"requestId":"request_5b1bb7f1-d7b3-437b-a5dc-252290a4cc37","epoch":10,"edits":[{"text":"Safety net: when classified products contain mixed actions (both product-add and product-remove),\r\n        /// overrides ALL actions to \"none\" so a human can evaluate the case.\r\n        /// This catches substitution/swap scenarios that the LLM may have missed.\r\n        /// </summary>\r\n        private List<ClassifiedProduct> ApplyMixedActionSafetyNet(List<ClassifiedProduct> products)\r\n        {\r\n            if (products.Count == 0)\r\n                return products;\r\n\r\n            var distinctActions = products\r\n                .Select(p => p.Action)\r\n                .Where(a => a == \"product-add\" || a == \"product-remove\")\r\n                .Distinct()\r\n                .ToList();\r\n\r\n            if (distinctActions.Count > 1)\r\n            {\r\n                _logger.LogWarning(\r\n                    \"Mixed actions detected (product-add + product-remove). Overriding all actions to 'none' for human review.\");\r\n\r\n                return products\r\n                    .Select(p => new ClassifiedProduct(p.ProductCode, p.ProductName, \"none\"))\r\n                    .ToList();\r\n            }\r\n\r\n            return products;\r\n        }\r\n\r\n        /// <summary>\r\n        /// ","range":{"startLineNumber":113,"startColumn":13,"endLineNumber":113,"endColumn":13}}]},{"type":"textEdit","uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Application\\UseCases\\Intent\\ClassifyIntent\\ClassifyIntentQueryHandler.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","scheme":"file"},"requestId":"request_5b1bb7f1-d7b3-437b-a5dc-252290a4cc37","epoch":11,"edits":[{"text":"4.1 Safety net: se há ações mistas (product-add + product-remove), forçar todas para \"none\"\r\n            normalizedProducts = ApplyMixedActionSafetyNet(normalizedProducts);\r\n\r\n            // ","range":{"startLineNumber":91,"startColumn":16,"endLineNumber":91,"endColumn":16}}]},{"type":"textEdit","uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Infrastructure.OpenAI\\Prompts\\TextClassificationPrompt.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs","scheme":"file"},"requestId":"request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13","epoch":19,"edits":[{"text":"**individual** correspondente:\r\n- `product-add`: inclusão, incluir, adicionar, ativar, ativação, liberação, reativação, pedido, destino, recarga\r\n- `product-remove`: cancelar, cancelamento, excluir, exclusão, retirada, origem, correção, duplicidade, remover\r\n- `none`: quando não for possível determinar a ação do produto individual\r\n\r\nCada produto DEVE ter sua ação real e individual. Mesmo em cenários de troca/substituição, classifique cada produto com a ação que se aplica a ELE:\r\n- O produto sendo adicionado → `product-add`\r\n- O produto sendo removido → `product-remove`\r\n\r\n**IMPORTANTE — Substituição / Troca de produtos:**\r\nQuando o texto indicar substituição, troca ou migração, você DEVE:\r\n1. Classificar cada produto com sua ação real (product-add ou product-remove)\r\n2. Incluir as palavras de troca/substituição no campo `keywords`\r\n\r\n**Palavras de substituição/troca que DEVEM ser adicionadas em `keywords`:**\r\n- trocar, troca, substituir, substituição, subistituir (erro de grafia)\r\n- migrar, migração, alterar pacote, mudar para, passar para\r\n\r\n**Exemplos de substituição (cada produto mantém sua ação real):**\r\n- \"\"substituir RECARGA X para RECARGA Y\"\" → RECARGA X = `product-remove`, RECARGA Y = `product-add`, keywords = [\"\"substituir\"\"]\r\n- \"\"trocar o pacote para HBO, PARAMOUNT\"\" → HBO = `product-add`, PARAMOUNT = `product-add`, keywords = [\"\"trocar\"\"]\r\n- \"\"migrar de pacote A para pacote B\"\" → A = `product-remove`, B = `product-add`, keywords = [\"\"migrar\"\"]\r\n\r\n**Indicadores de ação no contexto","range":{"startLineNumber":78,"startColumn":50,"endLineNumber":109,"endColumn":71}}]},{"type":"textEdit","uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Application\\Models\\IntentClassificationResult.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/Models/IntentClassificationResult.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Application/Models/IntentClassificationResult.cs","scheme":"file"},"requestId":"request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13","epoch":20,"edits":[{"text":"Main action/intent for the classification.\r\n        /// Set to \"none\" when mixed actions or substitution/swap is detected.\r\n        /// When all products share the same action, reflects that action.\r\n        /// </summary>\r\n        public string Action { get; init; } =","range":{"startLineNumber":24,"startColumn":13,"endLineNumber":27,"endColumn":79}}]},{"type":"textEdit","uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Application\\UseCases\\Intent\\ClassifyIntent\\ClassifyIntentQueryHandler.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","scheme":"file"},"requestId":"request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13","epoch":21,"edits":[{"text":"Determines the main action for the classification result.\r\n        /// Returns \"none\" when mixed actions are detected (both product-add and product-remove)\r\n        /// or when swap/substitution keywords are found in the original description.\r\n        /// Individual product actions remain unchanged.\r\n        /// </summary>\r\n        private string DetermineMainAction(List<ClassifiedProduct> products, string description)\r\n        {\r\n            if (products.Count == 0)\r\n                return string.Empty;\r\n\r\n            var distinctActions = products\r\n                .Select(p => p.Action)\r\n                .Where(a => a is \"product-add\" or \"product-remove\")\r\n                .Distinct()\r\n                .ToList();\r\n\r\n            // Mixed actions (both add and remove) → none\r\n            if (distinctActions.Count > 1)\r\n            {\r\n                _logger.LogWarning(\r\n                    \"Mixed actions detected (product-add + product-remove). Main action set to 'none' for human review.\");\r\n                return \"none\";\r\n            }\r\n\r\n            // Swap/substitution keywords in description → none\r\n            if (ContainsSwapKeywords(description))\r\n            {\r\n                _logger.LogWarning(\r\n                    \"Swap/substitution keywords detected in description. Main action set to 'none' for human review.\");\r\n                return \"none\";\r\n            }\r\n\r\n            // Single action type → use it; otherwise fallback to first product's action\r\n            return distinctActions.Count == 1\r\n                ? distinctActions[0]\r\n                : products[0].Action;\r\n        }\r\n\r\n        /// <summary>\r\n        /// Checks if the description contains swap/substitution keywords\r\n        /// that indicate the request involves replacing one product with another.\r\n        /// </summary>\r\n        private static bool ContainsSwapKeywords(string description)\r\n        {\r\n            if (string.IsNullOrWhiteSpace(description))\r\n                return false;\r\n\r\n            var normalized = description.ToLowerInvariant();\r\n\r\n            ReadOnlySpan<string> swapKeywords =\r\n            [\r\n                \"trocar\", \"troca\", \"substituir\", \"substitui\\u00e7\\u00e3o\", \"subistituir\",\r\n                \"migrar\", \"migra\\u00e7\\u00e3o\", \"alterar pacote\", \"mudar para\", \"passar para\"\r\n            ];\r\n\r\n            foreach (var keyword in swapKeywords)\r\n            {\r\n                if (normalized.Contains(keyword))\r\n                    return true;\r\n            }\r\n\r\n            return false","range":{"startLineNumber":116,"startColumn":13,"endLineNumber":141,"endColumn":28}}]},{"type":"textEdit","uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Application\\UseCases\\Intent\\ClassifyIntent\\ClassifyIntentQueryHandler.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","scheme":"file"},"requestId":"request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13","epoch":22,"edits":[{"text":"Determinar ação principal (none se ações mistas ou troca/substituição detectada)\r\n            var mainAction = DetermineMainAction(normalizedProducts, request.Description);\r\n\r\n            // 5. Construir resultado final\r\n            var result = new ClassifyIntentResult(new IntentClassificationResult\r\n            {\r\n                Description = classificationResult.Description,\r\n                Action = mainAc","range":{"startLineNumber":91,"startColumn":20,"endLineNumber":97,"endColumn":59}}]},{"type":"textEdit","uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Application\\UseCases\\Intent\\ClassifyIntent\\ClassifyIntentQueryHandler.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","scheme":"file"},"requestId":"request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13","epoch":24,"edits":[{"text":"            var swapKeywords = new[]\r\n            {\r\n                \"trocar\", \"troca\", \"substituir\", \"substituição\", \"subistituir\",\r\n                \"migrar\", \"migração\", \"alterar pacote\", \"mudar para\", \"passar para\"\r\n            };","range":{"startLineNumber":166,"startColumn":1,"endLineNumber":170,"endColumn":15}}]},{"type":"textEdit","uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Application\\UseCases\\Intent\\ClassifyIntent\\ClassifyIntentQueryHandler.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","scheme":"file"},"requestId":"request_24305da6-f817-4604-813d-1316b353f59e","epoch":30,"edits":[{"text":",\r\n                \"não reconhece\", \"nao reconhece\", \"desconhece\"","range":{"startLineNumber":169,"startColumn":84,"endLineNumber":169,"endColumn":84}}]},{"type":"textEdit","uri":{"$mid":1,"fsPath":"d:\\Repos\\_sk\\Sky.HubAI\\src\\Infrastructure.OpenAI\\Prompts\\TextClassificationPrompt.cs","_sep":1,"external":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs","path":"/d:/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs","scheme":"file"},"requestId":"request_24305da6-f817-4604-813d-1316b353f59e","epoch":31,"edits":[{"text":"/contestação que DEVEM ser adicionadas em `keywords`:**\r\n- trocar, troca, substituir, substituição, subistituir (erro de grafia)\r\n- migrar, migração, alterar pacote, mudar para, passar para\r\n- não reconhece, desconhece (cliente contesta o produto — requer análise humana)","range":{"startLineNumber":92,"startColumn":33,"endLineNumber":94,"endColumn":60}}]}],"epochCounter":32},"recentSnapshot":{"entries":[{"resource":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs","languageId":"csharp","originalHash":"1eb6b4f","currentHash":"1eb6b4f","state":1,"snapshotUri":"chat-editing-snapshot-text-model:/d%3A/Repos/_sk/Sky.HubAI/src/Infrastructure.OpenAI/Prompts/TextClassificationPrompt.cs?%7B%22session%22%3A%7B%22%24mid%22%3A1%2C%22fsPath%22%3A%22%5C%5COTYxMDVkNGItM2EwNC00MzlhLTgzNTUtZjMwYWRkM2Y2NWEw%22%2C%22_sep%22%3A1%2C%22external%22%3A%22vscode-chat-session%3A%2F%2Flocal%2FOTYxMDVkNGItM2EwNC00MzlhLTgzNTUtZjMwYWRkM2Y2NWEw%22%2C%22path%22%3A%22%2FOTYxMDVkNGItM2EwNC00MzlhLTgzNTUtZjMwYWRkM2Y2NWEw%22%2C%22scheme%22%3A%22vscode-chat-session%22%2C%22authority%22%3A%22local%22%7D%2C%22requestId%22%3A%22%22%2C%22undoStop%22%3A%22%22%7D","telemetryInfo":{"requestId":"request_24305da6-f817-4604-813d-1316b353f59e","agentId":"github.copilot.editsAgent","modelId":"copilot/claude-opus-4.6","modeId":"agent"}},{"resource":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs","languageId":"csharp","originalHash":"0db20a0","currentHash":"0db20a0","state":1,"snapshotUri":"chat-editing-snapshot-text-model:/d%3A/Repos/_sk/Sky.HubAI/src/Application/UseCases/Intent/ClassifyIntent/ClassifyIntentQueryHandler.cs?%7B%22session%22%3A%7B%22%24mid%22%3A1%2C%22fsPath%22%3A%22%5C%5COTYxMDVkNGItM2EwNC00MzlhLTgzNTUtZjMwYWRkM2Y2NWEw%22%2C%22_sep%22%3A1%2C%22external%22%3A%22vscode-chat-session%3A%2F%2Flocal%2FOTYxMDVkNGItM2EwNC00MzlhLTgzNTUtZjMwYWRkM2Y2NWEw%22%2C%22path%22%3A%22%2FOTYxMDVkNGItM2EwNC00MzlhLTgzNTUtZjMwYWRkM2Y2NWEw%22%2C%22scheme%22%3A%22vscode-chat-session%22%2C%22authority%22%3A%22local%22%7D%2C%22requestId%22%3A%22%22%2C%22undoStop%22%3A%22%22%7D","telemetryInfo":{"requestId":"request_24305da6-f817-4604-813d-1316b353f59e","agentId":"github.copilot.editsAgent","modelId":"copilot/claude-opus-4.6","modeId":"agent"}},{"resource":"file:///d%3A/Repos/_sk/Sky.HubAI/src/Application/Models/IntentClassificationResult.cs","languageId":"csharp","originalHash":"cd70aad","currentHash":"cd70aad","state":1,"snapshotUri":"chat-editing-snapshot-text-model:/d%3A/Repos/_sk/Sky.HubAI/src/Application/Models/IntentClassificationResult.cs?%7B%22session%22%3A%7B%22%24mid%22%3A1%2C%22fsPath%22%3A%22%5C%5COTYxMDVkNGItM2EwNC00MzlhLTgzNTUtZjMwYWRkM2Y2NWEw%22%2C%22_sep%22%3A1%2C%22external%22%3A%22vscode-chat-session%3A%2F%2Flocal%2FOTYxMDVkNGItM2EwNC00MzlhLTgzNTUtZjMwYWRkM2Y2NWEw%22%2C%22path%22%3A%22%2FOTYxMDVkNGItM2EwNC00MzlhLTgzNTUtZjMwYWRkM2Y2NWEw%22%2C%22scheme%22%3A%22vscode-chat-session%22%2C%22authority%22%3A%22local%22%7D%2C%22requestId%22%3A%22%22%2C%22undoStop%22%3A%22%22%7D","telemetryInfo":{"requestId":"request_3a864e38-20fe-46ce-ba1c-e13b7e1c3e13","agentId":"github.copilot.editsAgent","modelId":"copilot/claude-opus-4.6","modeId":"agent"}}]}}