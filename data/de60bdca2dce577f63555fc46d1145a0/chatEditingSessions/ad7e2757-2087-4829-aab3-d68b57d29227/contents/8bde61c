using Microsoft.AspNetCore.Builder;
using Microsoft.Extensions.Hosting;
using Sky.HubAI.Api.Middleware;
using Microsoft.AspNetCore.HttpOverrides;

namespace Sky.HubAI.Api.DependencyInjection
{
    public static class PresentationApplicationBuilderExtensions
    {
        public static WebApplication UsePresentation(this WebApplication app)
        {
            ConfigureSwagger(app);
            ConfigureHttpPipeline(app);

            return app;
        }

        private static void ConfigureSwagger(WebApplication app)
        {
            if (app.Environment.IsDevelopment())
            {
                app.UseSwagger();
                app.UseSwaggerUI();
            }
        }

        private static void ConfigureHttpPipeline(WebApplication app)
        {
            // Correlation ID should be first to ensure it's available for all subsequent middleware
            app.UseMiddleware<CorrelationIdMiddleware>();

            app.UseExceptionHandler();

            // Honor X-Forwarded-* headers when behind reverse proxies/load balancers
            // Clear KnownProxies/KnownNetworks so Azure App Service's load balancer is trusted
            var forwardedHeadersOptions = new ForwardedHeadersOptions
            {
                ForwardedHeaders = ForwardedHeaders.XForwardedFor | ForwardedHeaders.XForwardedProto
            };
            forwardedHeadersOptions.KnownProxies.Clear();
            forwardedHeadersOptions.KnownNetworks.Clear();
            app.UseForwardedHeaders(forwardedHeadersOptions);

            // Enforce HTTPS redirection and HSTS outside Development
            if (!app.Environment.IsDevelopment())
            {
                app.UseHsts();
                app.UseHttpsRedirection();
            }

            // Enable endpoint routing prior to applying CORS so that policies are evaluated correctly
            app.UseRouting();

            app.UseCors(PresentationConstants.DefaultCorsPolicyName);

            app.UseMiddleware<ClientTokenAuthMiddleware>();
            app.UseMiddleware<HttpLoggingMiddleware>();

            app.UseAuthorization();

            app.MapControllers();
        }
    }
}