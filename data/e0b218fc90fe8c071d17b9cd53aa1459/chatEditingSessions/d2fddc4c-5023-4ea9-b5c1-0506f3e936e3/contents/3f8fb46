# Script para instalar Docker Engine no Windows (WSL2)
# Autor: GitHub Copilot
# Data: 2026-01-30
# Nota: Este script instala o Docker Engine via WSL2, n√£o o Docker Desktop

# Cores para output
$ErrorActionPreference = "Stop"

Write-Host "üê≥ Instalando Docker Engine via WSL2..." -ForegroundColor Cyan

# Fun√ß√£o para verificar se est√° rodando como administrador
function Test-Administrator {
    $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($currentUser)
    return $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

# Verificar privil√©gios de administrador
if (-not (Test-Administrator)) {
    Write-Host "‚ùå Este script precisa ser executado como Administrador!" -ForegroundColor Red
    Write-Host "üí° Clique com o bot√£o direito no PowerShell e selecione 'Executar como administrador'" -ForegroundColor Yellow
    exit 1
}

# Verificar se WSL est√° instalado
Write-Host "üîç Verificando instala√ß√£o do WSL..." -ForegroundColor Yellow

$wslInstalled = $false
try {
    $wslVersion = wsl --version 2>$null
    if ($LASTEXITCODE -eq 0) {
        $wslInstalled = $true
    }
} catch {
    $wslInstalled = $false
}

if (-not $wslInstalled) {
    Write-Host "üì¶ WSL n√£o est√° instalado. Instalando WSL2..." -ForegroundColor Yellow
    
    try {
        wsl --install --no-distribution
        Write-Host "‚úÖ WSL2 instalado com sucesso!" -ForegroundColor Green
        Write-Host "‚ö†Ô∏è  √â necess√°rio reiniciar o computador para continuar." -ForegroundColor Yellow
        Write-Host "üí° Ap√≥s reiniciar, execute este script novamente." -ForegroundColor Cyan
        
        $restart = Read-Host "Deseja reiniciar agora? (s/n)"
        if ($restart -eq "s" -or $restart -eq "S") {
            Restart-Computer -Force
        }
        exit 0
    } catch {
        Write-Host "‚ùå Erro ao instalar WSL: $_" -ForegroundColor Red
        exit 1
    }
} else {
    Write-Host "‚úÖ WSL j√° est√° instalado" -ForegroundColor Green
}

# Verificar se existe uma distribui√ß√£o Linux instalada
Write-Host "üîç Verificando distribui√ß√µes Linux instaladas..." -ForegroundColor Yellow

$distroList = wsl --list --quiet 2>$null | Where-Object { $_ -and $_.Trim() -ne "" -and $_ -notmatch "docker-desktop" }
# Limpar caracteres nulos que o WSL √†s vezes retorna
$distroList = $distroList | ForEach-Object { $_ -replace "`0", "" } | Where-Object { $_.Trim() -ne "" }

if (-not $distroList -or @($distroList).Count -eq 0) {
    Write-Host "üì¶ Nenhuma distribui√ß√£o Linux encontrada. Instalando Ubuntu..." -ForegroundColor Yellow
    
    try {
        wsl --install -d Ubuntu
        Write-Host "‚úÖ Ubuntu instalado com sucesso!" -ForegroundColor Green
        Write-Host "‚ö†Ô∏è  Configure seu usu√°rio e senha no Ubuntu que ser√° aberto." -ForegroundColor Yellow
        Write-Host "üí° Ap√≥s configurar, execute este script novamente para instalar o Docker." -ForegroundColor Cyan
        exit 0
    } catch {
        Write-Host "‚ùå Erro ao instalar Ubuntu: $_" -ForegroundColor Red
        exit 1
    }
}

# Converter para array se necess√°rio
$distroList = @($distroList)

# Selecionar distro
if ($distroList.Count -eq 1) {
    $selectedDistro = $distroList[0].Trim()
    Write-Host "‚úÖ Distribui√ß√£o Linux encontrada: $selectedDistro" -ForegroundColor Green
} else {
    Write-Host "üìã M√∫ltiplas distribui√ß√µes Linux encontradas:" -ForegroundColor Cyan
    for ($i = 0; $i -lt $distroList.Count; $i++) {
        Write-Host "   [$($i + 1)] $($distroList[$i].Trim())" -ForegroundColor White
    }
    Write-Host ""
    
    do {
        $selection = Read-Host "üêß Escolha a distribui√ß√£o (1-$($distroList.Count))"
        $selectionIndex = [int]$selection - 1
    } while ($selectionIndex -lt 0 -or $selectionIndex -ge $distroList.Count)
    
    $selectedDistro = $distroList[$selectionIndex].Trim()
    Write-Host "‚úÖ Distribui√ß√£o selecionada: $selectedDistro" -ForegroundColor Green
}

# Fun√ß√£o para executar comando no WSL com output formatado
function Invoke-WslCommand {
    param(
        [string]$Command,
        [string]$Distro,
        [switch]$PassThru
    )
    
    $wslOutput = if ($Distro) {
        wsl -d $Distro -- bash -c $Command 2>&1
    } else {
        wsl -- bash -c $Command 2>&1
    }
    
    if ($PassThru) {
        return $wslOutput
    }
    
    # Exibir output com prefixo WSL
    foreach ($line in $wslOutput) {
        if ($line) {
            Write-Host "[WSL] " -ForegroundColor Magenta -NoNewline
            Write-Host $line -ForegroundColor DarkGray
        }
    }
    
    return $LASTEXITCODE
}

# Verificar se Docker j√° est√° instalado no WSL
Write-Host "üîç Verificando se Docker j√° est√° instalado no WSL ($selectedDistro)..." -ForegroundColor Yellow

$dockerInstalled = wsl -d $selectedDistro -- docker --version 2>$null
if ($LASTEXITCODE -eq 0 -and $dockerInstalled) {
    Write-Host "‚úÖ Docker j√° est√° instalado no WSL: $dockerInstalled" -ForegroundColor Green
    
    # Verificar se o servi√ßo est√° rodando
    $dockerRunning = wsl -d $selectedDistro -- docker info 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "‚úÖ Docker est√° rodando!" -ForegroundColor Green
    } else {
        Write-Host "‚ö†Ô∏è  Docker est√° instalado mas n√£o est√° rodando." -ForegroundColor Yellow
        Write-Host "üîÑ Iniciando servi√ßo Docker..." -ForegroundColor Yellow
        wsl -d $selectedDistro -- sudo service docker start
        if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Servi√ßo Docker iniciado com sucesso!" -ForegroundColor Green
        } else {
            Write-Host "‚ùå Erro ao iniciar servi√ßo Docker" -ForegroundColor Red
        }
    }
    exit 0
}

# Instalar Docker no WSL
Write-Host "üì¶ Instalando Docker Engine no WSL ($selectedDistro)..." -ForegroundColor Yellow
Write-Host ""
Write-Host "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor Magenta
Write-Host "‚îÇ  üêß Output do WSL ser√° exibido com prefixo [WSL] em roxo   ‚îÇ" -ForegroundColor Magenta
Write-Host "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" -ForegroundColor Magenta
Write-Host ""

# Script de instala√ß√£o do Docker para rodar no WSL
$dockerInstallScript = @'
#!/bin/bash
set -e

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}üê≥ Instalando Docker Engine...${NC}"

# Remover vers√µes antigas se existirem
echo -e "${YELLOW}üßπ Removendo vers√µes antigas do Docker (se existirem)...${NC}"
for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do
    sudo apt-get remove -y $pkg 2>/dev/null || true
done

# Atualizar pacotes
echo -e "${YELLOW}üì¶ Atualizando lista de pacotes...${NC}"
sudo apt-get update

# Instalar depend√™ncias
echo -e "${YELLOW}üì¶ Instalando depend√™ncias...${NC}"
sudo apt-get install -y ca-certificates curl gnupg

# Adicionar chave GPG oficial do Docker
echo -e "${YELLOW}üîë Adicionando chave GPG do Docker...${NC}"
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg --yes
sudo chmod a+r /etc/apt/keyrings/docker.gpg

# Adicionar reposit√≥rio do Docker
echo -e "${YELLOW}üìã Adicionando reposit√≥rio do Docker...${NC}"
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Atualizar e instalar Docker
echo -e "${YELLOW}üì¶ Instalando Docker Engine...${NC}"
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Adicionar usu√°rio ao grupo docker
echo -e "${YELLOW}üë§ Adicionando usu√°rio ao grupo docker...${NC}"
sudo usermod -aG docker $USER

# Iniciar servi√ßo Docker
echo -e "${YELLOW}üöÄ Iniciando servi√ßo Docker...${NC}"
sudo service docker start

# Verificar instala√ß√£o
echo -e "${YELLOW}üîç Verificando instala√ß√£o...${NC}"
sudo docker run --rm hello-world

echo -e "${GREEN}‚úÖ Docker Engine instalado com sucesso!${NC}"
echo -e "${CYAN}üí° Para usar docker sem sudo, fa√ßa logout e login novamente ou execute: newgrp docker${NC}"
'@

# Salvar script tempor√°rio e executar no WSL (com line endings Unix LF)
$tempScript = [System.IO.Path]::GetTempFileName() -replace '\.tmp$', '.sh'
$dockerInstallScriptLF = $dockerInstallScript -replace "`r`n", "`n" -replace "`r", "`n"
[System.IO.File]::WriteAllText($tempScript, $dockerInstallScriptLF, [System.Text.UTF8Encoding]::new($false))

# Converter caminho Windows para WSL
$wslPath = wsl -d $selectedDistro -- wslpath -u ($tempScript -replace '\\', '/')

# Executar script no WSL com output diferenciado
Write-Host "üöÄ Executando instala√ß√£o no WSL..." -ForegroundColor Cyan
Write-Host ""

# Executar e capturar output linha por linha para formata√ß√£o
$process = New-Object System.Diagnostics.Process
$process.StartInfo.FileName = "wsl.exe"
$process.StartInfo.Arguments = "-d $selectedDistro -- bash `"$wslPath`""
$process.StartInfo.UseShellExecute = $false
$process.StartInfo.RedirectStandardOutput = $true
$process.StartInfo.RedirectStandardError = $true
$process.StartInfo.CreateNoWindow = $true
$process.StartInfo.StandardOutputEncoding = [System.Text.Encoding]::UTF8
$process.StartInfo.StandardErrorEncoding = [System.Text.Encoding]::UTF8

# Event handlers para output em tempo real
$outputHandler = {
    if ($EventArgs.Data) {
        Write-Host "[WSL] " -ForegroundColor Magenta -NoNewline
        Write-Host $EventArgs.Data -ForegroundColor Gray
    }
}

$errorHandler = {
    if ($EventArgs.Data) {
        Write-Host "[WSL] " -ForegroundColor Magenta -NoNewline
        Write-Host $EventArgs.Data -ForegroundColor DarkYellow
    }
}

$process.add_OutputDataReceived($outputHandler)
$process.add_ErrorDataReceived($errorHandler)

$process.Start() | Out-Null
$process.BeginOutputReadLine()
$process.BeginErrorReadLine()
$process.WaitForExit()

$exitCode = $process.ExitCode
$process.Dispose()

Write-Host ""

if ($exitCode -eq 0) {
    Write-Host ""
    Write-Host "‚úÖ Docker Engine instalado com sucesso no WSL!" -ForegroundColor Green
    Write-Host ""
    Write-Host "üìã Para usar o Docker:" -ForegroundColor Cyan
    Write-Host "   ‚Ä¢ Abra o WSL (digite 'wsl' no terminal)" -ForegroundColor White
    Write-Host "   ‚Ä¢ Use comandos docker normalmente (docker run, docker ps, etc.)" -ForegroundColor White
    Write-Host ""
    Write-Host "üí° Dica: Para usar 'docker' diretamente do PowerShell, adicione ao seu perfil:" -ForegroundColor Yellow
    Write-Host '   function docker { wsl docker $args }' -ForegroundColor Gray
    Write-Host '   function docker-compose { wsl docker compose $args }' -ForegroundColor Gray
    Write-Host ""
    Write-Host "   Ou especificando a distro:" -ForegroundColor Yellow
    Write-Host "   function docker { wsl -d $selectedDistro docker `$args }" -ForegroundColor Gray
} else {
    Write-Host "‚ùå Erro durante a instala√ß√£o do Docker" -ForegroundColor Red
    exit 1
}

# Limpar arquivo tempor√°rio
Remove-Item -Path $tempScript -Force -ErrorAction SilentlyContinue
