# Script para desinstalar Docker Engine do WSL2
# Autor: GitHub Copilot
# Data: 2026-01-30
# Nota: Este script remove o Docker Engine instalado via WSL2

# Cores para output
$ErrorActionPreference = "Stop"

Write-Host "üê≥ Desinstalando Docker Engine do WSL2..." -ForegroundColor Cyan

# Verificar se WSL est√° instalado
Write-Host "üîç Verificando instala√ß√£o do WSL..." -ForegroundColor Yellow

$wslInstalled = $false
try {
    $wslVersion = wsl --version 2>$null
    if ($LASTEXITCODE -eq 0) {
        $wslInstalled = $true
    }
} catch {
    $wslInstalled = $false
}

if (-not $wslInstalled) {
    Write-Host "‚ùå WSL n√£o est√° instalado. Nada a fazer." -ForegroundColor Red
    exit 0
}

Write-Host "‚úÖ WSL est√° instalado" -ForegroundColor Green

# Verificar se existe uma distribui√ß√£o Linux instalada
Write-Host "üîç Verificando distribui√ß√µes Linux instaladas..." -ForegroundColor Yellow

$distroList = wsl --list --quiet 2>$null | Where-Object { $_ -and $_.Trim() -ne "" -and $_ -notmatch "docker-desktop" }
# Limpar caracteres nulos que o WSL √†s vezes retorna
$distroList = $distroList | ForEach-Object { $_ -replace "`0", "" } | Where-Object { $_.Trim() -ne "" }

if (-not $distroList -or @($distroList).Count -eq 0) {
    Write-Host "‚ùå Nenhuma distribui√ß√£o Linux encontrada. Nada a fazer." -ForegroundColor Red
    exit 0
}

# Converter para array se necess√°rio
$distroList = @($distroList)

# Selecionar distro
if ($distroList.Count -eq 1) {
    $selectedDistro = $distroList[0].Trim()
    Write-Host "‚úÖ Distribui√ß√£o Linux encontrada: $selectedDistro" -ForegroundColor Green
} else {
    Write-Host "üìã M√∫ltiplas distribui√ß√µes Linux encontradas:" -ForegroundColor Cyan
    for ($i = 0; $i -lt $distroList.Count; $i++) {
        Write-Host "   [$($i + 1)] $($distroList[$i].Trim())" -ForegroundColor White
    }
    Write-Host ""
    
    do {
        $selection = Read-Host "üêß Escolha a distribui√ß√£o (1-$($distroList.Count))"
        $selectionIndex = [int]$selection - 1
    } while ($selectionIndex -lt 0 -or $selectionIndex -ge $distroList.Count)
    
    $selectedDistro = $distroList[$selectionIndex].Trim()
    Write-Host "‚úÖ Distribui√ß√£o selecionada: $selectedDistro" -ForegroundColor Green
}

# Verificar se Docker est√° instalado no WSL
Write-Host "üîç Verificando se Docker est√° instalado no WSL ($selectedDistro)..." -ForegroundColor Yellow

$dockerInstalled = wsl -d $selectedDistro -- docker --version 2>$null
if ($LASTEXITCODE -ne 0 -or -not $dockerInstalled) {
    Write-Host "‚ÑπÔ∏è  Docker n√£o est√° instalado nesta distribui√ß√£o. Nada a fazer." -ForegroundColor Cyan
    exit 0
}

Write-Host "‚úÖ Docker encontrado: $dockerInstalled" -ForegroundColor Green

# Confirmar desinstala√ß√£o
Write-Host ""
Write-Host "‚ö†Ô∏è  ATEN√á√ÉO: Esta a√ß√£o ir√° remover:" -ForegroundColor Yellow
Write-Host "   ‚Ä¢ Docker Engine (docker-ce, docker-ce-cli)" -ForegroundColor White
Write-Host "   ‚Ä¢ Containerd" -ForegroundColor White
Write-Host "   ‚Ä¢ Docker Buildx e Compose plugins" -ForegroundColor White
Write-Host "   ‚Ä¢ Todas as imagens, containers e volumes Docker" -ForegroundColor White
Write-Host "   ‚Ä¢ Configura√ß√µes do Docker" -ForegroundColor White
Write-Host ""

$confirm = Read-Host "‚ùì Deseja continuar? (s/n)"
if ($confirm -ne "s" -and $confirm -ne "S") {
    Write-Host "‚ùå Opera√ß√£o cancelada pelo usu√°rio." -ForegroundColor Red
    exit 0
}

Write-Host ""
Write-Host "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor Magenta
Write-Host "‚îÇ  üêß Output do WSL ser√° exibido com prefixo [WSL] em roxo   ‚îÇ" -ForegroundColor Magenta
Write-Host "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" -ForegroundColor Magenta
Write-Host ""

# Script de desinstala√ß√£o do Docker para rodar no WSL
$dockerUninstallScript = @'
#!/bin/bash

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configurar para n√£o pedir confirma√ß√£o em apt
export DEBIAN_FRONTEND=noninteractive

echo -e "${CYAN}üê≥ Desinstalando Docker Engine...${NC}"

# Parar servi√ßo Docker (com timeout)
echo -e "${YELLOW}üõë Parando servi√ßo Docker...${NC}"
sudo timeout 10 service docker stop 2>/dev/null || echo -e "${YELLOW}   (servi√ßo j√° parado ou timeout)${NC}"

# Matar processos docker restantes
sudo pkill -9 dockerd 2>/dev/null || true
sudo pkill -9 containerd 2>/dev/null || true

# Parar todos os containers em execu√ß√£o
echo -e "${YELLOW}üõë Parando todos os containers...${NC}"
if sudo docker ps -aq 2>/dev/null | grep -q .; then
    sudo docker stop $(sudo docker ps -aq) 2>/dev/null || true
else
    echo -e "${YELLOW}   (nenhum container encontrado)${NC}"
fi

# Remover todos os containers
echo -e "${YELLOW}üóëÔ∏è Removendo todos os containers...${NC}"
if sudo docker ps -aq 2>/dev/null | grep -q .; then
    sudo docker rm -f $(sudo docker ps -aq) 2>/dev/null || true
else
    echo -e "${YELLOW}   (nenhum container para remover)${NC}"
fi

# Remover todas as imagens
echo -e "${YELLOW}üóëÔ∏è Removendo todas as imagens...${NC}"
if sudo docker images -aq 2>/dev/null | grep -q .; then
    sudo docker rmi -f $(sudo docker images -aq) 2>/dev/null || true
else
    echo -e "${YELLOW}   (nenhuma imagem para remover)${NC}"
fi

# Remover todos os volumes
echo -e "${YELLOW}üóëÔ∏è Removendo todos os volumes...${NC}"
if sudo docker volume ls -q 2>/dev/null | grep -q .; then
    sudo docker volume rm -f $(sudo docker volume ls -q) 2>/dev/null || true
else
    echo -e "${YELLOW}   (nenhum volume para remover)${NC}"
fi

# Remover todas as networks customizadas
echo -e "${YELLOW}üóëÔ∏è Removendo networks customizadas...${NC}"
sudo docker network prune -f 2>/dev/null || true

# Desinstalar pacotes Docker
echo -e "${YELLOW}üì¶ Desinstalando pacotes Docker...${NC}"
sudo apt-get purge -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin 2>/dev/null || true

# Remover pacotes √≥rf√£os
echo -e "${YELLOW}üßπ Removendo pacotes √≥rf√£os...${NC}"
sudo apt-get autoremove -y 2>/dev/null || true

# Remover diret√≥rios do Docker
echo -e "${YELLOW}üìÅ Removendo diret√≥rios do Docker...${NC}"
sudo rm -rf /var/lib/docker
sudo rm -rf /var/lib/containerd
sudo rm -rf /etc/docker
sudo rm -rf ~/.docker

# Remover chave GPG e reposit√≥rio
echo -e "${YELLOW}üîë Removendo chave GPG e reposit√≥rio...${NC}"
sudo rm -f /etc/apt/keyrings/docker.gpg
sudo rm -f /etc/apt/sources.list.d/docker.list

# Remover grupo docker do usu√°rio (opcional, n√£o causa erro se n√£o existir)
echo -e "${YELLOW}üë§ Removendo usu√°rio do grupo docker...${NC}"
sudo gpasswd -d $USER docker 2>/dev/null || true

# Atualizar lista de pacotes
echo -e "${YELLOW}üì¶ Atualizando lista de pacotes...${NC}"
sudo apt-get update

echo -e "${GREEN}‚úÖ Docker Engine desinstalado com sucesso!${NC}"
echo -e "${CYAN}üí° Todos os containers, imagens e volumes foram removidos.${NC}"
'@

# Salvar script tempor√°rio e executar no WSL (com line endings Unix LF)
$tempScript = [System.IO.Path]::GetTempFileName() -replace '\.tmp$', '.sh'
$dockerUninstallScriptLF = $dockerUninstallScript -replace "`r`n", "`n" -replace "`r", "`n"
[System.IO.File]::WriteAllText($tempScript, $dockerUninstallScriptLF, [System.Text.UTF8Encoding]::new($false))

# Converter caminho Windows para WSL
$wslPath = wsl -d $selectedDistro -- wslpath -u ($tempScript -replace '\\', '/')

# Executar script no WSL com output diferenciado
Write-Host "üöÄ Executando desinstala√ß√£o no WSL..." -ForegroundColor Cyan
Write-Host ""

# Usar leitura s√≠ncrona com stderr redirecionado para stdout
$pinfo = New-Object System.Diagnostics.ProcessStartInfo
$pinfo.FileName = "wsl.exe"
$pinfo.Arguments = "-d $selectedDistro -- bash `"$wslPath`" 2>&1"
$pinfo.UseShellExecute = $false
$pinfo.RedirectStandardOutput = $true
$pinfo.RedirectStandardError = $false
$pinfo.CreateNoWindow = $true
$pinfo.StandardOutputEncoding = [System.Text.Encoding]::UTF8

$process = New-Object System.Diagnostics.Process
$process.StartInfo = $pinfo
$process.Start() | Out-Null

# Ler output linha por linha
while ($null -ne ($line = $process.StandardOutput.ReadLine())) {
    if ($line) {
        Write-Host "[WSL] " -ForegroundColor Magenta -NoNewline
        Write-Host $line -ForegroundColor Gray
    }
}

$process.WaitForExit()
$exitCode = $process.ExitCode
$process.Dispose()

Write-Host ""

if ($exitCode -eq 0) {
    Write-Host ""
    Write-Host "‚úÖ Docker Engine desinstalado com sucesso do WSL!" -ForegroundColor Green
    Write-Host ""
    Write-Host "üìã O que foi removido:" -ForegroundColor Cyan
    Write-Host "   ‚Ä¢ Docker Engine e todos os componentes" -ForegroundColor White
    Write-Host "   ‚Ä¢ Todas as imagens, containers e volumes" -ForegroundColor White
    Write-Host "   ‚Ä¢ Configura√ß√µes e chaves GPG" -ForegroundColor White
    Write-Host ""
    Write-Host "üí° Para reinstalar, execute: .\install-docker.ps1" -ForegroundColor Yellow
} else {
    Write-Host "‚ùå Erro durante a desinstala√ß√£o do Docker" -ForegroundColor Red
    exit 1
}

# Limpar arquivo tempor√°rio
Remove-Item -Path $tempScript -Force -ErrorAction SilentlyContinue
