#!/bin/bash
# Script para desinstalar Docker Engine do Linux (Ubuntu/Debian)
# Autor: GitHub Copilot
# Data: 2026-01-30
# Uso: ./uninstall-docker-engine.sh
# Nota: Requer sudo/root

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Verificar se estÃ¡ rodando como root ou com sudo disponÃ­vel
check_privileges() {
    if [ "$EUID" -ne 0 ]; then
        if ! command -v sudo &> /dev/null; then
            echo -e "${RED}âŒ Este script precisa ser executado como root ou ter sudo disponÃ­vel${NC}"
            exit 1
        fi
        SUDO="sudo"
    else
        SUDO=""
    fi
}

# Verificar se Docker estÃ¡ instalado
check_docker_installed() {
    if ! command -v docker &> /dev/null; then
        echo -e "${YELLOW}â„¹ï¸  Docker nÃ£o estÃ¡ instalado. Nada a fazer.${NC}"
        exit 0
    fi
    
    DOCKER_VERSION=$(docker --version 2>/dev/null || echo "desconhecida")
    echo -e "${GREEN}âœ… Docker encontrado: $DOCKER_VERSION${NC}"
}

# Confirmar desinstalaÃ§Ã£o (sÃ³ em modo interativo)
confirm_uninstall() {
    # Se nÃ£o for terminal interativo, pular confirmaÃ§Ã£o
    if [ ! -t 0 ]; then
        return 0
    fi
    
    echo ""
    echo -e "${YELLOW}âš ï¸  ATENÃ‡ÃƒO: Esta aÃ§Ã£o irÃ¡ remover:${NC}"
    echo -e "   â€¢ Docker Engine (docker-ce, docker-ce-cli)"
    echo -e "   â€¢ Containerd"
    echo -e "   â€¢ Docker Buildx e Compose plugins"
    echo -e "   â€¢ Todas as imagens, containers e volumes Docker"
    echo -e "   â€¢ ConfiguraÃ§Ãµes do Docker"
    echo ""
    
    read -p "â“ Deseja continuar? (s/n): " confirm
    if [[ ! "$confirm" =~ ^[sS]$ ]]; then
        echo -e "${RED}âŒ OperaÃ§Ã£o cancelada pelo usuÃ¡rio.${NC}"
        exit 0
    fi
}

# Desinstalar Docker
uninstall_docker() {
    echo -e "${CYAN}ğŸ³ Desinstalando Docker Engine...${NC}"
    
    # Configurar para nÃ£o pedir confirmaÃ§Ã£o em apt
    export DEBIAN_FRONTEND=noninteractive
    
    # Parar serviÃ§o Docker (com timeout)
    echo -e "${YELLOW}ğŸ›‘ Parando serviÃ§o Docker...${NC}"
    $SUDO timeout 10 service docker stop 2>/dev/null || \
    $SUDO timeout 10 systemctl stop docker 2>/dev/null || \
    echo -e "${YELLOW}   (serviÃ§o jÃ¡ parado ou timeout)${NC}"
    
    # Matar processos docker restantes
    $SUDO pkill -9 dockerd 2>/dev/null || true
    $SUDO pkill -9 containerd 2>/dev/null || true
    
    # Parar todos os containers em execuÃ§Ã£o
    echo -e "${YELLOW}ğŸ›‘ Parando todos os containers...${NC}"
    if $SUDO docker ps -aq 2>/dev/null | grep -q .; then
        $SUDO docker stop $($SUDO docker ps -aq) 2>/dev/null || true
    else
        echo -e "${YELLOW}   (nenhum container encontrado)${NC}"
    fi
    
    # Remover todos os containers
    echo -e "${YELLOW}ğŸ—‘ï¸ Removendo todos os containers...${NC}"
    if $SUDO docker ps -aq 2>/dev/null | grep -q .; then
        $SUDO docker rm -f $($SUDO docker ps -aq) 2>/dev/null || true
    else
        echo -e "${YELLOW}   (nenhum container para remover)${NC}"
    fi
    
    # Remover todas as imagens
    echo -e "${YELLOW}ğŸ—‘ï¸ Removendo todas as imagens...${NC}"
    if $SUDO docker images -aq 2>/dev/null | grep -q .; then
        $SUDO docker rmi -f $($SUDO docker images -aq) 2>/dev/null || true
    else
        echo -e "${YELLOW}   (nenhuma imagem para remover)${NC}"
    fi
    
    # Remover todos os volumes
    echo -e "${YELLOW}ğŸ—‘ï¸ Removendo todos os volumes...${NC}"
    if $SUDO docker volume ls -q 2>/dev/null | grep -q .; then
        $SUDO docker volume rm -f $($SUDO docker volume ls -q) 2>/dev/null || true
    else
        echo -e "${YELLOW}   (nenhum volume para remover)${NC}"
    fi
    
    # Remover todas as networks customizadas
    echo -e "${YELLOW}ğŸ—‘ï¸ Removendo networks customizadas...${NC}"
    $SUDO docker network prune -f 2>/dev/null || true
    
    # Desinstalar pacotes Docker
    echo -e "${YELLOW}ğŸ“¦ Desinstalando pacotes Docker...${NC}"
    $SUDO apt-get purge -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin 2>/dev/null || true
    
    # Remover pacotes Ã³rfÃ£os
    echo -e "${YELLOW}ğŸ§¹ Removendo pacotes Ã³rfÃ£os...${NC}"
    $SUDO apt-get autoremove -y 2>/dev/null || true
    
    # Remover diretÃ³rios do Docker
    echo -e "${YELLOW}ğŸ“ Removendo diretÃ³rios do Docker...${NC}"
    $SUDO rm -rf /var/lib/docker
    $SUDO rm -rf /var/lib/containerd
    $SUDO rm -rf /etc/docker
    rm -rf ~/.docker
    
    # Remover chave GPG e repositÃ³rio
    echo -e "${YELLOW}ğŸ”‘ Removendo chave GPG e repositÃ³rio...${NC}"
    $SUDO rm -f /etc/apt/keyrings/docker.gpg
    $SUDO rm -f /etc/apt/sources.list.d/docker.list
    
    # Remover grupo docker do usuÃ¡rio (opcional)
    echo -e "${YELLOW}ğŸ‘¤ Removendo usuÃ¡rio do grupo docker...${NC}"
    $SUDO gpasswd -d $USER docker 2>/dev/null || true
    
    # Atualizar lista de pacotes
    echo -e "${YELLOW}ğŸ“¦ Atualizando lista de pacotes...${NC}"
    $SUDO apt-get update
    
    echo -e "${GREEN}âœ… Docker Engine desinstalado com sucesso!${NC}"
    echo -e "${CYAN}ğŸ’¡ Todos os containers, imagens e volumes foram removidos.${NC}"
}

# Main
main() {
    echo -e "${CYAN}ğŸ³ Desinstalador do Docker Engine${NC}"
    echo ""
    
    check_privileges
    check_docker_installed
    confirm_uninstall
    uninstall_docker
}

main "$@"
