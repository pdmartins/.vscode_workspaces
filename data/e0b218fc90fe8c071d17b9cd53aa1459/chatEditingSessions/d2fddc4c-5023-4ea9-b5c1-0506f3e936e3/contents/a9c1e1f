#!/bin/bash
# Script para instalar Docker Engine no Linux (Ubuntu/Debian)
# Autor: GitHub Copilot
# Data: 2026-01-30
# Uso: ./install-docker-engine.sh
# Nota: Requer sudo/root

set -e

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Verificar se estÃ¡ rodando como root ou com sudo disponÃ­vel
check_privileges() {
    if [ "$EUID" -ne 0 ]; then
        if ! command -v sudo &> /dev/null; then
            echo -e "${RED}âŒ Este script precisa ser executado como root ou ter sudo disponÃ­vel${NC}"
            exit 1
        fi
        SUDO="sudo"
    else
        SUDO=""
    fi
}

# Detectar distribuiÃ§Ã£o
detect_distro() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        DISTRO=$ID
        VERSION_CODENAME=${VERSION_CODENAME:-$UBUNTU_CODENAME}
    else
        echo -e "${RED}âŒ NÃ£o foi possÃ­vel detectar a distribuiÃ§Ã£o Linux${NC}"
        exit 1
    fi
    
    case $DISTRO in
        ubuntu|debian)
            echo -e "${GREEN}âœ… DistribuiÃ§Ã£o detectada: $DISTRO ($VERSION_CODENAME)${NC}"
            ;;
        *)
            echo -e "${RED}âŒ DistribuiÃ§Ã£o nÃ£o suportada: $DISTRO${NC}"
            echo -e "${YELLOW}ğŸ’¡ Este script suporta: Ubuntu, Debian${NC}"
            exit 1
            ;;
    esac
}

# Verificar se Docker jÃ¡ estÃ¡ instalado
check_docker_installed() {
    if command -v docker &> /dev/null; then
        DOCKER_VERSION=$(docker --version 2>/dev/null || echo "desconhecida")
        echo -e "${GREEN}âœ… Docker jÃ¡ estÃ¡ instalado: $DOCKER_VERSION${NC}"
        
        # Verificar se estÃ¡ rodando
        if $SUDO docker info &> /dev/null; then
            echo -e "${GREEN}âœ… Docker estÃ¡ rodando!${NC}"
        else
            echo -e "${YELLOW}âš ï¸  Docker instalado mas nÃ£o estÃ¡ rodando${NC}"
            echo -e "${YELLOW}ğŸ”„ Iniciando serviÃ§o Docker...${NC}"
            $SUDO service docker start || $SUDO systemctl start docker
            echo -e "${GREEN}âœ… ServiÃ§o Docker iniciado!${NC}"
        fi
        exit 0
    fi
}

# Instalar Docker
install_docker() {
    echo -e "${CYAN}ğŸ³ Instalando Docker Engine...${NC}"
    
    # Remover versÃµes antigas se existirem
    echo -e "${YELLOW}ğŸ§¹ Removendo versÃµes antigas do Docker (se existirem)...${NC}"
    for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do
        $SUDO apt-get remove -y $pkg 2>/dev/null || true
    done
    
    # Atualizar pacotes
    echo -e "${YELLOW}ğŸ“¦ Atualizando lista de pacotes...${NC}"
    $SUDO apt-get update
    
    # Instalar dependÃªncias
    echo -e "${YELLOW}ğŸ“¦ Instalando dependÃªncias...${NC}"
    $SUDO apt-get install -y ca-certificates curl gnupg
    
    # Adicionar chave GPG oficial do Docker
    echo -e "${YELLOW}ğŸ”‘ Adicionando chave GPG do Docker...${NC}"
    $SUDO install -m 0755 -d /etc/apt/keyrings
    curl -fsSL https://download.docker.com/linux/$DISTRO/gpg | $SUDO gpg --dearmor -o /etc/apt/keyrings/docker.gpg --yes
    $SUDO chmod a+r /etc/apt/keyrings/docker.gpg
    
    # Adicionar repositÃ³rio do Docker
    echo -e "${YELLOW}ğŸ“‹ Adicionando repositÃ³rio do Docker...${NC}"
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/$DISTRO \
      $VERSION_CODENAME stable" | \
      $SUDO tee /etc/apt/sources.list.d/docker.list > /dev/null
    
    # Atualizar e instalar Docker
    echo -e "${YELLOW}ğŸ“¦ Instalando Docker Engine...${NC}"
    $SUDO apt-get update
    $SUDO apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    
    # Adicionar usuÃ¡rio ao grupo docker
    echo -e "${YELLOW}ğŸ‘¤ Adicionando usuÃ¡rio ao grupo docker...${NC}"
    $SUDO usermod -aG docker $USER
    
    # Iniciar serviÃ§o Docker
    echo -e "${YELLOW}ğŸš€ Iniciando serviÃ§o Docker...${NC}"
    $SUDO service docker start || $SUDO systemctl start docker
    
    # Verificar instalaÃ§Ã£o
    echo -e "${YELLOW}ğŸ” Verificando instalaÃ§Ã£o...${NC}"
    $SUDO docker run --rm hello-world
    
    echo -e "${GREEN}âœ… Docker Engine instalado com sucesso!${NC}"
    echo -e "${CYAN}ğŸ’¡ Para usar docker sem sudo, faÃ§a logout e login novamente ou execute: newgrp docker${NC}"
}

# Main
main() {
    echo -e "${CYAN}ğŸ³ Instalador do Docker Engine${NC}"
    echo ""
    
    check_privileges
    detect_distro
    check_docker_installed
    install_docker
}

main "$@"
