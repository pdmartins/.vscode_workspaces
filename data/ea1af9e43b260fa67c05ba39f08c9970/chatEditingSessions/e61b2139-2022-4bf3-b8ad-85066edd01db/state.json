{"version":2,"initialFileContents":[["file:///d%3A/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.Domain/Dtos/RowDto.cs","6e3097d"],["file:///d%3A/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.UnitTests/Units/Services/v1/BigQueryCheckStatus/GetBigQueryCheckStatusServiceTests.cs","f6d1d1d"]],"timeline":{"checkpoints":[{"checkpointId":"1da941fe-8d5e-42a8-bfab-06bc9a690c84","epoch":0,"label":"Initial State","description":"Starting point before any edits"},{"checkpointId":"3df58248-4346-44e7-bfad-d0a6809f2d8e","requestId":"request_8d102506-9b9a-434e-be97-a7b770212bf3","epoch":1,"label":"Request request_8d102506-9b9a-434e-be97-a7b770212bf3"},{"checkpointId":"15b69307-9611-4191-ac35-351ff48e750c","requestId":"request_8d102506-9b9a-434e-be97-a7b770212bf3","undoStopId":"64c2b037-7220-4f2b-8153-745722ea5a5a","epoch":2,"label":"Request request_8d102506-9b9a-434e-be97-a7b770212bf3 - Stop 64c2b037-7220-4f2b-8153-745722ea5a5a"},{"checkpointId":"32135f09-ac2b-4501-bede-906ac7dd23c2","requestId":"request_478c8bd6-02d7-4e05-a047-2e09d6eee961","epoch":5,"label":"Request request_478c8bd6-02d7-4e05-a047-2e09d6eee961"},{"checkpointId":"bc71fbe9-14a8-4f7c-808c-30ee8ba507f7","requestId":"request_17894d0d-ffcb-4150-b745-802dfd682b53","epoch":6,"label":"Request request_17894d0d-ffcb-4150-b745-802dfd682b53"},{"checkpointId":"75db34bd-2a68-420f-bc7e-fc8e53876ef5","requestId":"request_17894d0d-ffcb-4150-b745-802dfd682b53","undoStopId":"93ebef65-3d06-4aba-bef4-e3baa971ab85","epoch":7,"label":"Request request_17894d0d-ffcb-4150-b745-802dfd682b53 - Stop 93ebef65-3d06-4aba-bef4-e3baa971ab85"}],"currentEpoch":11,"fileBaselines":[["file:///d%3A/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.Domain/Dtos/RowDto.cs::request_8d102506-9b9a-434e-be97-a7b770212bf3",{"uri":{"$mid":1,"fsPath":"d:\\Repos\\_hv\\STT\\VoiceTranscription.Api\\src\\Hapvida.TI.VoiceTranscription.Domain\\Dtos\\RowDto.cs","_sep":1,"external":"file:///d%3A/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.Domain/Dtos/RowDto.cs","path":"/d:/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.Domain/Dtos/RowDto.cs","scheme":"file"},"requestId":"request_8d102506-9b9a-434e-be97-a7b770212bf3","content":"namespace Hapvida.TI.VoiceTranscription.Domain.Dtos\r\n{\r\n    public record RowDto(IDictionary<string, object?> Columns);\r\n}\r\n","epoch":3,"telemetryInfo":{}}],["file:///d%3A/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.UnitTests/Units/Services/v1/BigQueryCheckStatus/GetBigQueryCheckStatusServiceTests.cs::request_17894d0d-ffcb-4150-b745-802dfd682b53",{"uri":{"$mid":1,"fsPath":"d:\\Repos\\_hv\\STT\\VoiceTranscription.Api\\src\\Hapvida.TI.VoiceTranscription.UnitTests\\Units\\Services\\v1\\BigQueryCheckStatus\\GetBigQueryCheckStatusServiceTests.cs","_sep":1,"external":"file:///d%3A/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.UnitTests/Units/Services/v1/BigQueryCheckStatus/GetBigQueryCheckStatusServiceTests.cs","path":"/d:/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.UnitTests/Units/Services/v1/BigQueryCheckStatus/GetBigQueryCheckStatusServiceTests.cs","scheme":"file"},"requestId":"request_17894d0d-ffcb-4150-b745-802dfd682b53","content":"using System.Globalization;\r\nusing Google.Cloud.BigQuery.V2;\r\nusing Hapvida.TI.VoiceTranscription.Domain.Contracts.v1.Wrappers;\r\nusing Hapvida.TI.VoiceTranscription.Domain.Dtos;\r\nusing Hapvida.TI.VoiceTranscription.Domain.Enums;\r\nusing Hapvida.TI.VoiceTranscription.Domain.Models.v1;\r\nusing Hapvida.TI.VoiceTranscription.Domain.Services.v1;\r\nusing Microsoft.Extensions.Logging;\r\nusing Microsoft.Extensions.Options;\r\nusing NSubstitute;\r\nusing NSubstitute.ExceptionExtensions;\r\nusing Xunit;\r\n\r\n\r\nnamespace Hapvida.TI.VoiceTranscription.UnitTests.Units.Services.v1.BigQueryCheckStatus\r\n{\r\n    public class GetBigQueryCheckStatusServiceTests\r\n    {\r\n        private static IOptions<GoogleCloudStorageSettings> OkOptions() =>\r\n            Options.Create(new GoogleCloudStorageSettings\r\n            {\r\n                ProjectId = \"Projeto-1\",\r\n                GoogleBigQuery = new GoogleBigQueryOptionsSettings\r\n                {\r\n                    DataSet = \"dataset-1\",\r\n                    Table = \"table-1\"\r\n                }\r\n            });\r\n\r\n        private static ILogger<BigQueryCheckStatusService> NullLogger() =>\r\n            Substitute.For<ILogger<BigQueryCheckStatusService>>();\r\n\r\n        private static IBigQueryClientWrapper FakeClient() =>\r\n            Substitute.For<IBigQueryClientWrapper>();\r\n\r\n        // ------------------------------\r\n        // CONSTRUCTOR VALIDATION\r\n        // ------------------------------\r\n\r\n        [Fact(DisplayName = \"Ctor: configurações válidas criam instância\")]\r\n        public void BigQuery_Valid_ShouldCreateInstance()\r\n        {\r\n            var service = new BigQueryCheckStatusService(OkOptions(), NullLogger(), FakeClient());\r\n            Assert.NotNull(service);\r\n        }\r\n\r\n        [Theory(DisplayName = \"Ctor: faltando config obrigatória deve lançar InvalidOperationException\")]\r\n        [InlineData(\"\", \"dataset-1\", \"table-1\")]           // ProjectId\r\n        [InlineData(\"Projeto-1\", \"\", \"table-1\")]           // DataSet\r\n        [InlineData(\"Projeto-1\", \"dataset-1\", \"\")]         // Table\r\n        public void Ctor_MissingConfig_ShouldThrow(string projectId, string dataset, string table)\r\n        {\r\n            var options = Options.Create(new GoogleCloudStorageSettings\r\n            {\r\n                ProjectId = projectId,\r\n                GoogleBigQuery = new GoogleBigQueryOptionsSettings\r\n                {\r\n                    DataSet = dataset,\r\n                    Table = table\r\n                }\r\n            });\r\n\r\n            Assert.Throws<InvalidOperationException>(() =>\r\n                new BigQueryCheckStatusService(options, NullLogger(), FakeClient()));\r\n        }\r\n\r\n        // ------------------------------\r\n        // GetLatestByWorkIdAsync BEHAVIOR\r\n        // ------------------------------\r\n\r\n        [Fact(DisplayName = \"WorkId em branco → retorna null e não consulta cliente\")]\r\n        public async Task GetLatestByWorkIdAsync_EmptyWorkId_ShouldReturnNull()\r\n        {\r\n            var client = FakeClient();\r\n            var service = new BigQueryCheckStatusService(OkOptions(), NullLogger(), client);\r\n\r\n            var result = await service.GetLatestByWorkIdAsync(\"   \", CancellationToken.None);\r\n\r\n            Assert.Null(result);\r\n            await client.DidNotReceiveWithAnyArgs().ExecuteQueryAsync(default!, default!, default, default);\r\n        }\r\n\r\n        [Fact(DisplayName = \"CancellationToken cancelado → lança OperationCanceledException\")]\r\n        public async Task GetLatestByWorkIdAsync_Cancelled_ShouldThrow()\r\n        {\r\n            var client = FakeClient();\r\n            var service = new BigQueryCheckStatusService(OkOptions(), NullLogger(), client);\r\n\r\n            using var cts = new CancellationTokenSource();\r\n            cts.Cancel();\r\n\r\n            await Assert.ThrowsAsync<OperationCanceledException>(() =>\r\n                service.GetLatestByWorkIdAsync(\"123\", cts.Token));\r\n        }\r\n\r\n        [Fact(DisplayName = \"Sem resultados → retorna null\")]\r\n        public async Task GetLatestByWorkIdAsync_WithoutResults_ShallReturnNull()\r\n        {\r\n            var client = FakeClient();\r\n            client.ExecuteQueryAsync(Arg.Any<string>(), Arg.Any<BigQueryParameter[]>(), null, Arg.Any<CancellationToken>())\r\n                  .Returns(new List<RowDto>());\r\n\r\n            var service = new BigQueryCheckStatusService(OkOptions(), NullLogger(), client);\r\n\r\n            var result = await service.GetLatestByWorkIdAsync(\"123\", CancellationToken.None);\r\n\r\n            Assert.Null(result);\r\n        }\r\n\r\n        [Fact(DisplayName = \"Com dados → mapeia DTO corretamente (listas, enum, data)\")]\r\n        public void GetLatestByWorkIdAsync_WithData_ShallReturnDto()\r\n        {\r\n            var client = FakeClient();\r\n\r\n            var logger = Substitute.For<ILogger<BigQueryCheckStatusService>>();\r\n\r\n\r\n            var row = new RowDto()\r\n            {\r\n                WorkId = \"123\",\r\n                Symptoms = new List<string>() { \"algum\" },\r\n                Transcription = \"alguma\",\r\n                WorkStatus = WorkStatus.Completed,\r\n                CreatedAt = DateTime.UtcNow.ToString(\"o\"),\r\n                ReadyFields = new List<string>(),\r\n                SuggestedCIDs = new List<SuggestedCid>(),\r\n                EncounterId = \"abc\"\r\n            };\r\n        }\r\n\r\n        [Fact(DisplayName = \"CreatedAt como string → converte para ISO-8601 UTC\")]\r\n        public async Task GetLatestByWorkIdAsync_CreatedAtString_ShouldNormalize()\r\n        {\r\n            var client = FakeClient();\r\n\r\n            var createdLocal = DateTime.Now.ToString(\"O\", CultureInfo.InvariantCulture);\r\n\r\n            var row = new RowDto()\r\n            {\r\n                WorkId = \"w1\",\r\n                CreatedAt = createdLocal\r\n            };\r\n\r\n            client.ExecuteQueryAsync(Arg.Any<string>(), Arg.Any<BigQueryParameter[]>(), null, Arg.Any<CancellationToken>())\r\n                  .Returns(new List<RowDto> { row });\r\n\r\n            var service = new BigQueryCheckStatusService(OkOptions(), NullLogger(), client);\r\n\r\n            var dto = await service.GetLatestByWorkIdAsync(\"w1\", CancellationToken.None);\r\n\r\n            Assert.NotNull(dto);\r\n            // só garante que veio em formato \"o\" não-vazio\r\n            Assert.True(DateTime.TryParse(dto!.CreatedAt, out _));\r\n        }\r\n\r\n        [Fact(DisplayName = \"Exceção do client → deve propagar (não retornar null)\")]\r\n        public async Task GetLatestByWorkIdAsync_ClientThrows_ShouldPropagate()\r\n        {\r\n            var client = FakeClient();\r\n            client.ExecuteQueryAsync(Arg.Any<string>(), Arg.Any<BigQueryParameter[]>(), null, Arg.Any<CancellationToken>())\r\n                  .Throws(new Exception(\"erro bigquery\"));\r\n\r\n            var service = new BigQueryCheckStatusService(OkOptions(), NullLogger(), client);\r\n\r\n            await Assert.ThrowsAsync<Exception>(() =>\r\n                service.GetLatestByWorkIdAsync(\"123\", CancellationToken.None));\r\n        }\r\n    }\r\n}\r\n","epoch":8,"telemetryInfo":{}}]],"operations":[{"type":"textEdit","uri":{"$mid":1,"fsPath":"d:\\Repos\\_hv\\STT\\VoiceTranscription.Api\\src\\Hapvida.TI.VoiceTranscription.Domain\\Dtos\\RowDto.cs","_sep":1,"external":"file:///d%3A/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.Domain/Dtos/RowDto.cs","path":"/d:/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.Domain/Dtos/RowDto.cs","scheme":"file"},"requestId":"request_8d102506-9b9a-434e-be97-a7b770212bf3","epoch":4,"edits":[{"text":"using System.Collections.Generic;\r\n\r\n","range":{"startLineNumber":1,"startColumn":1,"endLineNumber":1,"endColumn":1}}]},{"type":"textEdit","uri":{"$mid":1,"fsPath":"d:\\Repos\\_hv\\STT\\VoiceTranscription.Api\\src\\Hapvida.TI.VoiceTranscription.UnitTests\\Units\\Services\\v1\\BigQueryCheckStatus\\GetBigQueryCheckStatusServiceTests.cs","_sep":1,"external":"file:///d%3A/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.UnitTests/Units/Services/v1/BigQueryCheckStatus/GetBigQueryCheckStatusServiceTests.cs","path":"/d:/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.UnitTests/Units/Services/v1/BigQueryCheckStatus/GetBigQueryCheckStatusServiceTests.cs","scheme":"file"},"requestId":"request_17894d0d-ffcb-4150-b745-802dfd682b53","epoch":9,"edits":[{"text":"new Dictionary<string, object?>\r\n            {\r\n                [\"WorkId\"] = \"w1\",\r\n                [\"CreatedAt\"] = createdLocal\r\n            })","range":{"startLineNumber":138,"startColumn":34,"endLineNumber":142,"endColumn":14}}]},{"type":"textEdit","uri":{"$mid":1,"fsPath":"d:\\Repos\\_hv\\STT\\VoiceTranscription.Api\\src\\Hapvida.TI.VoiceTranscription.UnitTests\\Units\\Services\\v1\\BigQueryCheckStatus\\GetBigQueryCheckStatusServiceTests.cs","_sep":1,"external":"file:///d%3A/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.UnitTests/Units/Services/v1/BigQueryCheckStatus/GetBigQueryCheckStatusServiceTests.cs","path":"/d:/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.UnitTests/Units/Services/v1/BigQueryCheckStatus/GetBigQueryCheckStatusServiceTests.cs","scheme":"file"},"requestId":"request_17894d0d-ffcb-4150-b745-802dfd682b53","epoch":10,"edits":[{"text":"new Dictionary<string, object?>\r\n            {\r\n                [\"WorkId\"] = \"123\",\r\n                [\"Symptoms\"] = new List<object> { \"algum\" },\r\n                [\"Transcription\"] = \"alguma\",\r\n                [\"WorkStatus\"] = \"Completed\",\r\n                [\"CreatedAt\"] = DateTime.UtcNow,\r\n                [\"ReadyFields\"] = new List<object>(),\r\n                [\"SuggestedCIDs\"] = new List<object>(),\r\n                [\"EncounterId\"] = \"abc\"\r\n            })","range":{"startLineNumber":118,"startColumn":34,"endLineNumber":128,"endColumn":14}}]}],"epochCounter":11},"recentSnapshot":{"entries":[{"resource":"file:///d%3A/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.Domain/Dtos/RowDto.cs","languageId":"csharp","originalHash":"70dccca","currentHash":"70dccca","state":1,"snapshotUri":"chat-editing-snapshot-text-model:/d%3A/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.Domain/Dtos/RowDto.cs?%7B%22session%22%3A%7B%22%24mid%22%3A1%2C%22external%22%3A%22vscode-chat-session%3A%2F%2Flocal%2FZTYxYjIxMzktMjAyMi00YmYzLWI4YWQtODUwNjZlZGQwMWRi%22%2C%22path%22%3A%22%2FZTYxYjIxMzktMjAyMi00YmYzLWI4YWQtODUwNjZlZGQwMWRi%22%2C%22scheme%22%3A%22vscode-chat-session%22%2C%22authority%22%3A%22local%22%7D%2C%22requestId%22%3A%22%22%2C%22undoStop%22%3A%22%22%7D","telemetryInfo":{"requestId":"request_8d102506-9b9a-434e-be97-a7b770212bf3","agentId":"github.copilot.editsAgent","modelId":"copilot/claude-opus-4.6","modeId":"agent"}},{"resource":"file:///d%3A/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.UnitTests/Units/Services/v1/BigQueryCheckStatus/GetBigQueryCheckStatusServiceTests.cs","languageId":"csharp","originalHash":"f6d1d1d","currentHash":"f6d1d1d","state":1,"snapshotUri":"chat-editing-snapshot-text-model:/d%3A/Repos/_hv/STT/VoiceTranscription.Api/src/Hapvida.TI.VoiceTranscription.UnitTests/Units/Services/v1/BigQueryCheckStatus/GetBigQueryCheckStatusServiceTests.cs?%7B%22session%22%3A%7B%22%24mid%22%3A1%2C%22external%22%3A%22vscode-chat-session%3A%2F%2Flocal%2FZTYxYjIxMzktMjAyMi00YmYzLWI4YWQtODUwNjZlZGQwMWRi%22%2C%22path%22%3A%22%2FZTYxYjIxMzktMjAyMi00YmYzLWI4YWQtODUwNjZlZGQwMWRi%22%2C%22scheme%22%3A%22vscode-chat-session%22%2C%22authority%22%3A%22local%22%7D%2C%22requestId%22%3A%22%22%2C%22undoStop%22%3A%22%22%7D","telemetryInfo":{"requestId":"request_17894d0d-ffcb-4150-b745-802dfd682b53","agentId":"github.copilot.editsAgent","modelId":"copilot/claude-opus-4.6","modeId":"agent"}}]}}